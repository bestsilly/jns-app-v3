diff --git a/dist/index.es.js b/dist/index.es.js
index 50d491fc1f3157e5716c560a6ddfa25e6990ad82..1aade6563ac27d0d7914b3145debfac6074ebaaf 100644
--- a/dist/index.es.js
+++ b/dist/index.es.js
@@ -1,2 +1,2 @@
-import Kt,{EventEmitter as z}from"events";import kt from"@walletconnect/keyvaluestorage";import{HEARTBEAT_EVENTS as X,HeartBeat as Bt}from"@walletconnect/heartbeat";import{generateChildLogger as f,getLoggerContext as E,pino as ge,getDefaultLoggerOptions as pe}from"@walletconnect/logger";import{IMessageTracker as jt,IPublisher as Vt,ISubscriber as qt,IRelayer as Gt,IStore as Yt,IJsonRpcHistory as Jt,IExpirer as Ht,IVerify as Xt,ICore as Wt}from"@walletconnect/types";import{safeJsonStringify as Zt,safeJsonParse as Qt}from"@walletconnect/safe-json";import*as k from"@walletconnect/relay-auth";import{getInternalError as c,mapToObj as De,objToMap as ye,generateKeyPair as ei,generateRandomBytes32 as W,deriveSymKey as ti,hashKey as ii,validateEncoding as si,isTypeOneEnvelope as be,encrypt as ri,validateDecoding as ni,decrypt as ai,deserialize as me,decodeTypeByte as oi,BASE16 as hi,hashMessage as Z,getRelayProtocolName as Q,createExpiringPromise as B,getRelayProtocolApi as j,isUndefined as ee,getSdkError as F,isValidArray as ci,formatRelayRpcUrl as ui,isProposalStruct as li,isSessionStruct as di,TYPE_1 as gi,calcExpiry as te,formatUri as pi,parseUri as Di,createDelayedPromise as yi,engineEvent as ie,isExpired as fe,isValidParams as se,isValidUrl as bi,isValidString as mi,parseExpirerTarget as fi,formatTopicTarget as Ei,formatIdTarget as wi,isReactNative as vi,isBrowser as Ii,isNode as Ci}from"@walletconnect/utils";import{toString as _i}from"uint8arrays";import{ONE_DAY as N,SIX_HOURS as Ri,ONE_SECOND as Ee,THIRTY_DAYS as re,FIVE_SECONDS as we,THIRTY_SECONDS as ve,Watch as Si,toMiliseconds as V,FIVE_MINUTES as Ie}from"@walletconnect/time";import{JsonRpcProvider as Ti}from"@walletconnect/jsonrpc-provider";import{getBigIntRpcId as Pi,isJsonRpcRequest as Ce,isJsonRpcResponse as _e,formatJsonRpcResult as Re,formatJsonRpcRequest as Se,formatJsonRpcError as xi,isJsonRpcResult as Oi,isJsonRpcError as Te}from"@walletconnect/jsonrpc-utils";import Ai from"@walletconnect/jsonrpc-ws-connection";import zi from"lodash.isequal";function Ni(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),i=0;i<t.length;i++)t[i]=255;for(var s=0;s<r.length;s++){var n=r.charAt(s),a=n.charCodeAt(0);if(t[a]!==255)throw new TypeError(n+" is ambiguous");t[a]=s}var o=r.length,h=r.charAt(0),d=Math.log(o)/Math.log(256),l=Math.log(256)/Math.log(o);function D(u){if(u instanceof Uint8Array||(ArrayBuffer.isView(u)?u=new Uint8Array(u.buffer,u.byteOffset,u.byteLength):Array.isArray(u)&&(u=Uint8Array.from(u))),!(u instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(u.length===0)return"";for(var y=0,A=0,v=0,R=u.length;v!==R&&u[v]===0;)v++,y++;for(var S=(R-v)*l+1>>>0,m=new Uint8Array(S);v!==R;){for(var T=u[v],O=0,I=S-1;(T!==0||O<A)&&I!==-1;I--,O++)T+=256*m[I]>>>0,m[I]=T%o>>>0,T=T/o>>>0;if(T!==0)throw new Error("Non-zero carry");A=O,v++}for(var P=S-A;P!==S&&m[P]===0;)P++;for(var K=h.repeat(y);P<S;++P)K+=r.charAt(m[P]);return K}function b(u){if(typeof u!="string")throw new TypeError("Expected String");if(u.length===0)return new Uint8Array;var y=0;if(u[y]!==" "){for(var A=0,v=0;u[y]===h;)A++,y++;for(var R=(u.length-y)*d+1>>>0,S=new Uint8Array(R);u[y];){var m=t[u.charCodeAt(y)];if(m===255)return;for(var T=0,O=R-1;(m!==0||T<v)&&O!==-1;O--,T++)m+=o*S[O]>>>0,S[O]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");v=T,y++}if(u[y]!==" "){for(var I=R-v;I!==R&&S[I]===0;)I++;for(var P=new Uint8Array(A+(R-I)),K=A;I!==R;)P[K++]=S[I++];return P}}}function H(u){var y=b(u);if(y)return y;throw new Error(`Non-${e} character`)}return{encode:D,decodeUnsafe:b,decode:H}}var Ui=Ni,Li=Ui;const Pe=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Fi=r=>new TextEncoder().encode(r),$i=r=>new TextDecoder().decode(r);class Mi{constructor(e,t,i){this.name=e,this.prefix=t,this.baseEncode=i}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Ki{constructor(e,t,i){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=i}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return xe(this,e)}}class ki{constructor(e){this.decoders=e}or(e){return xe(this,e)}decode(e){const t=e[0],i=this.decoders[t];if(i)return i.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const xe=(r,e)=>new ki({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});class Bi{constructor(e,t,i,s){this.name=e,this.prefix=t,this.baseEncode=i,this.baseDecode=s,this.encoder=new Mi(e,t,i),this.decoder=new Ki(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const q=({name:r,prefix:e,encode:t,decode:i})=>new Bi(r,e,t,i),$=({prefix:r,name:e,alphabet:t})=>{const{encode:i,decode:s}=Li(t,e);return q({prefix:r,name:e,encode:i,decode:n=>Pe(s(n))})},ji=(r,e,t,i)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let n=r.length;for(;r[n-1]==="=";)--n;const a=new Uint8Array(n*t/8|0);let o=0,h=0,d=0;for(let l=0;l<n;++l){const D=s[r[l]];if(D===void 0)throw new SyntaxError(`Non-${i} character`);h=h<<t|D,o+=t,o>=8&&(o-=8,a[d++]=255&h>>o)}if(o>=t||255&h<<8-o)throw new SyntaxError("Unexpected end of data");return a},Vi=(r,e,t)=>{const i=e[e.length-1]==="=",s=(1<<t)-1;let n="",a=0,o=0;for(let h=0;h<r.length;++h)for(o=o<<8|r[h],a+=8;a>t;)a-=t,n+=e[s&o>>a];if(a&&(n+=e[s&o<<t-a]),i)for(;n.length*t&7;)n+="=";return n},p=({name:r,prefix:e,bitsPerChar:t,alphabet:i})=>q({prefix:e,name:r,encode(s){return Vi(s,i,t)},decode(s){return ji(s,i,t,r)}}),qi=q({prefix:"\0",name:"identity",encode:r=>$i(r),decode:r=>Fi(r)});var Gi=Object.freeze({__proto__:null,identity:qi});const Yi=p({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Ji=Object.freeze({__proto__:null,base2:Yi});const Hi=p({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Xi=Object.freeze({__proto__:null,base8:Hi});const Wi=$({prefix:"9",name:"base10",alphabet:"0123456789"});var Zi=Object.freeze({__proto__:null,base10:Wi});const Qi=p({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),es=p({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var ts=Object.freeze({__proto__:null,base16:Qi,base16upper:es});const is=p({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),ss=p({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),rs=p({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),ns=p({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),as=p({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),os=p({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),hs=p({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),cs=p({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),us=p({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var ls=Object.freeze({__proto__:null,base32:is,base32upper:ss,base32pad:rs,base32padupper:ns,base32hex:as,base32hexupper:os,base32hexpad:hs,base32hexpadupper:cs,base32z:us});const ds=$({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),gs=$({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var ps=Object.freeze({__proto__:null,base36:ds,base36upper:gs});const Ds=$({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),ys=$({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var bs=Object.freeze({__proto__:null,base58btc:Ds,base58flickr:ys});const ms=p({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),fs=p({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Es=p({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),ws=p({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var vs=Object.freeze({__proto__:null,base64:ms,base64pad:fs,base64url:Es,base64urlpad:ws});const Oe=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Is=Oe.reduce((r,e,t)=>(r[t]=e,r),[]),Cs=Oe.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function _s(r){return r.reduce((e,t)=>(e+=Is[t],e),"")}function Rs(r){const e=[];for(const t of r){const i=Cs[t.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const Ss=q({prefix:"\u{1F680}",name:"base256emoji",encode:_s,decode:Rs});var Ts=Object.freeze({__proto__:null,base256emoji:Ss}),Ps=ze,Ae=128,xs=127,Os=~xs,As=Math.pow(2,31);function ze(r,e,t){e=e||[],t=t||0;for(var i=t;r>=As;)e[t++]=r&255|Ae,r/=128;for(;r&Os;)e[t++]=r&255|Ae,r>>>=7;return e[t]=r|0,ze.bytes=t-i+1,e}var zs=ne,Ns=128,Ne=127;function ne(r,i){var t=0,i=i||0,s=0,n=i,a,o=r.length;do{if(n>=o)throw ne.bytes=0,new RangeError("Could not decode varint");a=r[n++],t+=s<28?(a&Ne)<<s:(a&Ne)*Math.pow(2,s),s+=7}while(a>=Ns);return ne.bytes=n-i,t}var Us=Math.pow(2,7),Ls=Math.pow(2,14),Fs=Math.pow(2,21),$s=Math.pow(2,28),Ms=Math.pow(2,35),Ks=Math.pow(2,42),ks=Math.pow(2,49),Bs=Math.pow(2,56),js=Math.pow(2,63),Vs=function(r){return r<Us?1:r<Ls?2:r<Fs?3:r<$s?4:r<Ms?5:r<Ks?6:r<ks?7:r<Bs?8:r<js?9:10},qs={encode:Ps,decode:zs,encodingLength:Vs},Ue=qs;const Le=(r,e,t=0)=>(Ue.encode(r,e,t),e),Fe=r=>Ue.encodingLength(r),ae=(r,e)=>{const t=e.byteLength,i=Fe(r),s=i+Fe(t),n=new Uint8Array(s+t);return Le(r,n,0),Le(t,n,i),n.set(e,s),new Gs(r,t,e,n)};class Gs{constructor(e,t,i,s){this.code=e,this.size=t,this.digest=i,this.bytes=s}}const $e=({name:r,code:e,encode:t})=>new Ys(r,e,t);class Ys{constructor(e,t,i){this.name=e,this.code=t,this.encode=i}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?ae(this.code,t):t.then(i=>ae(this.code,i))}else throw Error("Unknown type, must be binary type")}}const Me=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Js=$e({name:"sha2-256",code:18,encode:Me("SHA-256")}),Hs=$e({name:"sha2-512",code:19,encode:Me("SHA-512")});var Xs=Object.freeze({__proto__:null,sha256:Js,sha512:Hs});const Ke=0,Ws="identity",ke=Pe,Zs=r=>ae(Ke,ke(r)),Qs={code:Ke,name:Ws,encode:ke,digest:Zs};var er=Object.freeze({__proto__:null,identity:Qs});new TextEncoder,new TextDecoder;const Be={...Gi,...Ji,...Xi,...Zi,...ts,...ls,...ps,...bs,...vs,...Ts};({...Xs,...er});function je(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function tr(r=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?je(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function Ve(r,e,t,i){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:i}}}const qe=Ve("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),oe=Ve("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=tr(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),ir={utf8:qe,"utf-8":qe,hex:Be.base16,latin1:oe,ascii:oe,binary:oe,...Be};function sr(r,e="utf8"){const t=ir[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?je(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}const he="wc",Ge=2,G="core",x=`${he}@${2}:${G}:`,Ye={name:G,logger:"error"},Je={database:":memory:"},He="crypto",ce="client_ed25519_seed",Xe=N,We="keychain",Ze="0.3",Qe="messages",et="0.3",tt=Ri,it="publisher",st="irn",rt="error",ue="wss://relay.walletconnect.com",nt="relayer",g={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},at="_subscription",U={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},ot=Ee/2,rr={database:":memory:"},ht="2.7.8",ct=1e4,ut="0.3",C={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"},nr=re,lt="subscription",dt="0.3",gt=we*1e3,pt="pairing",Dt="0.3",ar=re,L={wc_pairingDelete:{req:{ttl:N,prompt:!1,tag:1e3},res:{ttl:N,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:ve,prompt:!1,tag:1002},res:{ttl:ve,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:N,prompt:!1,tag:0},res:{ttl:N,prompt:!1,tag:0}}},_={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},yt="history",bt="0.3",mt="expirer",w={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},ft="0.3",or=N,Y="verify-api",le="https://verify.walletconnect.com";class Et{constructor(e,t){this.core=e,this.logger=t,this.keychain=new Map,this.name=We,this.version=Ze,this.initialized=!1,this.storagePrefix=x,this.init=async()=>{if(!this.initialized){const i=await this.getKeyChain();typeof i<"u"&&(this.keychain=i),this.initialized=!0}},this.has=i=>(this.isInitialized(),this.keychain.has(i)),this.set=async(i,s)=>{this.isInitialized(),this.keychain.set(i,s),await this.persist()},this.get=i=>{this.isInitialized();const s=this.keychain.get(i);if(typeof s>"u"){const{message:n}=c("NO_MATCHING_KEY",`${this.name}: ${i}`);throw new Error(n)}return s},this.del=async i=>{this.isInitialized(),this.keychain.delete(i),await this.persist()},this.core=e,this.logger=f(t,this.name)}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,De(e))}async getKeyChain(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?ye(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class wt{constructor(e,t,i){this.core=e,this.logger=t,this.name=He,this.initialized=!1,this.init=async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)},this.hasKeys=s=>(this.isInitialized(),this.keychain.has(s)),this.getClientId=async()=>{this.isInitialized();const s=await this.getClientSeed(),n=k.generateKeyPair(s);return k.encodeIss(n.publicKey)},this.generateKeyPair=()=>{this.isInitialized();const s=ei();return this.setPrivateKey(s.publicKey,s.privateKey)},this.signJWT=async s=>{this.isInitialized();const n=await this.getClientSeed(),a=k.generateKeyPair(n),o=W(),h=Xe;return await k.signJWT(o,s,h,a)},this.generateSharedKey=(s,n,a)=>{this.isInitialized();const o=this.getPrivateKey(s),h=ti(o,n);return this.setSymKey(h,a)},this.setSymKey=async(s,n)=>{this.isInitialized();const a=n||ii(s);return await this.keychain.set(a,s),a},this.deleteKeyPair=async s=>{this.isInitialized(),await this.keychain.del(s)},this.deleteSymKey=async s=>{this.isInitialized(),await this.keychain.del(s)},this.encode=async(s,n,a)=>{this.isInitialized();const o=si(a),h=Zt(n);if(be(o)){const b=o.senderPublicKey,H=o.receiverPublicKey;s=await this.generateSharedKey(b,H)}const d=this.getSymKey(s),{type:l,senderPublicKey:D}=o;return ri({type:l,symKey:d,message:h,senderPublicKey:D})},this.decode=async(s,n,a)=>{this.isInitialized();const o=ni(n,a);if(be(o)){const l=o.receiverPublicKey,D=o.senderPublicKey;s=await this.generateSharedKey(l,D)}const h=this.getSymKey(s),d=ai({symKey:h,encoded:n});return Qt(d)},this.getPayloadType=s=>{const n=me(s);return oi(n.type)},this.getPayloadSenderPublicKey=s=>{const n=me(s);return n.senderPublicKey?_i(n.senderPublicKey,hi):void 0},this.core=e,this.logger=f(t,this.name),this.keychain=i||new Et(this.core,this.logger)}get context(){return E(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(ce)}catch{e=W(),await this.keychain.set(ce,e)}return sr(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class vt extends jt{constructor(e,t){super(e,t),this.logger=e,this.core=t,this.messages=new Map,this.name=Qe,this.version=et,this.initialized=!1,this.storagePrefix=x,this.init=async()=>{if(!this.initialized){this.logger.trace("Initialized");try{const i=await this.getRelayerMessages();typeof i<"u"&&(this.messages=i),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(i){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(i)}finally{this.initialized=!0}}},this.set=async(i,s)=>{this.isInitialized();const n=Z(s);let a=this.messages.get(i);return typeof a>"u"&&(a={}),typeof a[n]<"u"||(a[n]=s,this.messages.set(i,a),await this.persist()),n},this.get=i=>{this.isInitialized();let s=this.messages.get(i);return typeof s>"u"&&(s={}),s},this.has=(i,s)=>{this.isInitialized();const n=this.get(i),a=Z(s);return typeof n[a]<"u"},this.del=async i=>{this.isInitialized(),this.messages.delete(i),await this.persist()},this.logger=f(e,this.name),this.core=t}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,De(e))}async getRelayerMessages(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?ye(e):void 0}async persist(){await this.setRelayerMessages(this.messages)}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class hr extends Vt{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.events=new z,this.name=it,this.queue=new Map,this.publishTimeout=1e4,this.publish=async(i,s,n)=>{this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:i,message:s,opts:n}});try{const a=n?.ttl||tt,o=Q(n),h=n?.prompt||!1,d=n?.tag||0,l=n?.id||Pi().toString(),D={topic:i,message:s,opts:{ttl:a,relay:o,prompt:h,tag:d,id:l}};this.queue.set(l,D);try{await await B(this.rpcPublish(i,s,a,o,h,d,l),this.publishTimeout),this.relayer.events.emit(g.publish,D)}catch{this.logger.debug("Publishing Payload stalled"),this.relayer.events.emit(g.connection_stalled);return}this.logger.debug("Successfully Published Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:i,message:s,opts:n}})}catch(a){throw this.logger.debug("Failed to Publish Payload"),this.logger.error(a),a}},this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.relayer=e,this.logger=f(t,this.name),this.registerEventListeners()}get context(){return E(this.logger)}rpcPublish(e,t,i,s,n,a,o){var h,d,l,D;const b={method:j(s.protocol).publish,params:{topic:e,message:t,ttl:i,prompt:n,tag:a},id:o};return ee((h=b.params)==null?void 0:h.prompt)&&((d=b.params)==null||delete d.prompt),ee((l=b.params)==null?void 0:l.tag)&&((D=b.params)==null||delete D.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:b}),this.relayer.request(b)}onPublish(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async e=>{const{topic:t,message:i,opts:s}=e;await this.publish(t,i,s)})}registerEventListeners(){this.relayer.core.heartbeat.on(X.pulse,()=>{this.checkQueue()}),this.relayer.on(g.message_ack,e=>{this.onPublish(e.id.toString())})}}class cr{constructor(){this.map=new Map,this.set=(e,t)=>{const i=this.get(e);this.exists(e,t)||this.map.set(e,[...i,t])},this.get=e=>this.map.get(e)||[],this.exists=(e,t)=>this.get(e).includes(t),this.delete=(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;const i=this.get(e);if(!this.exists(e,t))return;const s=i.filter(n=>n!==t);if(!s.length){this.map.delete(e);return}this.map.set(e,s)},this.clear=()=>{this.map.clear()}}get topics(){return Array.from(this.map.keys())}}var ur=Object.defineProperty,lr=Object.defineProperties,dr=Object.getOwnPropertyDescriptors,It=Object.getOwnPropertySymbols,gr=Object.prototype.hasOwnProperty,pr=Object.prototype.propertyIsEnumerable,Ct=(r,e,t)=>e in r?ur(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,M=(r,e)=>{for(var t in e||(e={}))gr.call(e,t)&&Ct(r,t,e[t]);if(It)for(var t of It(e))pr.call(e,t)&&Ct(r,t,e[t]);return r},de=(r,e)=>lr(r,dr(e));class _t extends qt{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.subscriptions=new Map,this.topicMap=new cr,this.events=new z,this.name=lt,this.version=dt,this.pending=new Map,this.cached=[],this.initialized=!1,this.pendingSubscriptionWatchLabel="pending_sub_watch_label",this.pollingInterval=20,this.storagePrefix=x,this.subscribeTimeout=1e4,this.restartInProgress=!1,this.batchSubscribeTopicsLimit=500,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restart(),this.registerEventListeners(),this.onEnable(),this.clientId=await this.relayer.core.crypto.getClientId())},this.subscribe=async(i,s)=>{await this.restartToComplete(),this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:s}});try{const n=Q(s),a={topic:i,relay:n};this.pending.set(i,a);const o=await this.rpcSubscribe(i,n);return this.onSubscribe(o,a),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:s}}),o}catch(n){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(n),n}},this.unsubscribe=async(i,s)=>{await this.restartToComplete(),this.isInitialized(),typeof s?.id<"u"?await this.unsubscribeById(i,s.id,s):await this.unsubscribeByTopic(i,s)},this.isSubscribed=async i=>this.topics.includes(i)?!0:await new Promise((s,n)=>{const a=new Si;a.start(this.pendingSubscriptionWatchLabel);const o=setInterval(()=>{!this.pending.has(i)&&this.topics.includes(i)&&(clearInterval(o),a.stop(this.pendingSubscriptionWatchLabel),s(!0)),a.elapsed(this.pendingSubscriptionWatchLabel)>=gt&&(clearInterval(o),a.stop(this.pendingSubscriptionWatchLabel),n(new Error("Subscription resolution timeout")))},this.pollingInterval)}).catch(()=>!1),this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.restart=async()=>{this.restartInProgress=!0,await this.restore(),await this.reset(),this.restartInProgress=!1},this.relayer=e,this.logger=f(t,this.name),this.clientId=""}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}hasSubscription(e,t){let i=!1;try{i=this.getSubscription(e).topic===t}catch{}return i}onEnable(){this.cached=[],this.initialized=!0}onDisable(){this.cached=this.values,this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){const i=this.topicMap.get(e);await Promise.all(i.map(async s=>await this.unsubscribeById(e,s,t)))}async unsubscribeById(e,t,i){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}});try{const s=Q(i);await this.rpcUnsubscribe(e,t,s);const n=F("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}})}catch(s){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(s),s}}async rpcSubscribe(e,t){const i={method:j(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});try{await await B(this.relayer.request(i),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(g.connection_stalled)}return Z(e+this.clientId)}async rpcBatchSubscribe(e){if(!e.length)return;const t=e[0].relay,i={method:j(t.protocol).batchSubscribe,params:{topics:e.map(s=>s.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});try{return await await B(this.relayer.request(i),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Payload stalled"),this.relayer.events.emit(g.connection_stalled)}}rpcUnsubscribe(e,t,i){const s={method:j(i.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s}),this.relayer.request(s)}onSubscribe(e,t){this.setSubscription(e,de(M({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,M({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,i){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,i),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.subscriptions.has(e)||(this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t))}addSubscription(e,t){this.subscriptions.set(e,M({},t)),this.topicMap.set(t.topic,e),this.events.emit(C.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});const t=this.subscriptions.get(e);if(!t){const{message:i}=c("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});const i=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(i.topic,e),this.events.emit(C.deleted,de(M({},i),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(C.sync)}async reset(){if(this.cached.length){const e=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let t=0;t<e;t++){const i=this.cached.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(i)}}this.events.emit(C.resubscribed)}async restore(){try{const e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){const{message:t}=c("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){if(!e.length)return;const t=await this.rpcBatchSubscribe(e);ci(t)&&this.onBatchSubscribe(t.map((i,s)=>de(M({},e[s]),{id:i})))}async onConnect(){this.restartInProgress||(await this.restart(),this.onEnable())}onDisconnect(){this.onDisable()}async checkPending(){if(this.relayer.transportExplicitlyClosed)return;const e=[];this.pending.forEach(t=>{e.push(t)}),await this.batchSubscribe(e)}registerEventListeners(){this.relayer.core.heartbeat.on(X.pulse,async()=>{await this.checkPending()}),this.relayer.on(g.connect,async()=>{await this.onConnect()}),this.relayer.on(g.disconnect,()=>{this.onDisconnect()}),this.events.on(C.created,async e=>{const t=C.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()}),this.events.on(C.deleted,async e=>{const t=C.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(){this.restartInProgress&&await new Promise(e=>{const t=setInterval(()=>{this.restartInProgress||(clearInterval(t),e())},this.pollingInterval)})}}var Dr=Object.defineProperty,Rt=Object.getOwnPropertySymbols,yr=Object.prototype.hasOwnProperty,br=Object.prototype.propertyIsEnumerable,St=(r,e,t)=>e in r?Dr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,mr=(r,e)=>{for(var t in e||(e={}))yr.call(e,t)&&St(r,t,e[t]);if(Rt)for(var t of Rt(e))br.call(e,t)&&St(r,t,e[t]);return r};class Tt extends Gt{constructor(e){super(e),this.protocol="wc",this.version=2,this.events=new z,this.name=nt,this.transportExplicitlyClosed=!1,this.initialized=!1,this.reconnecting=!1,this.connectionStatusPollingInterval=20,this.staleConnectionErrors=["socket hang up","socket stalled"],this.request=async t=>{this.logger.debug("Publishing Request Payload");try{return await this.toEstablishConnection(),await this.provider.request(t)}catch(i){throw this.logger.debug("Failed to Publish Request"),this.logger.error(i),i}},this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?f(e.logger,this.name):ge(pe({level:e.logger||rt})),this.messages=new vt(this.logger,e.core),this.subscriber=new _t(this,this.logger),this.publisher=new hr(this,this.logger),this.relayUrl=e?.relayUrl||ue,this.projectId=e.projectId,this.provider={}}async init(){this.logger.trace("Initialized"),await this.createProvider(),await Promise.all([this.messages.init(),this.transportOpen(),this.subscriber.init()]),this.registerEventListeners(),this.initialized=!0,setTimeout(async()=>{this.subscriber.topics.length===0&&(this.logger.info("No topics subscribted to after init, closing transport"),await this.transportClose(),this.transportExplicitlyClosed=!1)},ct)}get context(){return E(this.logger)}get connected(){return this.provider.connection.connected}get connecting(){return this.provider.connection.connecting}async publish(e,t,i){this.isInitialized(),await this.publisher.publish(e,t,i),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now()})}async subscribe(e,t){var i;this.isInitialized();let s=((i=this.subscriber.topicMap.get(e))==null?void 0:i[0])||"";return s||(await Promise.all([new Promise(n=>{this.subscriber.once(C.created,a=>{a.topic===e&&n()})}),new Promise(async n=>{s=await this.subscriber.subscribe(e,t),n()})]),s)}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportClose(){this.transportExplicitlyClosed=!0,this.connected&&(await this.provider.disconnect(),this.events.emit(g.transport_closed))}async transportOpen(e){if(this.transportExplicitlyClosed=!1,!this.reconnecting){this.relayUrl=e||this.relayUrl,this.reconnecting=!0;try{await Promise.all([new Promise(t=>{this.initialized||t(),this.subscriber.once(C.resubscribed,()=>{t()})}),await Promise.race([new Promise(async(t,i)=>{await B(this.provider.connect(),5e3,"socket stalled").catch(s=>i(s)).then(()=>t()).finally(()=>this.removeListener(g.transport_closed,this.rejectTransportOpen))}),new Promise(t=>this.once(g.transport_closed,this.rejectTransportOpen))])])}catch(t){this.logger.error(t);const i=t;if(!this.isConnectionStalled(i.message))throw t;this.events.emit(g.transport_closed)}finally{this.reconnecting=!1}}}async restartTransport(e){this.transportExplicitlyClosed||this.reconnecting||(this.relayUrl=e||this.relayUrl,this.connected&&await Promise.all([new Promise(t=>{this.provider.once(U.disconnect,()=>{t()})}),this.transportClose()]),await this.createProvider(),await this.transportOpen())}isConnectionStalled(e){return this.staleConnectionErrors.some(t=>e.includes(t))}rejectTransportOpen(){throw new Error("closeTransport called before connection was established")}async createProvider(){const e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new Ti(new Ai(ui({sdkVersion:ht,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0}))),this.registerProviderListeners()}async recordMessageEvent(e){const{topic:t,message:i}=e;await this.messages.set(t,i)}async shouldIgnoreMessageEvent(e){const{topic:t,message:i}=e;return await this.subscriber.isSubscribed(t)?this.messages.has(t,i):!0}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),Ce(e)){if(!e.method.endsWith(at))return;const t=e.params,{topic:i,message:s,publishedAt:n}=t.data,a={topic:i,message:s,publishedAt:n};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(mr({type:"event",event:t.id},a)),this.events.emit(t.id,a),await this.acknowledgePayload(e),await this.onMessageEvent(a)}else _e(e)&&this.events.emit(g.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(this.events.emit(g.message,e),await this.recordMessageEvent(e))}async acknowledgePayload(e){const t=Re(e.id,!0);await this.provider.connection.send(t)}registerProviderListeners(){this.provider.on(U.payload,e=>this.onProviderPayload(e)),this.provider.on(U.connect,()=>{this.events.emit(g.connect)}),this.provider.on(U.disconnect,()=>{this.onProviderDisconnect()}),this.provider.on(U.error,e=>{this.logger.error(e),this.events.emit(g.error,e)})}registerEventListeners(){this.events.on(g.connection_stalled,async()=>{await this.restartTransport()})}onProviderDisconnect(){this.events.emit(g.disconnect),this.attemptToReconnect()}attemptToReconnect(){this.transportExplicitlyClosed||setTimeout(async()=>{await this.restartTransport()},V(ot))}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(!this.connected){if(this.connecting)return await new Promise(e=>{const t=setInterval(()=>{this.connected&&(clearInterval(t),e())},this.connectionStatusPollingInterval)});await this.restartTransport()}}}var fr=Object.defineProperty,Pt=Object.getOwnPropertySymbols,Er=Object.prototype.hasOwnProperty,wr=Object.prototype.propertyIsEnumerable,xt=(r,e,t)=>e in r?fr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Ot=(r,e)=>{for(var t in e||(e={}))Er.call(e,t)&&xt(r,t,e[t]);if(Pt)for(var t of Pt(e))wr.call(e,t)&&xt(r,t,e[t]);return r};class At extends Yt{constructor(e,t,i,s=x,n=void 0){super(e,t,i,s),this.core=e,this.logger=t,this.name=i,this.map=new Map,this.version=ut,this.cached=[],this.initialized=!1,this.storagePrefix=x,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(a=>{this.getKey&&a!==null&&!ee(a)?this.map.set(this.getKey(a),a):li(a)?this.map.set(a.id,a):di(a)&&this.map.set(a.topic,a)}),this.cached=[],this.initialized=!0)},this.set=async(a,o)=>{this.isInitialized(),this.map.has(a)?await this.update(a,o):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:a,value:o}),this.map.set(a,o),await this.persist())},this.get=a=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:a}),this.getData(a)),this.getAll=a=>(this.isInitialized(),a?this.values.filter(o=>Object.keys(a).every(h=>zi(o[h],a[h]))):this.values),this.update=async(a,o)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:a,update:o});const h=Ot(Ot({},this.getData(a)),o);this.map.set(a,h),await this.persist()},this.delete=async(a,o)=>{this.isInitialized(),this.map.has(a)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:a,reason:o}),this.map.delete(a),await this.persist())},this.logger=f(t,this.name),this.storagePrefix=s,this.getKey=n}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){const t=this.map.get(e);if(!t){const{message:i}=c("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(i),new Error(i)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{const e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){const{message:t}=c("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class zt{constructor(e,t){this.core=e,this.logger=t,this.name=pt,this.version=Dt,this.events=new Kt,this.initialized=!1,this.storagePrefix=x,this.ignoredPayloadTypes=[gi],this.registeredMethods=[],this.init=async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))},this.register=({methods:i})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...i])]},this.create=async()=>{this.isInitialized();const i=W(),s=await this.core.crypto.setSymKey(i),n=te(Ie),a={protocol:st},o={topic:s,expiry:n,relay:a,active:!1},h=pi({protocol:this.core.protocol,version:this.core.version,topic:s,symKey:i,relay:a});return await this.pairings.set(s,o),await this.core.relayer.subscribe(s),this.core.expirer.set(s,n),{topic:s,uri:h}},this.pair=async i=>{this.isInitialized(),this.isValidPair(i);const{topic:s,symKey:n,relay:a}=Di(i.uri);if(this.pairings.keys.includes(s))throw new Error(`Pairing already exists: ${s}`);if(this.core.crypto.hasKeys(s))throw new Error(`Keychain already exists: ${s}`);const o=te(Ie),h={topic:s,relay:a,expiry:o,active:!1};return await this.pairings.set(s,h),await this.core.crypto.setSymKey(n,s),await this.core.relayer.subscribe(s,{relay:a}),this.core.expirer.set(s,o),i.activatePairing&&await this.activate({topic:s}),h},this.activate=async({topic:i})=>{this.isInitialized();const s=te(re);await this.pairings.update(i,{active:!0,expiry:s}),this.core.expirer.set(i,s)},this.ping=async i=>{this.isInitialized(),await this.isValidPing(i);const{topic:s}=i;if(this.pairings.keys.includes(s)){const n=await this.sendRequest(s,"wc_pairingPing",{}),{done:a,resolve:o,reject:h}=yi();this.events.once(ie("pairing_ping",n),({error:d})=>{d?h(d):o()}),await a()}},this.updateExpiry=async({topic:i,expiry:s})=>{this.isInitialized(),await this.pairings.update(i,{expiry:s})},this.updateMetadata=async({topic:i,metadata:s})=>{this.isInitialized(),await this.pairings.update(i,{peerMetadata:s})},this.getPairings=()=>(this.isInitialized(),this.pairings.values),this.disconnect=async i=>{this.isInitialized(),await this.isValidDisconnect(i);const{topic:s}=i;this.pairings.keys.includes(s)&&(await this.sendRequest(s,"wc_pairingDelete",F("USER_DISCONNECTED")),await this.deletePairing(s))},this.sendRequest=async(i,s,n)=>{const a=Se(s,n),o=await this.core.crypto.encode(i,a),h=L[s].req;return this.core.history.set(i,a),this.core.relayer.publish(i,o,h),a.id},this.sendResult=async(i,s,n)=>{const a=Re(i,n),o=await this.core.crypto.encode(s,a),h=await this.core.history.get(s,i),d=L[h.request.method].res;await this.core.relayer.publish(s,o,d),await this.core.history.resolve(a)},this.sendError=async(i,s,n)=>{const a=xi(i,n),o=await this.core.crypto.encode(s,a),h=await this.core.history.get(s,i),d=L[h.request.method]?L[h.request.method].res:L.unregistered_method.res;await this.core.relayer.publish(s,o,d),await this.core.history.resolve(a)},this.deletePairing=async(i,s)=>{await this.core.relayer.unsubscribe(i),await Promise.all([this.pairings.delete(i,F("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(i),s?Promise.resolve():this.core.expirer.del(i)])},this.cleanup=async()=>{const i=this.pairings.getAll().filter(s=>fe(s.expiry));await Promise.all(i.map(s=>this.deletePairing(s.topic)))},this.onRelayEventRequest=i=>{const{topic:s,payload:n}=i,a=n.method;if(this.pairings.keys.includes(s))switch(a){case"wc_pairingPing":return this.onPairingPingRequest(s,n);case"wc_pairingDelete":return this.onPairingDeleteRequest(s,n);default:return this.onUnknownRpcMethodRequest(s,n)}},this.onRelayEventResponse=async i=>{const{topic:s,payload:n}=i,a=(await this.core.history.get(s,n.id)).request.method;if(this.pairings.keys.includes(s))switch(a){case"wc_pairingPing":return this.onPairingPingResponse(s,n);default:return this.onUnknownRpcMethodResponse(a)}},this.onPairingPingRequest=async(i,s)=>{const{id:n}=s;try{this.isValidPing({topic:i}),await this.sendResult(n,i,!0),this.events.emit("pairing_ping",{id:n,topic:i})}catch(a){await this.sendError(n,i,a),this.logger.error(a)}},this.onPairingPingResponse=(i,s)=>{const{id:n}=s;setTimeout(()=>{Oi(s)?this.events.emit(ie("pairing_ping",n),{}):Te(s)&&this.events.emit(ie("pairing_ping",n),{error:s.error})},500)},this.onPairingDeleteRequest=async(i,s)=>{const{id:n}=s;try{this.isValidDisconnect({topic:i}),await this.deletePairing(i),this.events.emit("pairing_delete",{id:n,topic:i})}catch(a){await this.sendError(n,i,a),this.logger.error(a)}},this.onUnknownRpcMethodRequest=async(i,s)=>{const{id:n,method:a}=s;try{if(this.registeredMethods.includes(a))return;const o=F("WC_METHOD_UNSUPPORTED",a);await this.sendError(n,i,o),this.logger.error(o)}catch(o){await this.sendError(n,i,o),this.logger.error(o)}},this.onUnknownRpcMethodResponse=i=>{this.registeredMethods.includes(i)||this.logger.error(F("WC_METHOD_UNSUPPORTED",i))},this.isValidPair=i=>{if(!se(i)){const{message:s}=c("MISSING_OR_INVALID",`pair() params: ${i}`);throw new Error(s)}if(!bi(i.uri)){const{message:s}=c("MISSING_OR_INVALID",`pair() uri: ${i.uri}`);throw new Error(s)}},this.isValidPing=async i=>{if(!se(i)){const{message:n}=c("MISSING_OR_INVALID",`ping() params: ${i}`);throw new Error(n)}const{topic:s}=i;await this.isValidPairingTopic(s)},this.isValidDisconnect=async i=>{if(!se(i)){const{message:n}=c("MISSING_OR_INVALID",`disconnect() params: ${i}`);throw new Error(n)}const{topic:s}=i;await this.isValidPairingTopic(s)},this.isValidPairingTopic=async i=>{if(!mi(i,!1)){const{message:s}=c("MISSING_OR_INVALID",`pairing topic should be a string: ${i}`);throw new Error(s)}if(!this.pairings.keys.includes(i)){const{message:s}=c("NO_MATCHING_KEY",`pairing topic doesn't exist: ${i}`);throw new Error(s)}if(fe(this.pairings.get(i).expiry)){await this.deletePairing(i);const{message:s}=c("EXPIRED",`pairing topic: ${i}`);throw new Error(s)}},this.core=e,this.logger=f(t,this.name),this.pairings=new At(this.core,this.logger,this.name,this.storagePrefix)}get context(){return E(this.logger)}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(g.message,async e=>{const{topic:t,message:i}=e;if(this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(i)))return;const s=await this.core.crypto.decode(t,i);Ce(s)?(this.core.history.set(t,s),this.onRelayEventRequest({topic:t,payload:s})):_e(s)&&(await this.core.history.resolve(s),this.onRelayEventResponse({topic:t,payload:s}))})}registerExpirerEvents(){this.core.expirer.on(w.expired,async e=>{const{topic:t}=fi(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit("pairing_expire",{topic:t}))})}}class Nt extends Jt{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.records=new Map,this.events=new z,this.name=yt,this.version=bt,this.cached=[],this.initialized=!1,this.storagePrefix=x,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.records.set(i.id,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.set=(i,s,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:i,request:s,chainId:n}),this.records.has(s.id))return;const a={id:s.id,topic:i,request:{method:s.method,params:s.params||null},chainId:n};this.records.set(a.id,a),this.events.emit(_.created,a)},this.resolve=async i=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:i}),!this.records.has(i.id))return;const s=await this.getRecord(i.id);typeof s.response>"u"&&(s.response=Te(i)?{error:i.error}:{result:i.result},this.records.set(s.id,s),this.events.emit(_.updated,s))},this.get=async(i,s)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:i,id:s}),await this.getRecord(s)),this.delete=(i,s)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:s}),this.values.forEach(n=>{if(n.topic===i){if(typeof s<"u"&&n.id!==s)return;this.records.delete(n.id),this.events.emit(_.deleted,n)}})},this.exists=async(i,s)=>(this.isInitialized(),this.records.has(s)?(await this.getRecord(s)).topic===i:!1),this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.logger=f(t,this.name)}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){const e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;const i={topic:t.topic,request:Se(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(i)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();const t=this.records.get(e);if(!t){const{message:i}=c("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(_.sync)}async restore(){try{const e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){const{message:t}=c("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(_.created,e=>{const t=_.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()}),this.events.on(_.updated,e=>{const t=_.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()}),this.events.on(_.deleted,e=>{const t=_.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Ut extends Ht{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.expirations=new Map,this.events=new z,this.name=mt,this.version=ft,this.cached=[],this.initialized=!1,this.storagePrefix=x,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.expirations.set(i.target,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.has=i=>{try{const s=this.formatTarget(i);return typeof this.getExpiration(s)<"u"}catch{return!1}},this.set=(i,s)=>{this.isInitialized();const n=this.formatTarget(i),a={target:n,expiry:s};this.expirations.set(n,a),this.checkExpiry(n,a),this.events.emit(w.created,{target:n,expiration:a})},this.get=i=>{this.isInitialized();const s=this.formatTarget(i);return this.getExpiration(s)},this.del=i=>{if(this.isInitialized(),this.has(i)){const s=this.formatTarget(i),n=this.getExpiration(s);this.expirations.delete(s),this.events.emit(w.deleted,{target:s,expiration:n})}},this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.logger=f(t,this.name)}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return Ei(e);if(typeof e=="number")return wi(e);const{message:t}=c("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(w.sync)}async restore(){try{const e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){const{message:t}=c("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){const t=this.expirations.get(e);if(!t){const{message:i}=c("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(i),new Error(i)}return t}checkExpiry(e,t){const{expiry:i}=t;V(i)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit(w.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(X.pulse,()=>this.checkExpirations()),this.events.on(w.created,e=>{const t=w.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(w.expired,e=>{const t=w.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(w.deleted,e=>{const t=w.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Lt extends Xt{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,this.name=Y,this.initialized=!1,this.init=async i=>{vi()||!Ii()||(this.verifyUrl=i?.verifyUrl||le,await this.createIframe())},this.register=async i=>{var s;this.initialized||await this.init(),this.iframe&&((s=this.iframe.contentWindow)==null||s.postMessage(i.attestationId,this.verifyUrl),this.logger.info(`postMessage sent: ${i.attestationId} ${this.verifyUrl}`))},this.resolve=async i=>{var s;if(this.isDevEnv)return"";this.logger.info(`resolving attestation: ${i.attestationId}`);const n=this.startAbortTimer(we),a=await fetch(`${this.verifyUrl}/attestation/${i.attestationId}`,{signal:this.abortController.signal});return clearTimeout(n),a.status===200?(s=await a.json())==null?void 0:s.origin:""},this.createIframe=async()=>{try{await Promise.race([new Promise((i,s)=>{if(document.getElementById(Y))return i();const n=document.createElement("iframe");n.setAttribute("id",Y),n.setAttribute("src",`${this.verifyUrl}/${this.projectId}`),n.style.display="none",n.addEventListener("load",()=>{this.initialized=!0,i()}),n.addEventListener("error",a=>{s(a)}),document.body.append(n),this.iframe=n}),new Promise(i=>{setTimeout(()=>i("iframe load timeout"),V(Ee/2))})])}catch(i){this.logger.error(`Verify iframe failed to load: ${this.verifyUrl}`),this.logger.error(i)}},this.logger=f(t,this.name),this.verifyUrl=le,this.abortController=new AbortController,this.isDevEnv=Ci()&&process.env.IS_VITEST}get context(){return E(this.logger)}startAbortTimer(e){return setTimeout(()=>this.abortController.abort(),V(e))}}var vr=Object.defineProperty,Ft=Object.getOwnPropertySymbols,Ir=Object.prototype.hasOwnProperty,Cr=Object.prototype.propertyIsEnumerable,$t=(r,e,t)=>e in r?vr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Mt=(r,e)=>{for(var t in e||(e={}))Ir.call(e,t)&&$t(r,t,e[t]);if(Ft)for(var t of Ft(e))Cr.call(e,t)&&$t(r,t,e[t]);return r};class J extends Wt{constructor(e){super(e),this.protocol=he,this.version=Ge,this.name=G,this.events=new z,this.initialized=!1,this.on=(i,s)=>this.events.on(i,s),this.once=(i,s)=>this.events.once(i,s),this.off=(i,s)=>this.events.off(i,s),this.removeListener=(i,s)=>this.events.removeListener(i,s),this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||ue;const t=typeof e?.logger<"u"&&typeof e?.logger!="string"?e.logger:ge(pe({level:e?.logger||Ye.logger}));this.logger=f(t,this.name),this.heartbeat=new Bt,this.crypto=new wt(this,this.logger,e?.keychain),this.history=new Nt(this,this.logger),this.expirer=new Ut(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new kt(Mt(Mt({},Je),e?.storageOptions)),this.relayer=new Tt({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new zt(this,this.logger),this.verify=new Lt(this.projectId||"",this.logger)}static async init(e){const t=new J(e);return await t.initialize(),t}get context(){return E(this.logger)}async start(){this.initialized||await this.initialize()}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}}const _r=J;export{G as CORE_CONTEXT,Ye as CORE_DEFAULT,he as CORE_PROTOCOL,Je as CORE_STORAGE_OPTIONS,x as CORE_STORAGE_PREFIX,Ge as CORE_VERSION,ce as CRYPTO_CLIENT_SEED,He as CRYPTO_CONTEXT,Xe as CRYPTO_JWT_TTL,_r as Core,wt as Crypto,mt as EXPIRER_CONTEXT,or as EXPIRER_DEFAULT_TTL,w as EXPIRER_EVENTS,ft as EXPIRER_STORAGE_VERSION,Ut as Expirer,yt as HISTORY_CONTEXT,_ as HISTORY_EVENTS,bt as HISTORY_STORAGE_VERSION,Nt as JsonRpcHistory,We as KEYCHAIN_CONTEXT,Ze as KEYCHAIN_STORAGE_VERSION,Et as KeyChain,Qe as MESSAGES_CONTEXT,et as MESSAGES_STORAGE_VERSION,vt as MessageTracker,pt as PAIRING_CONTEXT,ar as PAIRING_DEFAULT_TTL,L as PAIRING_RPC_OPTS,Dt as PAIRING_STORAGE_VERSION,gt as PENDING_SUB_RESOLUTION_TIMEOUT,it as PUBLISHER_CONTEXT,tt as PUBLISHER_DEFAULT_TTL,zt as Pairing,nt as RELAYER_CONTEXT,rt as RELAYER_DEFAULT_LOGGER,st as RELAYER_DEFAULT_PROTOCOL,ue as RELAYER_DEFAULT_RELAY_URL,g as RELAYER_EVENTS,U as RELAYER_PROVIDER_EVENTS,ot as RELAYER_RECONNECT_TIMEOUT,ht as RELAYER_SDK_VERSION,rr as RELAYER_STORAGE_OPTIONS,at as RELAYER_SUBSCRIBER_SUFFIX,ct as RELAYER_TRANSPORT_CUTOFF,Tt as Relayer,ut as STORE_STORAGE_VERSION,lt as SUBSCRIBER_CONTEXT,nr as SUBSCRIBER_DEFAULT_TTL,C as SUBSCRIBER_EVENTS,dt as SUBSCRIBER_STORAGE_VERSION,At as Store,_t as Subscriber,Y as VERIFY_CONTEXT,le as VERIFY_SERVER,Lt as Verify,J as default};
+import Kt,{EventEmitter as z}from"events";import kt from"@walletconnect/keyvaluestorage";import{HEARTBEAT_EVENTS as X,HeartBeat as Bt}from"@walletconnect/heartbeat";import{generateChildLogger as f,getLoggerContext as E,pino as ge,getDefaultLoggerOptions as pe}from"@walletconnect/logger";import{IMessageTracker as jt,IPublisher as Vt,ISubscriber as qt,IRelayer as Gt,IStore as Yt,IJsonRpcHistory as Jt,IExpirer as Ht,IVerify as Xt,ICore as Wt}from"@walletconnect/types";import{safeJsonStringify as Zt,safeJsonParse as Qt}from"@walletconnect/safe-json";import*as k from"@walletconnect/relay-auth";import{getInternalError as c,mapToObj as De,objToMap as ye,generateKeyPair as ei,generateRandomBytes32 as W,deriveSymKey as ti,hashKey as ii,validateEncoding as si,isTypeOneEnvelope as be,encrypt as ri,validateDecoding as ni,decrypt as ai,deserialize as me,decodeTypeByte as oi,BASE16 as hi,hashMessage as Z,getRelayProtocolName as Q,createExpiringPromise as B,getRelayProtocolApi as j,isUndefined as ee,getSdkError as F,isValidArray as ci,formatRelayRpcUrl as ui,isProposalStruct as li,isSessionStruct as di,TYPE_1 as gi,calcExpiry as te,formatUri as pi,parseUri as Di,createDelayedPromise as yi,engineEvent as ie,isExpired as fe,isValidParams as se,isValidUrl as bi,isValidString as mi,parseExpirerTarget as fi,formatTopicTarget as Ei,formatIdTarget as wi,isReactNative as vi,isBrowser as Ii,isNode as Ci}from"@walletconnect/utils";import{toString as _i}from"uint8arrays";import{ONE_DAY as N,SIX_HOURS as Ri,ONE_SECOND as Ee,THIRTY_DAYS as re,FIVE_SECONDS as we,THIRTY_SECONDS as ve,Watch as Si,toMiliseconds as V,FIVE_MINUTES as Ie}from"@walletconnect/time";import{JsonRpcProvider as Ti}from"@walletconnect/jsonrpc-provider";import{getBigIntRpcId as Pi,isJsonRpcRequest as Ce,isJsonRpcResponse as _e,formatJsonRpcResult as Re,formatJsonRpcRequest as Se,formatJsonRpcError as xi,isJsonRpcResult as Oi,isJsonRpcError as Te}from"@walletconnect/jsonrpc-utils";import Ai from"@walletconnect/jsonrpc-ws-connection";import zi from"lodash.isequal";function Ni(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),i=0;i<t.length;i++)t[i]=255;for(var s=0;s<r.length;s++){var n=r.charAt(s),a=n.charCodeAt(0);if(t[a]!==255)throw new TypeError(n+" is ambiguous");t[a]=s}var o=r.length,h=r.charAt(0),d=Math.log(o)/Math.log(256),l=Math.log(256)/Math.log(o);function D(u){if(u instanceof Uint8Array||(ArrayBuffer.isView(u)?u=new Uint8Array(u.buffer,u.byteOffset,u.byteLength):Array.isArray(u)&&(u=Uint8Array.from(u))),!(u instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(u.length===0)return"";for(var y=0,A=0,v=0,R=u.length;v!==R&&u[v]===0;)v++,y++;for(var S=(R-v)*l+1>>>0,m=new Uint8Array(S);v!==R;){for(var T=u[v],O=0,I=S-1;(T!==0||O<A)&&I!==-1;I--,O++)T+=256*m[I]>>>0,m[I]=T%o>>>0,T=T/o>>>0;if(T!==0)throw new Error("Non-zero carry");A=O,v++}for(var P=S-A;P!==S&&m[P]===0;)P++;for(var K=h.repeat(y);P<S;++P)K+=r.charAt(m[P]);return K}function b(u){if(typeof u!="string")throw new TypeError("Expected String");if(u.length===0)return new Uint8Array;var y=0;if(u[y]!==" "){for(var A=0,v=0;u[y]===h;)A++,y++;for(var R=(u.length-y)*d+1>>>0,S=new Uint8Array(R);u[y];){var m=t[u.charCodeAt(y)];if(m===255)return;for(var T=0,O=R-1;(m!==0||T<v)&&O!==-1;O--,T++)m+=o*S[O]>>>0,S[O]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");v=T,y++}if(u[y]!==" "){for(var I=R-v;I!==R&&S[I]===0;)I++;for(var P=new Uint8Array(A+(R-I)),K=A;I!==R;)P[K++]=S[I++];return P}}}function H(u){var y=b(u);if(y)return y;throw new Error(`Non-${e} character`)}return{encode:D,decodeUnsafe:b,decode:H}}var Ui=Ni,Li=Ui;const Pe=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Fi=r=>new TextEncoder().encode(r),$i=r=>new TextDecoder().decode(r);class Mi{constructor(e,t,i){this.name=e,this.prefix=t,this.baseEncode=i}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Ki{constructor(e,t,i){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=i}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return xe(this,e)}}class ki{constructor(e){this.decoders=e}or(e){return xe(this,e)}decode(e){const t=e[0],i=this.decoders[t];if(i)return i.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const xe=(r,e)=>new ki({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});class Bi{constructor(e,t,i,s){this.name=e,this.prefix=t,this.baseEncode=i,this.baseDecode=s,this.encoder=new Mi(e,t,i),this.decoder=new Ki(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const q=({name:r,prefix:e,encode:t,decode:i})=>new Bi(r,e,t,i),$=({prefix:r,name:e,alphabet:t})=>{const{encode:i,decode:s}=Li(t,e);return q({prefix:r,name:e,encode:i,decode:n=>Pe(s(n))})},ji=(r,e,t,i)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let n=r.length;for(;r[n-1]==="=";)--n;const a=new Uint8Array(n*t/8|0);let o=0,h=0,d=0;for(let l=0;l<n;++l){const D=s[r[l]];if(D===void 0)throw new SyntaxError(`Non-${i} character`);h=h<<t|D,o+=t,o>=8&&(o-=8,a[d++]=255&h>>o)}if(o>=t||255&h<<8-o)throw new SyntaxError("Unexpected end of data");return a},Vi=(r,e,t)=>{const i=e[e.length-1]==="=",s=(1<<t)-1;let n="",a=0,o=0;for(let h=0;h<r.length;++h)for(o=o<<8|r[h],a+=8;a>t;)a-=t,n+=e[s&o>>a];if(a&&(n+=e[s&o<<t-a]),i)for(;n.length*t&7;)n+="=";return n},p=({name:r,prefix:e,bitsPerChar:t,alphabet:i})=>q({prefix:e,name:r,encode(s){return Vi(s,i,t)},decode(s){return ji(s,i,t,r)}}),qi=q({prefix:"\0",name:"identity",encode:r=>$i(r),decode:r=>Fi(r)});var Gi=Object.freeze({__proto__:null,identity:qi});const Yi=p({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Ji=Object.freeze({__proto__:null,base2:Yi});const Hi=p({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Xi=Object.freeze({__proto__:null,base8:Hi});const Wi=$({prefix:"9",name:"base10",alphabet:"0123456789"});var Zi=Object.freeze({__proto__:null,base10:Wi});const Qi=p({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),es=p({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var ts=Object.freeze({__proto__:null,base16:Qi,base16upper:es});const is=p({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),ss=p({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),rs=p({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),ns=p({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),as=p({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),os=p({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),hs=p({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),cs=p({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),us=p({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var ls=Object.freeze({__proto__:null,base32:is,base32upper:ss,base32pad:rs,base32padupper:ns,base32hex:as,base32hexupper:os,base32hexpad:hs,base32hexpadupper:cs,base32z:us});const ds=$({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),gs=$({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var ps=Object.freeze({__proto__:null,base36:ds,base36upper:gs});const Ds=$({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),ys=$({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var bs=Object.freeze({__proto__:null,base58btc:Ds,base58flickr:ys});const ms=p({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),fs=p({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Es=p({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),ws=p({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var vs=Object.freeze({__proto__:null,base64:ms,base64pad:fs,base64url:Es,base64urlpad:ws});const Oe=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Is=Oe.reduce((r,e,t)=>(r[t]=e,r),[]),Cs=Oe.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function _s(r){return r.reduce((e,t)=>(e+=Is[t],e),"")}function Rs(r){const e=[];for(const t of r){const i=Cs[t.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const Ss=q({prefix:"\u{1F680}",name:"base256emoji",encode:_s,decode:Rs});var Ts=Object.freeze({__proto__:null,base256emoji:Ss}),Ps=ze,Ae=128,xs=127,Os=~xs,As=Math.pow(2,31);function ze(r,e,t){e=e||[],t=t||0;for(var i=t;r>=As;)e[t++]=r&255|Ae,r/=128;for(;r&Os;)e[t++]=r&255|Ae,r>>>=7;return e[t]=r|0,ze.bytes=t-i+1,e}var zs=ne,Ns=128,Ne=127;function ne(r,i){var t=0,i=i||0,s=0,n=i,a,o=r.length;do{if(n>=o)throw ne.bytes=0,new RangeError("Could not decode varint");a=r[n++],t+=s<28?(a&Ne)<<s:(a&Ne)*Math.pow(2,s),s+=7}while(a>=Ns);return ne.bytes=n-i,t}var Us=Math.pow(2,7),Ls=Math.pow(2,14),Fs=Math.pow(2,21),$s=Math.pow(2,28),Ms=Math.pow(2,35),Ks=Math.pow(2,42),ks=Math.pow(2,49),Bs=Math.pow(2,56),js=Math.pow(2,63),Vs=function(r){return r<Us?1:r<Ls?2:r<Fs?3:r<$s?4:r<Ms?5:r<Ks?6:r<ks?7:r<Bs?8:r<js?9:10},qs={encode:Ps,decode:zs,encodingLength:Vs},Ue=qs;const Le=(r,e,t=0)=>(Ue.encode(r,e,t),e),Fe=r=>Ue.encodingLength(r),ae=(r,e)=>{const t=e.byteLength,i=Fe(r),s=i+Fe(t),n=new Uint8Array(s+t);return Le(r,n,0),Le(t,n,i),n.set(e,s),new Gs(r,t,e,n)};class Gs{constructor(e,t,i,s){this.code=e,this.size=t,this.digest=i,this.bytes=s}}const $e=({name:r,code:e,encode:t})=>new Ys(r,e,t);class Ys{constructor(e,t,i){this.name=e,this.code=t,this.encode=i}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?ae(this.code,t):t.then(i=>ae(this.code,i))}else throw Error("Unknown type, must be binary type")}}const Me=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Js=$e({name:"sha2-256",code:18,encode:Me("SHA-256")}),Hs=$e({name:"sha2-512",code:19,encode:Me("SHA-512")});var Xs=Object.freeze({__proto__:null,sha256:Js,sha512:Hs});const Ke=0,Ws="identity",ke=Pe,Zs=r=>ae(Ke,ke(r)),Qs={code:Ke,name:Ws,encode:ke,digest:Zs};var er=Object.freeze({__proto__:null,identity:Qs});new TextEncoder,new TextDecoder;const Be={...Gi,...Ji,...Xi,...Zi,...ts,...ls,...ps,...bs,...vs,...Ts};({...Xs,...er});function je(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function tr(r=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?je(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function Ve(r,e,t,i){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:i}}}const qe=Ve("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),oe=Ve("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=tr(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),ir={utf8:qe,"utf-8":qe,hex:Be.base16,latin1:oe,ascii:oe,binary:oe,...Be};function sr(r,e="utf8"){const t=ir[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?je(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}const he="wc",Ge=2,G="core",x=`${he}@${2}:${G}:`,Ye={name:G,logger:"error"},Je={database:":memory:"},He="crypto",ce="client_ed25519_seed",Xe=N,We="keychain",Ze="0.3",Qe="messages",et="0.3",tt=Ri,it="publisher",st="irn",rt="error",ue="wss://relay.walletconnect.com",nt="relayer",g={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},at="_subscription",U={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},ot=Ee/2,rr={database:":memory:"},ht="2.7.8",ct=1e4,ut="0.3",C={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"},nr=re,lt="subscription",dt="0.3",gt=we*1e3,pt="pairing",Dt="0.3",ar=re,L={wc_pairingDelete:{req:{ttl:N,prompt:!1,tag:1e3},res:{ttl:N,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:ve,prompt:!1,tag:1002},res:{ttl:ve,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:N,prompt:!1,tag:0},res:{ttl:N,prompt:!1,tag:0}}},_={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},yt="history",bt="0.3",mt="expirer",w={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},ft="0.3",or=N,Y="verify-api",le="https://verify.walletconnect.com";class Et{constructor(e,t){this.core=e,this.logger=t,this.keychain=new Map,this.name=We,this.version=Ze,this.initialized=!1,this.storagePrefix=x,this.init=async()=>{if(!this.initialized){const i=await this.getKeyChain();typeof i<"u"&&(this.keychain=i),this.initialized=!0}},this.has=i=>(this.isInitialized(),this.keychain.has(i)),this.set=async(i,s)=>{this.isInitialized(),this.keychain.set(i,s),await this.persist()},this.get=i=>{this.isInitialized();const s=this.keychain.get(i);if(typeof s>"u"){const{message:n}=c("NO_MATCHING_KEY",`${this.name}: ${i}`);throw new Error(n)}return s},this.del=async i=>{this.isInitialized(),this.keychain.delete(i),await this.persist()},this.core=e,this.logger=f(t,this.name)}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,De(e))}async getKeyChain(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?ye(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class wt{constructor(e,t,i){this.core=e,this.logger=t,this.name=He,this.initialized=!1,this.init=async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)},this.hasKeys=s=>(this.isInitialized(),this.keychain.has(s)),this.getClientId=async()=>{this.isInitialized();const s=await this.getClientSeed(),n=k.generateKeyPair(s);return k.encodeIss(n.publicKey)},this.generateKeyPair=()=>{this.isInitialized();const s=ei();return this.setPrivateKey(s.publicKey,s.privateKey)},this.signJWT=async s=>{this.isInitialized();const n=await this.getClientSeed(),a=k.generateKeyPair(n),o=W(),h=Xe;return await k.signJWT(o,s,h,a)},this.generateSharedKey=(s,n,a)=>{this.isInitialized();const o=this.getPrivateKey(s),h=ti(o,n);return this.setSymKey(h,a)},this.setSymKey=async(s,n)=>{this.isInitialized();const a=n||ii(s);return await this.keychain.set(a,s),a},this.deleteKeyPair=async s=>{this.isInitialized(),await this.keychain.del(s)},this.deleteSymKey=async s=>{this.isInitialized(),await this.keychain.del(s)},this.encode=async(s,n,a)=>{this.isInitialized();const o=si(a),h=Zt(n);if(be(o)){const b=o.senderPublicKey,H=o.receiverPublicKey;s=await this.generateSharedKey(b,H)}const d=this.getSymKey(s),{type:l,senderPublicKey:D}=o;return ri({type:l,symKey:d,message:h,senderPublicKey:D})},this.decode=async(s,n,a)=>{this.isInitialized();const o=ni(n,a);if(be(o)){const l=o.receiverPublicKey,D=o.senderPublicKey;s=await this.generateSharedKey(l,D)}const h=this.getSymKey(s),d=ai({symKey:h,encoded:n});return Qt(d)},this.getPayloadType=s=>{const n=me(s);return oi(n.type)},this.getPayloadSenderPublicKey=s=>{const n=me(s);return n.senderPublicKey?_i(n.senderPublicKey,hi):void 0},this.core=e,this.logger=f(t,this.name),this.keychain=i||new Et(this.core,this.logger)}get context(){return E(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(ce)}catch{e=W(),await this.keychain.set(ce,e)}return sr(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class vt extends jt{constructor(e,t){super(e,t),this.logger=e,this.core=t,this.messages=new Map,this.name=Qe,this.version=et,this.initialized=!1,this.storagePrefix=x,this.init=async()=>{if(!this.initialized){this.logger.trace("Initialized");try{const i=await this.getRelayerMessages();typeof i<"u"&&(this.messages=i),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(i){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(i)}finally{this.initialized=!0}}},this.set=async(i,s)=>{this.isInitialized();const n=Z(s);let a=this.messages.get(i);return typeof a>"u"&&(a={}),typeof a[n]<"u"||(a[n]=s,this.messages.set(i,a),await this.persist()),n},this.get=i=>{this.isInitialized();let s=this.messages.get(i);return typeof s>"u"&&(s={}),s},this.has=(i,s)=>{this.isInitialized();const n=this.get(i),a=Z(s);return typeof n[a]<"u"},this.del=async i=>{this.isInitialized(),this.messages.delete(i),await this.persist()},this.logger=f(e,this.name),this.core=t}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,De(e))}async getRelayerMessages(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?ye(e):void 0}async persist(){await this.setRelayerMessages(this.messages)}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class hr extends Vt{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.events=new z,this.name=it,this.queue=new Map,this.publishTimeout=1e4,this.publish=async(i,s,n)=>{this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:i,message:s,opts:n}});try{const a=n?.ttl||tt,o=Q(n),h=n?.prompt||!1,d=n?.tag||0,l=n?.id||Pi().toString(),D={topic:i,message:s,opts:{ttl:a,relay:o,prompt:h,tag:d,id:l}};this.queue.set(l,D);try{await await B(this.rpcPublish(i,s,a,o,h,d,l),this.publishTimeout),this.relayer.events.emit(g.publish,D)}catch{this.logger.debug("Publishing Payload stalled"),this.relayer.events.emit(g.connection_stalled);return}this.logger.debug("Successfully Published Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:i,message:s,opts:n}})}catch(a){throw this.logger.debug("Failed to Publish Payload"),this.logger.error(a),a}},this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.relayer=e,this.logger=f(t,this.name),this.registerEventListeners()}get context(){return E(this.logger)}rpcPublish(e,t,i,s,n,a,o){var h,d,l,D;const b={method:j(s.protocol).publish,params:{topic:e,message:t,ttl:i,prompt:n,tag:a},id:o};return ee((h=b.params)==null?void 0:h.prompt)&&((d=b.params)==null||delete d.prompt),ee((l=b.params)==null?void 0:l.tag)&&((D=b.params)==null||delete D.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:b}),this.relayer.request(b)}onPublish(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async e=>{const{topic:t,message:i,opts:s}=e;await this.publish(t,i,s)})}registerEventListeners(){this.relayer.core.heartbeat.on(X.pulse,()=>{this.checkQueue()}),this.relayer.on(g.message_ack,e=>{this.onPublish(e.id.toString())})}}class cr{constructor(){this.map=new Map,this.set=(e,t)=>{const i=this.get(e);this.exists(e,t)||this.map.set(e,[...i,t])},this.get=e=>this.map.get(e)||[],this.exists=(e,t)=>this.get(e).includes(t),this.delete=(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;const i=this.get(e);if(!this.exists(e,t))return;const s=i.filter(n=>n!==t);if(!s.length){this.map.delete(e);return}this.map.set(e,s)},this.clear=()=>{this.map.clear()}}get topics(){return Array.from(this.map.keys())}}var ur=Object.defineProperty,lr=Object.defineProperties,dr=Object.getOwnPropertyDescriptors,It=Object.getOwnPropertySymbols,gr=Object.prototype.hasOwnProperty,pr=Object.prototype.propertyIsEnumerable,Ct=(r,e,t)=>e in r?ur(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,M=(r,e)=>{for(var t in e||(e={}))gr.call(e,t)&&Ct(r,t,e[t]);if(It)for(var t of It(e))pr.call(e,t)&&Ct(r,t,e[t]);return r},de=(r,e)=>lr(r,dr(e));class _t extends qt{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.subscriptions=new Map,this.topicMap=new cr,this.events=new z,this.name=lt,this.version=dt,this.pending=new Map,this.cached=[],this.initialized=!1,this.pendingSubscriptionWatchLabel="pending_sub_watch_label",this.pollingInterval=20,this.storagePrefix=x,this.subscribeTimeout=1e4,this.restartInProgress=!1,this.batchSubscribeTopicsLimit=500,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restart(),this.registerEventListeners(),this.onEnable(),this.clientId=await this.relayer.core.crypto.getClientId())},this.subscribe=async(i,s)=>{await this.restartToComplete(),this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:s}});try{const n=Q(s),a={topic:i,relay:n};this.pending.set(i,a);const o=await this.rpcSubscribe(i,n);return this.onSubscribe(o,a),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:s}}),o}catch(n){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(n),n}},this.unsubscribe=async(i,s)=>{await this.restartToComplete(),this.isInitialized(),typeof s?.id<"u"?await this.unsubscribeById(i,s.id,s):await this.unsubscribeByTopic(i,s)},this.isSubscribed=async i=>this.topics.includes(i)?!0:await new Promise((s,n)=>{const a=new Si;a.start(this.pendingSubscriptionWatchLabel);const o=setInterval(()=>{!this.pending.has(i)&&this.topics.includes(i)&&(clearInterval(o),a.stop(this.pendingSubscriptionWatchLabel),s(!0)),a.elapsed(this.pendingSubscriptionWatchLabel)>=gt&&(clearInterval(o),a.stop(this.pendingSubscriptionWatchLabel),n(new Error("Subscription resolution timeout")))},this.pollingInterval)}).catch(()=>!1),this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.restart=async()=>{this.restartInProgress=!0,await this.restore(),await this.reset(),this.restartInProgress=!1},this.relayer=e,this.logger=f(t,this.name),this.clientId=""}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}hasSubscription(e,t){let i=!1;try{i=this.getSubscription(e).topic===t}catch{}return i}onEnable(){this.cached=[],this.initialized=!0}onDisable(){this.cached=this.values,this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){const i=this.topicMap.get(e);await Promise.all(i.map(async s=>await this.unsubscribeById(e,s,t)))}async unsubscribeById(e,t,i){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}});try{const s=Q(i);await this.rpcUnsubscribe(e,t,s);const n=F("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}})}catch(s){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(s),s}}async rpcSubscribe(e,t){const i={method:j(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});try{await await B(this.relayer.request(i),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(g.connection_stalled)}return Z(e+this.clientId)}async rpcBatchSubscribe(e){if(!e.length)return;const t=e[0].relay,i={method:j(t.protocol).batchSubscribe,params:{topics:e.map(s=>s.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});try{return await await B(this.relayer.request(i),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Payload stalled"),this.relayer.events.emit(g.connection_stalled)}}rpcUnsubscribe(e,t,i){const s={method:j(i.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s}),this.relayer.request(s)}onSubscribe(e,t){this.setSubscription(e,de(M({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,M({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,i){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,i),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.subscriptions.has(e)||(this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t))}addSubscription(e,t){this.subscriptions.set(e,M({},t)),this.topicMap.set(t.topic,e),this.events.emit(C.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});const t=this.subscriptions.get(e);if(!t){const{message:i}=c("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});const i=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(i.topic,e),this.events.emit(C.deleted,de(M({},i),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(C.sync)}async reset(){if(this.cached.length){const e=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let t=0;t<e;t++){const i=this.cached.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(i)}}this.events.emit(C.resubscribed)}async restore(){try{const e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){const{message:t}=c("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){if(!e.length)return;const t=await this.rpcBatchSubscribe(e);ci(t)&&this.onBatchSubscribe(t.map((i,s)=>de(M({},e[s]),{id:i})))}async onConnect(){this.restartInProgress||(await this.restart(),this.onEnable())}onDisconnect(){this.onDisable()}async checkPending(){if(this.relayer.transportExplicitlyClosed)return;const e=[];this.pending.forEach(t=>{e.push(t)}),await this.batchSubscribe(e)}registerEventListeners(){this.relayer.core.heartbeat.on(X.pulse,async()=>{await this.checkPending()}),this.relayer.on(g.connect,async()=>{await this.onConnect()}),this.relayer.on(g.disconnect,()=>{this.onDisconnect()}),this.events.on(C.created,async e=>{const t=C.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()}),this.events.on(C.deleted,async e=>{const t=C.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(){this.restartInProgress&&await new Promise(e=>{const t=setInterval(()=>{this.restartInProgress||(clearInterval(t),e())},this.pollingInterval)})}}var Dr=Object.defineProperty,Rt=Object.getOwnPropertySymbols,yr=Object.prototype.hasOwnProperty,br=Object.prototype.propertyIsEnumerable,St=(r,e,t)=>e in r?Dr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,mr=(r,e)=>{for(var t in e||(e={}))yr.call(e,t)&&St(r,t,e[t]);if(Rt)for(var t of Rt(e))br.call(e,t)&&St(r,t,e[t]);return r};class Tt extends Gt{constructor(e){super(e),this.protocol="wc",this.version=2,this.events=new z,this.name=nt,this.transportExplicitlyClosed=!1,this.initialized=!1,this.reconnecting=!1,this.connectionStatusPollingInterval=20,this.staleConnectionErrors=["socket hang up","socket stalled"],this.request=async t=>{this.logger.debug("Publishing Request Payload");try{return await this.toEstablishConnection(),await this.provider.request(t)}catch(i){throw this.logger.debug("Failed to Publish Request"),this.logger.error(i),i}},this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?f(e.logger,this.name):ge(pe({level:e.logger||rt})),this.messages=new vt(this.logger,e.core),this.subscriber=new _t(this,this.logger),this.publisher=new hr(this,this.logger),this.relayUrl=e?.relayUrl||ue,this.projectId=e.projectId,this.provider={}}async init(){this.logger.trace("Initialized"),await this.createProvider(),await Promise.all([this.messages.init(),this.transportOpen(),this.subscriber.init()]),this.registerEventListeners(),this.initialized=!0,setTimeout(async()=>{this.subscriber.topics.length===0&&(this.logger.info("No topics subscribted to after init, closing transport"),await this.transportClose(),this.transportExplicitlyClosed=!1)},ct)}get context(){return E(this.logger)}get connected(){return this.provider.connection.connected}get connecting(){return this.provider.connection.connecting}async publish(e,t,i){this.isInitialized(),await this.publisher.publish(e,t,i),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now()})}async subscribe(e,t){var i;this.isInitialized();let s=((i=this.subscriber.topicMap.get(e))==null?void 0:i[0])||"";return s||(await Promise.all([new Promise(n=>{this.subscriber.once(C.created,a=>{a.topic===e&&n()})}),new Promise(async n=>{s=await this.subscriber.subscribe(e,t),n()})]),s)}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportClose(){this.transportExplicitlyClosed=!0,this.connected&&(await this.provider.disconnect(),this.events.emit(g.transport_closed))}async transportOpen(e){if(this.transportExplicitlyClosed=!1,!this.reconnecting){this.relayUrl=e||this.relayUrl,this.reconnecting=!0;try{await Promise.all([new Promise(t=>{this.initialized||t(),this.subscriber.once(C.resubscribed,()=>{t()})}),await Promise.race([new Promise(async(t,i)=>{await B(this.provider.connect(),1e4,"socket stalled").catch(s=>i(s)).then(()=>t()).finally(()=>this.removeListener(g.transport_closed,this.rejectTransportOpen))}),new Promise(t=>this.once(g.transport_closed,this.rejectTransportOpen))])])}catch(t){this.logger.error(t);const i=t;if(!this.isConnectionStalled(i.message))throw t;this.events.emit(g.transport_closed)}finally{this.reconnecting=!1}}}async restartTransport(e){this.transportExplicitlyClosed||this.reconnecting||(this.relayUrl=e||this.relayUrl,this.connected&&await Promise.all([new Promise(t=>{this.provider.once(U.disconnect,()=>{t()})}),this.transportClose()]),await this.createProvider(),await this.transportOpen())}isConnectionStalled(e){return this.staleConnectionErrors.some(t=>e.includes(t))}rejectTransportOpen(){throw new Error("closeTransport called before connection was established")}async createProvider(){const e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new Ti(new Ai(ui({sdkVersion:ht,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0}))),this.registerProviderListeners()}async recordMessageEvent(e){const{topic:t,message:i}=e;await this.messages.set(t,i)}async shouldIgnoreMessageEvent(e){const{topic:t,message:i}=e;return await this.subscriber.isSubscribed(t)?this.messages.has(t,i):!0}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),Ce(e)){if(!e.method.endsWith(at))return;const t=e.params,{topic:i,message:s,publishedAt:n}=t.data,a={topic:i,message:s,publishedAt:n};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(mr({type:"event",event:t.id},a)),this.events.emit(t.id,a),await this.acknowledgePayload(e),await this.onMessageEvent(a)}else _e(e)&&this.events.emit(g.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(this.events.emit(g.message,e),await this.recordMessageEvent(e))}async acknowledgePayload(e){const t=Re(e.id,!0);await this.provider.connection.send(t)}registerProviderListeners(){this.provider.on(U.payload,e=>this.onProviderPayload(e)),this.provider.on(U.connect,()=>{this.events.emit(g.connect)}),this.provider.on(U.disconnect,()=>{this.onProviderDisconnect()}),this.provider.on(U.error,e=>{this.logger.error(e),this.events.emit(g.error,e)})}registerEventListeners(){this.events.on(g.connection_stalled,async()=>{await this.restartTransport()})}onProviderDisconnect(){this.events.emit(g.disconnect),this.attemptToReconnect()}attemptToReconnect(){this.transportExplicitlyClosed||setTimeout(async()=>{await this.restartTransport()},V(ot))}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(!this.connected){if(this.connecting)return await new Promise(e=>{const t=setInterval(()=>{this.connected&&(clearInterval(t),e())},this.connectionStatusPollingInterval)});await this.restartTransport()}}}var fr=Object.defineProperty,Pt=Object.getOwnPropertySymbols,Er=Object.prototype.hasOwnProperty,wr=Object.prototype.propertyIsEnumerable,xt=(r,e,t)=>e in r?fr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Ot=(r,e)=>{for(var t in e||(e={}))Er.call(e,t)&&xt(r,t,e[t]);if(Pt)for(var t of Pt(e))wr.call(e,t)&&xt(r,t,e[t]);return r};class At extends Yt{constructor(e,t,i,s=x,n=void 0){super(e,t,i,s),this.core=e,this.logger=t,this.name=i,this.map=new Map,this.version=ut,this.cached=[],this.initialized=!1,this.storagePrefix=x,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(a=>{this.getKey&&a!==null&&!ee(a)?this.map.set(this.getKey(a),a):li(a)?this.map.set(a.id,a):di(a)&&this.map.set(a.topic,a)}),this.cached=[],this.initialized=!0)},this.set=async(a,o)=>{this.isInitialized(),this.map.has(a)?await this.update(a,o):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:a,value:o}),this.map.set(a,o),await this.persist())},this.get=a=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:a}),this.getData(a)),this.getAll=a=>(this.isInitialized(),a?this.values.filter(o=>Object.keys(a).every(h=>zi(o[h],a[h]))):this.values),this.update=async(a,o)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:a,update:o});const h=Ot(Ot({},this.getData(a)),o);this.map.set(a,h),await this.persist()},this.delete=async(a,o)=>{this.isInitialized(),this.map.has(a)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:a,reason:o}),this.map.delete(a),await this.persist())},this.logger=f(t,this.name),this.storagePrefix=s,this.getKey=n}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){const t=this.map.get(e);if(!t){const{message:i}=c("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(i),new Error(i)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{const e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){const{message:t}=c("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class zt{constructor(e,t){this.core=e,this.logger=t,this.name=pt,this.version=Dt,this.events=new Kt,this.initialized=!1,this.storagePrefix=x,this.ignoredPayloadTypes=[gi],this.registeredMethods=[],this.init=async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))},this.register=({methods:i})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...i])]},this.create=async()=>{this.isInitialized();const i=W(),s=await this.core.crypto.setSymKey(i),n=te(Ie),a={protocol:st},o={topic:s,expiry:n,relay:a,active:!1},h=pi({protocol:this.core.protocol,version:this.core.version,topic:s,symKey:i,relay:a});return await this.pairings.set(s,o),await this.core.relayer.subscribe(s),this.core.expirer.set(s,n),{topic:s,uri:h}},this.pair=async i=>{this.isInitialized(),this.isValidPair(i);const{topic:s,symKey:n,relay:a}=Di(i.uri);if(this.pairings.keys.includes(s))throw new Error(`Pairing already exists: ${s}`);if(this.core.crypto.hasKeys(s))throw new Error(`Keychain already exists: ${s}`);const o=te(Ie),h={topic:s,relay:a,expiry:o,active:!1};return await this.pairings.set(s,h),await this.core.crypto.setSymKey(n,s),await this.core.relayer.subscribe(s,{relay:a}),this.core.expirer.set(s,o),i.activatePairing&&await this.activate({topic:s}),h},this.activate=async({topic:i})=>{this.isInitialized();const s=te(re);await this.pairings.update(i,{active:!0,expiry:s}),this.core.expirer.set(i,s)},this.ping=async i=>{this.isInitialized(),await this.isValidPing(i);const{topic:s}=i;if(this.pairings.keys.includes(s)){const n=await this.sendRequest(s,"wc_pairingPing",{}),{done:a,resolve:o,reject:h}=yi();this.events.once(ie("pairing_ping",n),({error:d})=>{d?h(d):o()}),await a()}},this.updateExpiry=async({topic:i,expiry:s})=>{this.isInitialized(),await this.pairings.update(i,{expiry:s})},this.updateMetadata=async({topic:i,metadata:s})=>{this.isInitialized(),await this.pairings.update(i,{peerMetadata:s})},this.getPairings=()=>(this.isInitialized(),this.pairings.values),this.disconnect=async i=>{this.isInitialized(),await this.isValidDisconnect(i);const{topic:s}=i;this.pairings.keys.includes(s)&&(await this.sendRequest(s,"wc_pairingDelete",F("USER_DISCONNECTED")),await this.deletePairing(s))},this.sendRequest=async(i,s,n)=>{const a=Se(s,n),o=await this.core.crypto.encode(i,a),h=L[s].req;return this.core.history.set(i,a),this.core.relayer.publish(i,o,h),a.id},this.sendResult=async(i,s,n)=>{const a=Re(i,n),o=await this.core.crypto.encode(s,a),h=await this.core.history.get(s,i),d=L[h.request.method].res;await this.core.relayer.publish(s,o,d),await this.core.history.resolve(a)},this.sendError=async(i,s,n)=>{const a=xi(i,n),o=await this.core.crypto.encode(s,a),h=await this.core.history.get(s,i),d=L[h.request.method]?L[h.request.method].res:L.unregistered_method.res;await this.core.relayer.publish(s,o,d),await this.core.history.resolve(a)},this.deletePairing=async(i,s)=>{await this.core.relayer.unsubscribe(i),await Promise.all([this.pairings.delete(i,F("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(i),s?Promise.resolve():this.core.expirer.del(i)])},this.cleanup=async()=>{const i=this.pairings.getAll().filter(s=>fe(s.expiry));await Promise.all(i.map(s=>this.deletePairing(s.topic)))},this.onRelayEventRequest=i=>{const{topic:s,payload:n}=i,a=n.method;if(this.pairings.keys.includes(s))switch(a){case"wc_pairingPing":return this.onPairingPingRequest(s,n);case"wc_pairingDelete":return this.onPairingDeleteRequest(s,n);default:return this.onUnknownRpcMethodRequest(s,n)}},this.onRelayEventResponse=async i=>{const{topic:s,payload:n}=i,a=(await this.core.history.get(s,n.id)).request.method;if(this.pairings.keys.includes(s))switch(a){case"wc_pairingPing":return this.onPairingPingResponse(s,n);default:return this.onUnknownRpcMethodResponse(a)}},this.onPairingPingRequest=async(i,s)=>{const{id:n}=s;try{this.isValidPing({topic:i}),await this.sendResult(n,i,!0),this.events.emit("pairing_ping",{id:n,topic:i})}catch(a){await this.sendError(n,i,a),this.logger.error(a)}},this.onPairingPingResponse=(i,s)=>{const{id:n}=s;setTimeout(()=>{Oi(s)?this.events.emit(ie("pairing_ping",n),{}):Te(s)&&this.events.emit(ie("pairing_ping",n),{error:s.error})},500)},this.onPairingDeleteRequest=async(i,s)=>{const{id:n}=s;try{this.isValidDisconnect({topic:i}),await this.deletePairing(i),this.events.emit("pairing_delete",{id:n,topic:i})}catch(a){await this.sendError(n,i,a),this.logger.error(a)}},this.onUnknownRpcMethodRequest=async(i,s)=>{const{id:n,method:a}=s;try{if(this.registeredMethods.includes(a))return;const o=F("WC_METHOD_UNSUPPORTED",a);await this.sendError(n,i,o),this.logger.error(o)}catch(o){await this.sendError(n,i,o),this.logger.error(o)}},this.onUnknownRpcMethodResponse=i=>{this.registeredMethods.includes(i)||this.logger.error(F("WC_METHOD_UNSUPPORTED",i))},this.isValidPair=i=>{if(!se(i)){const{message:s}=c("MISSING_OR_INVALID",`pair() params: ${i}`);throw new Error(s)}if(!bi(i.uri)){const{message:s}=c("MISSING_OR_INVALID",`pair() uri: ${i.uri}`);throw new Error(s)}},this.isValidPing=async i=>{if(!se(i)){const{message:n}=c("MISSING_OR_INVALID",`ping() params: ${i}`);throw new Error(n)}const{topic:s}=i;await this.isValidPairingTopic(s)},this.isValidDisconnect=async i=>{if(!se(i)){const{message:n}=c("MISSING_OR_INVALID",`disconnect() params: ${i}`);throw new Error(n)}const{topic:s}=i;await this.isValidPairingTopic(s)},this.isValidPairingTopic=async i=>{if(!mi(i,!1)){const{message:s}=c("MISSING_OR_INVALID",`pairing topic should be a string: ${i}`);throw new Error(s)}if(!this.pairings.keys.includes(i)){const{message:s}=c("NO_MATCHING_KEY",`pairing topic doesn't exist: ${i}`);throw new Error(s)}if(fe(this.pairings.get(i).expiry)){await this.deletePairing(i);const{message:s}=c("EXPIRED",`pairing topic: ${i}`);throw new Error(s)}},this.core=e,this.logger=f(t,this.name),this.pairings=new At(this.core,this.logger,this.name,this.storagePrefix)}get context(){return E(this.logger)}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(g.message,async e=>{const{topic:t,message:i}=e;if(this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(i)))return;const s=await this.core.crypto.decode(t,i);Ce(s)?(this.core.history.set(t,s),this.onRelayEventRequest({topic:t,payload:s})):_e(s)&&(await this.core.history.resolve(s),this.onRelayEventResponse({topic:t,payload:s}))})}registerExpirerEvents(){this.core.expirer.on(w.expired,async e=>{const{topic:t}=fi(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit("pairing_expire",{topic:t}))})}}class Nt extends Jt{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.records=new Map,this.events=new z,this.name=yt,this.version=bt,this.cached=[],this.initialized=!1,this.storagePrefix=x,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.records.set(i.id,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.set=(i,s,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:i,request:s,chainId:n}),this.records.has(s.id))return;const a={id:s.id,topic:i,request:{method:s.method,params:s.params||null},chainId:n};this.records.set(a.id,a),this.events.emit(_.created,a)},this.resolve=async i=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:i}),!this.records.has(i.id))return;const s=await this.getRecord(i.id);typeof s.response>"u"&&(s.response=Te(i)?{error:i.error}:{result:i.result},this.records.set(s.id,s),this.events.emit(_.updated,s))},this.get=async(i,s)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:i,id:s}),await this.getRecord(s)),this.delete=(i,s)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:s}),this.values.forEach(n=>{if(n.topic===i){if(typeof s<"u"&&n.id!==s)return;this.records.delete(n.id),this.events.emit(_.deleted,n)}})},this.exists=async(i,s)=>(this.isInitialized(),this.records.has(s)?(await this.getRecord(s)).topic===i:!1),this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.logger=f(t,this.name)}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){const e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;const i={topic:t.topic,request:Se(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(i)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();const t=this.records.get(e);if(!t){const{message:i}=c("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(_.sync)}async restore(){try{const e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){const{message:t}=c("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(_.created,e=>{const t=_.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()}),this.events.on(_.updated,e=>{const t=_.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()}),this.events.on(_.deleted,e=>{const t=_.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Ut extends Ht{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.expirations=new Map,this.events=new z,this.name=mt,this.version=ft,this.cached=[],this.initialized=!1,this.storagePrefix=x,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.expirations.set(i.target,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.has=i=>{try{const s=this.formatTarget(i);return typeof this.getExpiration(s)<"u"}catch{return!1}},this.set=(i,s)=>{this.isInitialized();const n=this.formatTarget(i),a={target:n,expiry:s};this.expirations.set(n,a),this.checkExpiry(n,a),this.events.emit(w.created,{target:n,expiration:a})},this.get=i=>{this.isInitialized();const s=this.formatTarget(i);return this.getExpiration(s)},this.del=i=>{if(this.isInitialized(),this.has(i)){const s=this.formatTarget(i),n=this.getExpiration(s);this.expirations.delete(s),this.events.emit(w.deleted,{target:s,expiration:n})}},this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.logger=f(t,this.name)}get context(){return E(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return Ei(e);if(typeof e=="number")return wi(e);const{message:t}=c("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(w.sync)}async restore(){try{const e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){const{message:t}=c("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){const t=this.expirations.get(e);if(!t){const{message:i}=c("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(i),new Error(i)}return t}checkExpiry(e,t){const{expiry:i}=t;V(i)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit(w.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(X.pulse,()=>this.checkExpirations()),this.events.on(w.created,e=>{const t=w.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(w.expired,e=>{const t=w.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(w.deleted,e=>{const t=w.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=c("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Lt extends Xt{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,this.name=Y,this.initialized=!1,this.init=async i=>{vi()||!Ii()||(this.verifyUrl=i?.verifyUrl||le,await this.createIframe())},this.register=async i=>{var s;this.initialized||await this.init(),this.iframe&&((s=this.iframe.contentWindow)==null||s.postMessage(i.attestationId,this.verifyUrl),this.logger.info(`postMessage sent: ${i.attestationId} ${this.verifyUrl}`))},this.resolve=async i=>{var s;if(this.isDevEnv)return"";this.logger.info(`resolving attestation: ${i.attestationId}`);const n=this.startAbortTimer(we),a=await fetch(`${this.verifyUrl}/attestation/${i.attestationId}`,{signal:this.abortController.signal});return clearTimeout(n),a.status===200?(s=await a.json())==null?void 0:s.origin:""},this.createIframe=async()=>{try{await Promise.race([new Promise((i,s)=>{if(document.getElementById(Y))return i();const n=document.createElement("iframe");n.setAttribute("id",Y),n.setAttribute("src",`${this.verifyUrl}/${this.projectId}`),n.style.display="none",n.addEventListener("load",()=>{this.initialized=!0,i()}),n.addEventListener("error",a=>{s(a)}),document.body.append(n),this.iframe=n}),new Promise(i=>{setTimeout(()=>i("iframe load timeout"),V(Ee/2))})])}catch(i){this.logger.error(`Verify iframe failed to load: ${this.verifyUrl}`),this.logger.error(i)}},this.logger=f(t,this.name),this.verifyUrl=le,this.abortController=new AbortController,this.isDevEnv=Ci()&&process.env.IS_VITEST}get context(){return E(this.logger)}startAbortTimer(e){return setTimeout(()=>this.abortController.abort(),V(e))}}var vr=Object.defineProperty,Ft=Object.getOwnPropertySymbols,Ir=Object.prototype.hasOwnProperty,Cr=Object.prototype.propertyIsEnumerable,$t=(r,e,t)=>e in r?vr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Mt=(r,e)=>{for(var t in e||(e={}))Ir.call(e,t)&&$t(r,t,e[t]);if(Ft)for(var t of Ft(e))Cr.call(e,t)&&$t(r,t,e[t]);return r};class J extends Wt{constructor(e){super(e),this.protocol=he,this.version=Ge,this.name=G,this.events=new z,this.initialized=!1,this.on=(i,s)=>this.events.on(i,s),this.once=(i,s)=>this.events.once(i,s),this.off=(i,s)=>this.events.off(i,s),this.removeListener=(i,s)=>this.events.removeListener(i,s),this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||ue;const t=typeof e?.logger<"u"&&typeof e?.logger!="string"?e.logger:ge(pe({level:e?.logger||Ye.logger}));this.logger=f(t,this.name),this.heartbeat=new Bt,this.crypto=new wt(this,this.logger,e?.keychain),this.history=new Nt(this,this.logger),this.expirer=new Ut(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new kt(Mt(Mt({},Je),e?.storageOptions)),this.relayer=new Tt({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new zt(this,this.logger),this.verify=new Lt(this.projectId||"",this.logger)}static async init(e){const t=new J(e);return await t.initialize(),t}get context(){return E(this.logger)}async start(){this.initialized||await this.initialize()}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}}const _r=J;export{G as CORE_CONTEXT,Ye as CORE_DEFAULT,he as CORE_PROTOCOL,Je as CORE_STORAGE_OPTIONS,x as CORE_STORAGE_PREFIX,Ge as CORE_VERSION,ce as CRYPTO_CLIENT_SEED,He as CRYPTO_CONTEXT,Xe as CRYPTO_JWT_TTL,_r as Core,wt as Crypto,mt as EXPIRER_CONTEXT,or as EXPIRER_DEFAULT_TTL,w as EXPIRER_EVENTS,ft as EXPIRER_STORAGE_VERSION,Ut as Expirer,yt as HISTORY_CONTEXT,_ as HISTORY_EVENTS,bt as HISTORY_STORAGE_VERSION,Nt as JsonRpcHistory,We as KEYCHAIN_CONTEXT,Ze as KEYCHAIN_STORAGE_VERSION,Et as KeyChain,Qe as MESSAGES_CONTEXT,et as MESSAGES_STORAGE_VERSION,vt as MessageTracker,pt as PAIRING_CONTEXT,ar as PAIRING_DEFAULT_TTL,L as PAIRING_RPC_OPTS,Dt as PAIRING_STORAGE_VERSION,gt as PENDING_SUB_RESOLUTION_TIMEOUT,it as PUBLISHER_CONTEXT,tt as PUBLISHER_DEFAULT_TTL,zt as Pairing,nt as RELAYER_CONTEXT,rt as RELAYER_DEFAULT_LOGGER,st as RELAYER_DEFAULT_PROTOCOL,ue as RELAYER_DEFAULT_RELAY_URL,g as RELAYER_EVENTS,U as RELAYER_PROVIDER_EVENTS,ot as RELAYER_RECONNECT_TIMEOUT,ht as RELAYER_SDK_VERSION,rr as RELAYER_STORAGE_OPTIONS,at as RELAYER_SUBSCRIBER_SUFFIX,ct as RELAYER_TRANSPORT_CUTOFF,Tt as Relayer,ut as STORE_STORAGE_VERSION,lt as SUBSCRIBER_CONTEXT,nr as SUBSCRIBER_DEFAULT_TTL,C as SUBSCRIBER_EVENTS,dt as SUBSCRIBER_STORAGE_VERSION,At as Store,_t as Subscriber,Y as VERIFY_CONTEXT,le as VERIFY_SERVER,Lt as Verify,J as default};
 //# sourceMappingURL=index.es.js.map
diff --git a/dist/index.umd.js b/dist/index.umd.js
index b821fed3b35533325693890f19f94e3c6b733fd8..794049db0b96d691d7bf6b52bf67b605082895ae 100644
--- a/dist/index.umd.js
+++ b/dist/index.umd.js
@@ -63,5 +63,5 @@
 	LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
 	OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
 	PERFORMANCE OF THIS SOFTWARE.
-	***************************************************************************** */var Jn=function(t,e){return Jn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var i in n)n.hasOwnProperty(i)&&(r[i]=n[i])},Jn(t,e)};function zd(t,e){Jn(t,e);function r(){this.constructor=t}t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}var Zn=function(){return Zn=Object.assign||function(e){for(var r,n=1,i=arguments.length;n<i;n++){r=arguments[n];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},Zn.apply(this,arguments)};function Hd(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(t);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(t,n[i])&&(r[n[i]]=t[n[i]]);return r}function Kd(t,e,r,n){var i=arguments.length,s=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(t,e,r,n);else for(var u=t.length-1;u>=0;u--)(c=t[u])&&(s=(i<3?c(s):i>3?c(e,r,s):c(e,r))||s);return i>3&&s&&Object.defineProperty(e,r,s),s}function Gd(t,e){return function(r,n){e(r,n,t)}}function Vd(t,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(t,e)}function qd(t,e,r,n){function i(s){return s instanceof r?s:new r(function(c){c(s)})}return new(r||(r=Promise))(function(s,c){function u(_){try{f(n.next(_))}catch(O){c(O)}}function h(_){try{f(n.throw(_))}catch(O){c(O)}}function f(_){_.done?s(_.value):i(_.value).then(u,h)}f((n=n.apply(t,e||[])).next())})}function Yd(t,e){var r={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,c;return c={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function u(f){return function(_){return h([f,_])}}function h(f){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(s=f[0]&2?i.return:f[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,f[1])).done)return s;switch(i=0,s&&(f=[f[0]&2,s.value]),f[0]){case 0:case 1:s=f;break;case 4:return r.label++,{value:f[1],done:!1};case 5:r.label++,i=f[1],f=[0];continue;case 7:f=r.ops.pop(),r.trys.pop();continue;default:if(s=r.trys,!(s=s.length>0&&s[s.length-1])&&(f[0]===6||f[0]===2)){r=0;continue}if(f[0]===3&&(!s||f[1]>s[0]&&f[1]<s[3])){r.label=f[1];break}if(f[0]===6&&r.label<s[1]){r.label=s[1],s=f;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(f);break}s[2]&&r.ops.pop(),r.trys.pop();continue}f=e.call(t,r)}catch(_){f=[6,_],i=0}finally{n=s=0}if(f[0]&5)throw f[1];return{value:f[0]?f[1]:void 0,done:!0}}}function Wd(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}function Xd(t,e){for(var r in t)r!=="default"&&!e.hasOwnProperty(r)&&(e[r]=t[r])}function Qn(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Ho(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var n=r.call(t),i,s=[],c;try{for(;(e===void 0||e-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(u){c={error:u}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(c)throw c.error}}return s}function kd(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(Ho(arguments[e]));return t}function Jd(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;for(var n=Array(t),i=0,e=0;e<r;e++)for(var s=arguments[e],c=0,u=s.length;c<u;c++,i++)n[i]=s[c];return n}function _r(t){return this instanceof _r?(this.v=t,this):new _r(t)}function Zd(t,e,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(t,e||[]),i,s=[];return i={},c("next"),c("throw"),c("return"),i[Symbol.asyncIterator]=function(){return this},i;function c(p){n[p]&&(i[p]=function(E){return new Promise(function(A,C){s.push([p,E,A,C])>1||u(p,E)})})}function u(p,E){try{h(n[p](E))}catch(A){O(s[0][3],A)}}function h(p){p.value instanceof _r?Promise.resolve(p.value.v).then(f,_):O(s[0][2],p)}function f(p){u("next",p)}function _(p){u("throw",p)}function O(p,E){p(E),s.shift(),s.length&&u(s[0][0],s[0][1])}}function Qd(t){var e,r;return e={},n("next"),n("throw",function(i){throw i}),n("return"),e[Symbol.iterator]=function(){return this},e;function n(i,s){e[i]=t[i]?function(c){return(r=!r)?{value:_r(t[i](c)),done:i==="return"}:s?s(c):c}:s}}function e0(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=t[Symbol.asyncIterator],r;return e?e.call(t):(t=typeof Qn=="function"?Qn(t):t[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(s){r[s]=t[s]&&function(c){return new Promise(function(u,h){c=t[s](c),i(u,h,c.done,c.value)})}}function i(s,c,u,h){Promise.resolve(h).then(function(f){s({value:f,done:u})},c)}}function t0(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t}function r0(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)Object.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e.default=t,e}function n0(t){return t&&t.__esModule?t:{default:t}}function i0(t,e){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return e.get(t)}function s0(t,e,r){if(!e.has(t))throw new TypeError("attempted to set private field on non-instance");return e.set(t,r),r}var o0=Object.freeze({__proto__:null,__extends:zd,get __assign(){return Zn},__rest:Hd,__decorate:Kd,__param:Gd,__metadata:Vd,__awaiter:qd,__generator:Yd,__createBinding:Wd,__exportStar:Xd,__values:Qn,__read:Ho,__spread:kd,__spreadArrays:Jd,__await:_r,__asyncGenerator:Zd,__asyncDelegator:Qd,__asyncValues:e0,__makeTemplateObject:t0,__importStar:r0,__importDefault:n0,__classPrivateFieldGet:i0,__classPrivateFieldSet:s0}),a0=Rt(o0),Et={},Ko;function c0(){if(Ko)return Et;Ko=1,Object.defineProperty(Et,"__esModule",{value:!0}),Et.isBrowserCryptoAvailable=Et.getSubtleCrypto=Et.getBrowerCrypto=void 0;function t(){return Je?.crypto||Je?.msCrypto||{}}Et.getBrowerCrypto=t;function e(){const n=t();return n.subtle||n.webkitSubtle}Et.getSubtleCrypto=e;function r(){return!!t()&&!!e()}return Et.isBrowserCryptoAvailable=r,Et}var wt={},Go;function u0(){if(Go)return wt;Go=1,Object.defineProperty(wt,"__esModule",{value:!0}),wt.isBrowser=wt.isNode=wt.isReactNative=void 0;function t(){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"}wt.isReactNative=t;function e(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}wt.isNode=e;function r(){return!t()&&!e()}return wt.isBrowser=r,wt}(function(t){Object.defineProperty(t,"__esModule",{value:!0});const e=a0;e.__exportStar(c0(),t),e.__exportStar(u0(),t)})(zo);function Vo(t=3){const e=Date.now()*Math.pow(10,t),r=Math.floor(Math.random()*Math.pow(10,t));return e+r}function qo(t=6){return BigInt(Vo(t))}function ei(t,e,r){return{id:r||Vo(),jsonrpc:"2.0",method:t,params:e}}function Yo(t,e){return{id:t,jsonrpc:"2.0",result:e}}function Wo(t,e,r){return{id:t,jsonrpc:"2.0",error:f0(e,r)}}function f0(t,e){return typeof t>"u"?Bo($o):(typeof t=="string"&&(t=Object.assign(Object.assign({},Bo(kn)),{message:t})),typeof e<"u"&&(t.data=e),$d(t.code)&&(t=Fd(t.code)),t)}class h0{}class l0 extends h0{constructor(){super()}}class d0 extends l0{constructor(e){super()}}const g0="^wss?:";function _0(t){const e=t.match(new RegExp(/^\w+:/,"gi"));if(!(!e||!e.length))return e[0]}function y0(t,e){const r=_0(t);return typeof r>"u"?!1:new RegExp(e).test(r)}function Xo(t){return y0(t,g0)}function p0(t){return new RegExp("wss?://localhost(:d{2,5})?").test(t)}function ko(t){return typeof t=="object"&&"id"in t&&"jsonrpc"in t&&t.jsonrpc==="2.0"}function Jo(t){return ko(t)&&"method"in t}function ti(t){return ko(t)&&(Zo(t)||Br(t))}function Zo(t){return"result"in t}function Br(t){return"error"in t}class b0 extends d0{constructor(e){super(e),this.events=new ut.exports.EventEmitter,this.hasRegisteredEventListeners=!1,this.connection=this.setConnection(e),this.connection.connected&&this.registerEventListeners()}async connect(e=this.connection){await this.open(e)}async disconnect(){await this.close()}on(e,r){this.events.on(e,r)}once(e,r){this.events.once(e,r)}off(e,r){this.events.off(e,r)}removeListener(e,r){this.events.removeListener(e,r)}async request(e,r){return this.requestStrict(ei(e.method,e.params||[],e.id||qo().toString()),r)}async requestStrict(e,r){return new Promise(async(n,i)=>{if(!this.connection.connected)try{await this.open()}catch(s){i(s)}this.events.on(`${e.id}`,s=>{Br(s)?i(s.error):n(s.result)});try{await this.connection.send(e,r)}catch(s){i(s)}})}setConnection(e=this.connection){return e}onPayload(e){this.events.emit("payload",e),ti(e)?this.events.emit(`${e.id}`,e):this.events.emit("message",{type:e.method,data:e.params})}onClose(e){e&&e.code===3e3&&this.events.emit("error",new Error(`WebSocket connection closed abnormally with code: ${e.code} ${e.reason?`(${e.reason})`:""}`)),this.events.emit("disconnect")}async open(e=this.connection){this.connection===e&&this.connection.connected||(this.connection.connected&&this.close(),typeof e=="string"&&(await this.connection.open(e),e=this.connection),this.connection=this.setConnection(e),await this.connection.open(),this.registerEventListeners(),this.events.emit("connect"))}async close(){await this.connection.close()}registerEventListeners(){this.hasRegisteredEventListeners||(this.connection.on("payload",e=>this.onPayload(e)),this.connection.on("close",e=>this.onClose(e)),this.connection.on("error",e=>this.events.emit("error",e)),this.connection.on("register_error",e=>this.onClose()),this.hasRegisteredEventListeners=!0)}}const Qo=10,v0=()=>typeof global<"u"&&typeof global.WebSocket<"u"?global.WebSocket:typeof window<"u"&&typeof window.WebSocket<"u"?window.WebSocket:require("ws"),E0=()=>typeof window<"u",w0=v0();class m0{constructor(e){if(this.url=e,this.events=new ut.exports.EventEmitter,this.registering=!1,!Xo(e))throw new Error(`Provided URL is not compatible with WebSocket connection: ${e}`);this.url=e}get connected(){return typeof this.socket<"u"}get connecting(){return this.registering}on(e,r){this.events.on(e,r)}once(e,r){this.events.once(e,r)}off(e,r){this.events.off(e,r)}removeListener(e,r){this.events.removeListener(e,r)}async open(e=this.url){await this.register(e)}async close(){return new Promise((e,r)=>{if(typeof this.socket>"u"){r(new Error("Connection already closed"));return}this.socket.onclose=n=>{this.onClose(n),e()},this.socket.close()})}async send(e,r){typeof this.socket>"u"&&(this.socket=await this.register());try{this.socket.send(pn(e))}catch(n){this.onError(e.id,n)}}register(e=this.url){if(!Xo(e))throw new Error(`Provided URL is not compatible with WebSocket connection: ${e}`);if(this.registering){const r=this.events.getMaxListeners();return(this.events.listenerCount("register_error")>=r||this.events.listenerCount("open")>=r)&&this.events.setMaxListeners(r+1),new Promise((n,i)=>{this.events.once("register_error",s=>{this.resetMaxListeners(),i(s)}),this.events.once("open",()=>{if(this.resetMaxListeners(),typeof this.socket>"u")return i(new Error("WebSocket connection is missing or invalid"));n(this.socket)})})}return this.url=e,this.registering=!0,new Promise((r,n)=>{const i=zo.isReactNative()?void 0:{rejectUnauthorized:!p0(e)},s=new w0(e,[],i);E0()?s.onerror=c=>{const u=c;n(this.emitError(u.error))}:s.on("error",c=>{n(this.emitError(c))}),s.onopen=()=>{this.onOpen(s),r(s)}})}onOpen(e){e.onmessage=r=>this.onPayload(r),e.onclose=r=>this.onClose(r),this.socket=e,this.registering=!1,this.events.emit("open")}onClose(e){this.socket=void 0,this.registering=!1,this.events.emit("close",e)}onPayload(e){if(typeof e.data>"u")return;const r=typeof e.data=="string"?Wi(e.data):e.data;this.events.emit("payload",r)}onError(e,r){const n=this.parseError(r),i=n.message||n.toString(),s=Wo(e,i);this.events.emit("payload",s)}parseError(e,r=this.url){return Bd(e,r,"WS")}resetMaxListeners(){this.events.getMaxListeners()>Qo&&this.events.setMaxListeners(Qo)}emitError(e){const r=this.parseError(new Error(e?.message||`WebSocket connection failed for URL: ${this.url}`));return this.events.emit("register_error",r),r}}class D0 extends Nu{constructor(e,r){super(e,r),this.relayer=e,this.logger=r,this.events=new ut.exports.EventEmitter,this.name=po,this.queue=new Map,this.publishTimeout=1e4,this.publish=async(n,i,s)=>{this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:n,message:i,opts:s}});try{const c=s?.ttl||yo,u=Gn(s),h=s?.prompt||!1,f=s?.tag||0,_=s?.id||qo().toString(),O={topic:n,message:i,opts:{ttl:c,relay:u,prompt:h,tag:f,id:_}};this.queue.set(_,O);try{await await Ur(this.rpcPublish(n,i,c,u,h,f,_),this.publishTimeout),this.relayer.events.emit(ze.publish,O)}catch{this.logger.debug("Publishing Payload stalled"),this.relayer.events.emit(ze.connection_stalled);return}this.logger.debug("Successfully Published Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:n,message:i,opts:s}})}catch(c){throw this.logger.debug("Failed to Publish Payload"),this.logger.error(c),c}},this.on=(n,i)=>{this.events.on(n,i)},this.once=(n,i)=>{this.events.once(n,i)},this.off=(n,i)=>{this.events.off(n,i)},this.removeListener=(n,i)=>{this.events.removeListener(n,i)},this.relayer=e,this.logger=Se.generateChildLogger(r,this.name),this.registerEventListeners()}get context(){return Se.getLoggerContext(this.logger)}rpcPublish(e,r,n,i,s,c,u){var h,f,_,O;const p={method:Mr(i.protocol).publish,params:{topic:e,message:r,ttl:n,prompt:s,tag:c},id:u};return jr((h=p.params)==null?void 0:h.prompt)&&((f=p.params)==null||delete f.prompt),jr((_=p.params)==null?void 0:_.tag)&&((O=p.params)==null||delete O.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:p}),this.relayer.request(p)}onPublish(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async e=>{const{topic:r,message:n,opts:i}=e;await this.publish(r,n,i)})}registerEventListeners(){this.relayer.core.heartbeat.on(er.HEARTBEAT_EVENTS.pulse,()=>{this.checkQueue()}),this.relayer.on(ze.message_ack,e=>{this.onPublish(e.id.toString())})}}class S0{constructor(){this.map=new Map,this.set=(e,r)=>{const n=this.get(e);this.exists(e,r)||this.map.set(e,[...n,r])},this.get=e=>this.map.get(e)||[],this.exists=(e,r)=>this.get(e).includes(r),this.delete=(e,r)=>{if(typeof r>"u"){this.map.delete(e);return}if(!this.map.has(e))return;const n=this.get(e);if(!this.exists(e,r))return;const i=n.filter(s=>s!==r);if(!i.length){this.map.delete(e);return}this.map.set(e,i)},this.clear=()=>{this.map.clear()}}get topics(){return Array.from(this.map.keys())}}var O0=Object.defineProperty,x0=Object.defineProperties,T0=Object.getOwnPropertyDescriptors,ea=Object.getOwnPropertySymbols,I0=Object.prototype.hasOwnProperty,R0=Object.prototype.propertyIsEnumerable,ta=(t,e,r)=>e in t?O0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,yr=(t,e)=>{for(var r in e||(e={}))I0.call(e,r)&&ta(t,r,e[r]);if(ea)for(var r of ea(e))R0.call(e,r)&&ta(t,r,e[r]);return t},ri=(t,e)=>x0(t,T0(e));class ra extends ju{constructor(e,r){super(e,r),this.relayer=e,this.logger=r,this.subscriptions=new Map,this.topicMap=new S0,this.events=new ut.exports.EventEmitter,this.name=xo,this.version=To,this.pending=new Map,this.cached=[],this.initialized=!1,this.pendingSubscriptionWatchLabel="pending_sub_watch_label",this.pollingInterval=20,this.storagePrefix=vt,this.subscribeTimeout=1e4,this.restartInProgress=!1,this.batchSubscribeTopicsLimit=500,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restart(),this.registerEventListeners(),this.onEnable(),this.clientId=await this.relayer.core.crypto.getClientId())},this.subscribe=async(n,i)=>{await this.restartToComplete(),this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:n,opts:i}});try{const s=Gn(i),c={topic:n,relay:s};this.pending.set(n,c);const u=await this.rpcSubscribe(n,s);return this.onSubscribe(u,c),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:n,opts:i}}),u}catch(s){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(s),s}},this.unsubscribe=async(n,i)=>{await this.restartToComplete(),this.isInitialized(),typeof i?.id<"u"?await this.unsubscribeById(n,i.id,i):await this.unsubscribeByTopic(n,i)},this.isSubscribed=async n=>this.topics.includes(n)?!0:await new Promise((i,s)=>{const c=new ye.Watch;c.start(this.pendingSubscriptionWatchLabel);const u=setInterval(()=>{!this.pending.has(n)&&this.topics.includes(n)&&(clearInterval(u),c.stop(this.pendingSubscriptionWatchLabel),i(!0)),c.elapsed(this.pendingSubscriptionWatchLabel)>=Io&&(clearInterval(u),c.stop(this.pendingSubscriptionWatchLabel),s(new Error("Subscription resolution timeout")))},this.pollingInterval)}).catch(()=>!1),this.on=(n,i)=>{this.events.on(n,i)},this.once=(n,i)=>{this.events.once(n,i)},this.off=(n,i)=>{this.events.off(n,i)},this.removeListener=(n,i)=>{this.events.removeListener(n,i)},this.restart=async()=>{this.restartInProgress=!0,await this.restore(),await this.reset(),this.restartInProgress=!1},this.relayer=e,this.logger=Se.generateChildLogger(r,this.name),this.clientId=""}get context(){return Se.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}hasSubscription(e,r){let n=!1;try{n=this.getSubscription(e).topic===r}catch{}return n}onEnable(){this.cached=[],this.initialized=!0}onDisable(){this.cached=this.values,this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,r){const n=this.topicMap.get(e);await Promise.all(n.map(async i=>await this.unsubscribeById(e,i,r)))}async unsubscribeById(e,r,n){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:r,opts:n}});try{const i=Gn(n);await this.rpcUnsubscribe(e,r,i);const s=dr("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,r,s),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:r,opts:n}})}catch(i){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(i),i}}async rpcSubscribe(e,r){const n={method:Mr(r.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:n});try{await await Ur(this.relayer.request(n),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(ze.connection_stalled)}return Bn(e+this.clientId)}async rpcBatchSubscribe(e){if(!e.length)return;const r=e[0].relay,n={method:Mr(r.protocol).batchSubscribe,params:{topics:e.map(i=>i.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:n});try{return await await Ur(this.relayer.request(n),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Payload stalled"),this.relayer.events.emit(ze.connection_stalled)}}rpcUnsubscribe(e,r,n){const i={method:Mr(n.protocol).unsubscribe,params:{topic:e,id:r}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i}),this.relayer.request(i)}onSubscribe(e,r){this.setSubscription(e,ri(yr({},r),{id:e})),this.pending.delete(r.topic)}onBatchSubscribe(e){e.length&&e.forEach(r=>{this.setSubscription(r.id,yr({},r)),this.pending.delete(r.topic)})}async onUnsubscribe(e,r,n){this.events.removeAllListeners(r),this.hasSubscription(r,e)&&this.deleteSubscription(r,n),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,r){this.subscriptions.has(e)||(this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:r}),this.addSubscription(e,r))}addSubscription(e,r){this.subscriptions.set(e,yr({},r)),this.topicMap.set(r.topic,e),this.events.emit(dt.created,r)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});const r=this.subscriptions.get(e);if(!r){const{message:n}=Te("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(n)}return r}deleteSubscription(e,r){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:r});const n=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(n.topic,e),this.events.emit(dt.deleted,ri(yr({},n),{reason:r}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(dt.sync)}async reset(){if(this.cached.length){const e=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let r=0;r<e;r++){const n=this.cached.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(n)}}this.events.emit(dt.resubscribed)}async restore(){try{const e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){const{message:r}=Te("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(r),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(r)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){if(!e.length)return;const r=await this.rpcBatchSubscribe(e);Od(r)&&this.onBatchSubscribe(r.map((n,i)=>ri(yr({},e[i]),{id:n})))}async onConnect(){this.restartInProgress||(await this.restart(),this.onEnable())}onDisconnect(){this.onDisable()}async checkPending(){if(this.relayer.transportExplicitlyClosed)return;const e=[];this.pending.forEach(r=>{e.push(r)}),await this.batchSubscribe(e)}registerEventListeners(){this.relayer.core.heartbeat.on(er.HEARTBEAT_EVENTS.pulse,async()=>{await this.checkPending()}),this.relayer.on(ze.connect,async()=>{await this.onConnect()}),this.relayer.on(ze.disconnect,()=>{this.onDisconnect()}),this.events.on(dt.created,async e=>{const r=dt.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:e}),await this.persist()}),this.events.on(dt.deleted,async e=>{const r=dt.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:e}),await this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(){this.restartInProgress&&await new Promise(e=>{const r=setInterval(()=>{this.restartInProgress||(clearInterval(r),e())},this.pollingInterval)})}}var A0=Object.defineProperty,na=Object.getOwnPropertySymbols,C0=Object.prototype.hasOwnProperty,P0=Object.prototype.propertyIsEnumerable,ia=(t,e,r)=>e in t?A0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,L0=(t,e)=>{for(var r in e||(e={}))C0.call(e,r)&&ia(t,r,e[r]);if(na)for(var r of na(e))P0.call(e,r)&&ia(t,r,e[r]);return t};class sa extends Uu{constructor(e){super(e),this.protocol="wc",this.version=2,this.events=new ut.exports.EventEmitter,this.name=Eo,this.transportExplicitlyClosed=!1,this.initialized=!1,this.reconnecting=!1,this.connectionStatusPollingInterval=20,this.staleConnectionErrors=["socket hang up","socket stalled"],this.request=async r=>{this.logger.debug("Publishing Request Payload");try{return await this.toEstablishConnection(),await this.provider.request(r)}catch(n){throw this.logger.debug("Failed to Publish Request"),this.logger.error(n),n}},this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?Se.generateChildLogger(e.logger,this.name):Se.pino(Se.getDefaultLoggerOptions({level:e.logger||vo})),this.messages=new jo(this.logger,e.core),this.subscriber=new ra(this,this.logger),this.publisher=new D0(this,this.logger),this.relayUrl=e?.relayUrl||Wn,this.projectId=e.projectId,this.provider={}}async init(){this.logger.trace("Initialized"),await this.createProvider(),await Promise.all([this.messages.init(),this.transportOpen(),this.subscriber.init()]),this.registerEventListeners(),this.initialized=!0,setTimeout(async()=>{this.subscriber.topics.length===0&&(this.logger.info("No topics subscribted to after init, closing transport"),await this.transportClose(),this.transportExplicitlyClosed=!1)},So)}get context(){return Se.getLoggerContext(this.logger)}get connected(){return this.provider.connection.connected}get connecting(){return this.provider.connection.connecting}async publish(e,r,n){this.isInitialized(),await this.publisher.publish(e,r,n),await this.recordMessageEvent({topic:e,message:r,publishedAt:Date.now()})}async subscribe(e,r){var n;this.isInitialized();let i=((n=this.subscriber.topicMap.get(e))==null?void 0:n[0])||"";return i||(await Promise.all([new Promise(s=>{this.subscriber.once(dt.created,c=>{c.topic===e&&s()})}),new Promise(async s=>{i=await this.subscriber.subscribe(e,r),s()})]),i)}async unsubscribe(e,r){this.isInitialized(),await this.subscriber.unsubscribe(e,r)}on(e,r){this.events.on(e,r)}once(e,r){this.events.once(e,r)}off(e,r){this.events.off(e,r)}removeListener(e,r){this.events.removeListener(e,r)}async transportClose(){this.transportExplicitlyClosed=!0,this.connected&&(await this.provider.disconnect(),this.events.emit(ze.transport_closed))}async transportOpen(e){if(this.transportExplicitlyClosed=!1,!this.reconnecting){this.relayUrl=e||this.relayUrl,this.reconnecting=!0;try{await Promise.all([new Promise(r=>{this.initialized||r(),this.subscriber.once(dt.resubscribed,()=>{r()})}),await Promise.race([new Promise(async(r,n)=>{await Ur(this.provider.connect(),5e3,"socket stalled").catch(i=>n(i)).then(()=>r()).finally(()=>this.removeListener(ze.transport_closed,this.rejectTransportOpen))}),new Promise(r=>this.once(ze.transport_closed,this.rejectTransportOpen))])])}catch(r){this.logger.error(r);const n=r;if(!this.isConnectionStalled(n.message))throw r;this.events.emit(ze.transport_closed)}finally{this.reconnecting=!1}}}async restartTransport(e){this.transportExplicitlyClosed||this.reconnecting||(this.relayUrl=e||this.relayUrl,this.connected&&await Promise.all([new Promise(r=>{this.provider.once(qt.disconnect,()=>{r()})}),this.transportClose()]),await this.createProvider(),await this.transportOpen())}isConnectionStalled(e){return this.staleConnectionErrors.some(r=>e.includes(r))}rejectTransportOpen(){throw new Error("closeTransport called before connection was established")}async createProvider(){const e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new b0(new m0(cd({sdkVersion:Do,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0}))),this.registerProviderListeners()}async recordMessageEvent(e){const{topic:r,message:n}=e;await this.messages.set(r,n)}async shouldIgnoreMessageEvent(e){const{topic:r,message:n}=e;return await this.subscriber.isSubscribed(r)?this.messages.has(r,n):!0}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),Jo(e)){if(!e.method.endsWith(wo))return;const r=e.params,{topic:n,message:i,publishedAt:s}=r.data,c={topic:n,message:i,publishedAt:s};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(L0({type:"event",event:r.id},c)),this.events.emit(r.id,c),await this.acknowledgePayload(e),await this.onMessageEvent(c)}else ti(e)&&this.events.emit(ze.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(this.events.emit(ze.message,e),await this.recordMessageEvent(e))}async acknowledgePayload(e){const r=Yo(e.id,!0);await this.provider.connection.send(r)}registerProviderListeners(){this.provider.on(qt.payload,e=>this.onProviderPayload(e)),this.provider.on(qt.connect,()=>{this.events.emit(ze.connect)}),this.provider.on(qt.disconnect,()=>{this.onProviderDisconnect()}),this.provider.on(qt.error,e=>{this.logger.error(e),this.events.emit(ze.error,e)})}registerEventListeners(){this.events.on(ze.connection_stalled,async()=>{await this.restartTransport()})}onProviderDisconnect(){this.events.emit(ze.disconnect),this.attemptToReconnect()}attemptToReconnect(){this.transportExplicitlyClosed||setTimeout(async()=>{await this.restartTransport()},ye.toMiliseconds(mo))}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(!this.connected){if(this.connecting)return await new Promise(e=>{const r=setInterval(()=>{this.connected&&(clearInterval(r),e())},this.connectionStatusPollingInterval)});await this.restartTransport()}}}var ni={exports:{}};(function(t,e){var r=200,n="__lodash_hash_undefined__",i=1,s=2,c=9007199254740991,u="[object Arguments]",h="[object Array]",f="[object AsyncFunction]",_="[object Boolean]",O="[object Date]",p="[object Error]",E="[object Function]",A="[object GeneratorFunction]",C="[object Map]",U="[object Number]",Y="[object Null]",S="[object Object]",R="[object Promise]",b="[object Proxy]",v="[object RegExp]",d="[object Set]",o="[object String]",l="[object Symbol]",L="[object Undefined]",P="[object WeakMap]",H="[object ArrayBuffer]",G="[object DataView]",k="[object Float32Array]",D="[object Float64Array]",I="[object Int8Array]",V="[object Int16Array]",F="[object Int32Array]",M="[object Uint8Array]",$="[object Uint8ClampedArray]",N="[object Uint16Array]",B="[object Uint32Array]",ee=/[\\^$.*+?()[\]{}|]/g,z=/^\[object .+?Constructor\]$/,Z=/^(?:0|[1-9]\d*)$/,W={};W[k]=W[D]=W[I]=W[V]=W[F]=W[M]=W[$]=W[N]=W[B]=!0,W[u]=W[h]=W[H]=W[_]=W[G]=W[O]=W[p]=W[E]=W[C]=W[U]=W[S]=W[v]=W[d]=W[o]=W[P]=!1;var Q=typeof Je=="object"&&Je&&Je.Object===Object&&Je,T=typeof self=="object"&&self&&self.Object===Object&&self,x=Q||T||Function("return this")(),w=e&&!e.nodeType&&e,a=w&&!0&&t&&!t.nodeType&&t,y=a&&a.exports===w,K=y&&Q.process,q=function(){try{return K&&K.binding&&K.binding("util")}catch{}}(),fe=q&&q.isTypedArray;function pe(g,m){for(var j=-1,X=g==null?0:g.length,Ie=0,ie=[];++j<X;){var Ne=g[j];m(Ne,j,g)&&(ie[Ie++]=Ne)}return ie}function le(g,m){for(var j=-1,X=m.length,Ie=g.length;++j<X;)g[Ie+j]=m[j];return g}function Ee(g,m){for(var j=-1,X=g==null?0:g.length;++j<X;)if(m(g[j],j,g))return!0;return!1}function Ue(g,m){for(var j=-1,X=Array(g);++j<g;)X[j]=m(j);return X}function Ce(g){return function(m){return g(m)}}function _e(g,m){return g.has(m)}function de(g,m){return g?.[m]}function he(g){var m=-1,j=Array(g.size);return g.forEach(function(X,Ie){j[++m]=[Ie,X]}),j}function ce(g,m){return function(j){return g(m(j))}}function ae(g){var m=-1,j=Array(g.size);return g.forEach(function(X){j[++m]=X}),j}var oe=Array.prototype,se=Function.prototype,te=Object.prototype,ue=x["__core-js_shared__"],ge=se.toString,ne=te.hasOwnProperty,be=function(){var g=/[^.]+$/.exec(ue&&ue.keys&&ue.keys.IE_PROTO||"");return g?"Symbol(src)_1."+g:""}(),ve=te.toString,me=RegExp("^"+ge.call(ne).replace(ee,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),De=y?x.Buffer:void 0,we=x.Symbol,_t=x.Uint8Array,bt=te.propertyIsEnumerable,Ot=oe.splice,at=we?we.toStringTag:void 0,Mt=Object.getOwnPropertySymbols,pr=De?De.isBuffer:void 0,Hr=ce(Object.keys,Object),Me=Wt(x,"DataView"),Pe=Wt(x,"Map"),je=Wt(x,"Promise"),$e=Wt(x,"Set"),Fe=Wt(x,"WeakMap"),Le=Wt(Object,"create"),Ke=$t(Me),Ge=$t(Pe),Ve=$t(je),qe=$t($e),Ye=$t(Fe),He=we?we.prototype:void 0,Be=He?He.valueOf:void 0;function Re(g){var m=-1,j=g==null?0:g.length;for(this.clear();++m<j;){var X=g[m];this.set(X[0],X[1])}}function We(){this.__data__=Le?Le(null):{},this.size=0}function Xe(g){var m=this.has(g)&&delete this.__data__[g];return this.size-=m?1:0,m}function H0(g){var m=this.__data__;if(Le){var j=m[g];return j===n?void 0:j}return ne.call(m,g)?m[g]:void 0}function K0(g){var m=this.__data__;return Le?m[g]!==void 0:ne.call(m,g)}function G0(g,m){var j=this.__data__;return this.size+=this.has(g)?0:1,j[g]=Le&&m===void 0?n:m,this}Re.prototype.clear=We,Re.prototype.delete=Xe,Re.prototype.get=H0,Re.prototype.has=K0,Re.prototype.set=G0;function mt(g){var m=-1,j=g==null?0:g.length;for(this.clear();++m<j;){var X=g[m];this.set(X[0],X[1])}}function V0(){this.__data__=[],this.size=0}function q0(g){var m=this.__data__,j=Gr(m,g);if(j<0)return!1;var X=m.length-1;return j==X?m.pop():Ot.call(m,j,1),--this.size,!0}function Y0(g){var m=this.__data__,j=Gr(m,g);return j<0?void 0:m[j][1]}function W0(g){return Gr(this.__data__,g)>-1}function X0(g,m){var j=this.__data__,X=Gr(j,g);return X<0?(++this.size,j.push([g,m])):j[X][1]=m,this}mt.prototype.clear=V0,mt.prototype.delete=q0,mt.prototype.get=Y0,mt.prototype.has=W0,mt.prototype.set=X0;function jt(g){var m=-1,j=g==null?0:g.length;for(this.clear();++m<j;){var X=g[m];this.set(X[0],X[1])}}function k0(){this.size=0,this.__data__={hash:new Re,map:new(Pe||mt),string:new Re}}function J0(g){var m=Vr(this,g).delete(g);return this.size-=m?1:0,m}function Z0(g){return Vr(this,g).get(g)}function Q0(g){return Vr(this,g).has(g)}function eg(g,m){var j=Vr(this,g),X=j.size;return j.set(g,m),this.size+=j.size==X?0:1,this}jt.prototype.clear=k0,jt.prototype.delete=J0,jt.prototype.get=Z0,jt.prototype.has=Q0,jt.prototype.set=eg;function Kr(g){var m=-1,j=g==null?0:g.length;for(this.__data__=new jt;++m<j;)this.add(g[m])}function tg(g){return this.__data__.set(g,n),this}function rg(g){return this.__data__.has(g)}Kr.prototype.add=Kr.prototype.push=tg,Kr.prototype.has=rg;function xt(g){var m=this.__data__=new mt(g);this.size=m.size}function ng(){this.__data__=new mt,this.size=0}function ig(g){var m=this.__data__,j=m.delete(g);return this.size=m.size,j}function sg(g){return this.__data__.get(g)}function og(g){return this.__data__.has(g)}function ag(g,m){var j=this.__data__;if(j instanceof mt){var X=j.__data__;if(!Pe||X.length<r-1)return X.push([g,m]),this.size=++j.size,this;j=this.__data__=new jt(X)}return j.set(g,m),this.size=j.size,this}xt.prototype.clear=ng,xt.prototype.delete=ig,xt.prototype.get=sg,xt.prototype.has=og,xt.prototype.set=ag;function cg(g,m){var j=qr(g),X=!j&&Dg(g),Ie=!j&&!X&&ii(g),ie=!j&&!X&&!Ie&&Oa(g),Ne=j||X||Ie||ie,ke=Ne?Ue(g.length,String):[],Qe=ke.length;for(var Ae in g)(m||ne.call(g,Ae))&&!(Ne&&(Ae=="length"||Ie&&(Ae=="offset"||Ae=="parent")||ie&&(Ae=="buffer"||Ae=="byteLength"||Ae=="byteOffset")||bg(Ae,Qe)))&&ke.push(Ae);return ke}function Gr(g,m){for(var j=g.length;j--;)if(wa(g[j][0],m))return j;return-1}function ug(g,m,j){var X=m(g);return qr(g)?X:le(X,j(g))}function br(g){return g==null?g===void 0?L:Y:at&&at in Object(g)?yg(g):mg(g)}function pa(g){return vr(g)&&br(g)==u}function ba(g,m,j,X,Ie){return g===m?!0:g==null||m==null||!vr(g)&&!vr(m)?g!==g&&m!==m:fg(g,m,j,X,ba,Ie)}function fg(g,m,j,X,Ie,ie){var Ne=qr(g),ke=qr(m),Qe=Ne?h:Tt(g),Ae=ke?h:Tt(m);Qe=Qe==u?S:Qe,Ae=Ae==u?S:Ae;var ct=Qe==S,yt=Ae==S,tt=Qe==Ae;if(tt&&ii(g)){if(!ii(m))return!1;Ne=!0,ct=!1}if(tt&&!ct)return ie||(ie=new xt),Ne||Oa(g)?va(g,m,j,X,Ie,ie):gg(g,m,Qe,j,X,Ie,ie);if(!(j&i)){var ht=ct&&ne.call(g,"__wrapped__"),lt=yt&&ne.call(m,"__wrapped__");if(ht||lt){var It=ht?g.value():g,Dt=lt?m.value():m;return ie||(ie=new xt),Ie(It,Dt,j,X,ie)}}return tt?(ie||(ie=new xt),_g(g,m,j,X,Ie,ie)):!1}function hg(g){if(!Sa(g)||Eg(g))return!1;var m=ma(g)?me:z;return m.test($t(g))}function lg(g){return vr(g)&&Da(g.length)&&!!W[br(g)]}function dg(g){if(!wg(g))return Hr(g);var m=[];for(var j in Object(g))ne.call(g,j)&&j!="constructor"&&m.push(j);return m}function va(g,m,j,X,Ie,ie){var Ne=j&i,ke=g.length,Qe=m.length;if(ke!=Qe&&!(Ne&&Qe>ke))return!1;var Ae=ie.get(g);if(Ae&&ie.get(m))return Ae==m;var ct=-1,yt=!0,tt=j&s?new Kr:void 0;for(ie.set(g,m),ie.set(m,g);++ct<ke;){var ht=g[ct],lt=m[ct];if(X)var It=Ne?X(lt,ht,ct,m,g,ie):X(ht,lt,ct,g,m,ie);if(It!==void 0){if(It)continue;yt=!1;break}if(tt){if(!Ee(m,function(Dt,Ft){if(!_e(tt,Ft)&&(ht===Dt||Ie(ht,Dt,j,X,ie)))return tt.push(Ft)})){yt=!1;break}}else if(!(ht===lt||Ie(ht,lt,j,X,ie))){yt=!1;break}}return ie.delete(g),ie.delete(m),yt}function gg(g,m,j,X,Ie,ie,Ne){switch(j){case G:if(g.byteLength!=m.byteLength||g.byteOffset!=m.byteOffset)return!1;g=g.buffer,m=m.buffer;case H:return!(g.byteLength!=m.byteLength||!ie(new _t(g),new _t(m)));case _:case O:case U:return wa(+g,+m);case p:return g.name==m.name&&g.message==m.message;case v:case o:return g==m+"";case C:var ke=he;case d:var Qe=X&i;if(ke||(ke=ae),g.size!=m.size&&!Qe)return!1;var Ae=Ne.get(g);if(Ae)return Ae==m;X|=s,Ne.set(g,m);var ct=va(ke(g),ke(m),X,Ie,ie,Ne);return Ne.delete(g),ct;case l:if(Be)return Be.call(g)==Be.call(m)}return!1}function _g(g,m,j,X,Ie,ie){var Ne=j&i,ke=Ea(g),Qe=ke.length,Ae=Ea(m),ct=Ae.length;if(Qe!=ct&&!Ne)return!1;for(var yt=Qe;yt--;){var tt=ke[yt];if(!(Ne?tt in m:ne.call(m,tt)))return!1}var ht=ie.get(g);if(ht&&ie.get(m))return ht==m;var lt=!0;ie.set(g,m),ie.set(m,g);for(var It=Ne;++yt<Qe;){tt=ke[yt];var Dt=g[tt],Ft=m[tt];if(X)var xa=Ne?X(Ft,Dt,tt,m,g,ie):X(Dt,Ft,tt,g,m,ie);if(!(xa===void 0?Dt===Ft||Ie(Dt,Ft,j,X,ie):xa)){lt=!1;break}It||(It=tt=="constructor")}if(lt&&!It){var Yr=g.constructor,Wr=m.constructor;Yr!=Wr&&"constructor"in g&&"constructor"in m&&!(typeof Yr=="function"&&Yr instanceof Yr&&typeof Wr=="function"&&Wr instanceof Wr)&&(lt=!1)}return ie.delete(g),ie.delete(m),lt}function Ea(g){return ug(g,xg,pg)}function Vr(g,m){var j=g.__data__;return vg(m)?j[typeof m=="string"?"string":"hash"]:j.map}function Wt(g,m){var j=de(g,m);return hg(j)?j:void 0}function yg(g){var m=ne.call(g,at),j=g[at];try{g[at]=void 0;var X=!0}catch{}var Ie=ve.call(g);return X&&(m?g[at]=j:delete g[at]),Ie}var pg=Mt?function(g){return g==null?[]:(g=Object(g),pe(Mt(g),function(m){return bt.call(g,m)}))}:Tg,Tt=br;(Me&&Tt(new Me(new ArrayBuffer(1)))!=G||Pe&&Tt(new Pe)!=C||je&&Tt(je.resolve())!=R||$e&&Tt(new $e)!=d||Fe&&Tt(new Fe)!=P)&&(Tt=function(g){var m=br(g),j=m==S?g.constructor:void 0,X=j?$t(j):"";if(X)switch(X){case Ke:return G;case Ge:return C;case Ve:return R;case qe:return d;case Ye:return P}return m});function bg(g,m){return m=m??c,!!m&&(typeof g=="number"||Z.test(g))&&g>-1&&g%1==0&&g<m}function vg(g){var m=typeof g;return m=="string"||m=="number"||m=="symbol"||m=="boolean"?g!=="__proto__":g===null}function Eg(g){return!!be&&be in g}function wg(g){var m=g&&g.constructor,j=typeof m=="function"&&m.prototype||te;return g===j}function mg(g){return ve.call(g)}function $t(g){if(g!=null){try{return ge.call(g)}catch{}try{return g+""}catch{}}return""}function wa(g,m){return g===m||g!==g&&m!==m}var Dg=pa(function(){return arguments}())?pa:function(g){return vr(g)&&ne.call(g,"callee")&&!bt.call(g,"callee")},qr=Array.isArray;function Sg(g){return g!=null&&Da(g.length)&&!ma(g)}var ii=pr||Ig;function Og(g,m){return ba(g,m)}function ma(g){if(!Sa(g))return!1;var m=br(g);return m==E||m==A||m==f||m==b}function Da(g){return typeof g=="number"&&g>-1&&g%1==0&&g<=c}function Sa(g){var m=typeof g;return g!=null&&(m=="object"||m=="function")}function vr(g){return g!=null&&typeof g=="object"}var Oa=fe?Ce(fe):lg;function xg(g){return Sg(g)?cg(g):dg(g)}function Tg(){return[]}function Ig(){return!1}t.exports=Og})(ni,ni.exports);var N0=ni.exports,U0=Object.defineProperty,oa=Object.getOwnPropertySymbols,M0=Object.prototype.hasOwnProperty,j0=Object.prototype.propertyIsEnumerable,aa=(t,e,r)=>e in t?U0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ca=(t,e)=>{for(var r in e||(e={}))M0.call(e,r)&&aa(t,r,e[r]);if(oa)for(var r of oa(e))j0.call(e,r)&&aa(t,r,e[r]);return t};class ua extends Mu{constructor(e,r,n,i=vt,s=void 0){super(e,r,n,i),this.core=e,this.logger=r,this.name=n,this.map=new Map,this.version=Oo,this.cached=[],this.initialized=!1,this.storagePrefix=vt,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(c=>{this.getKey&&c!==null&&!jr(c)?this.map.set(this.getKey(c),c):Td(c)?this.map.set(c.id,c):Id(c)&&this.map.set(c.topic,c)}),this.cached=[],this.initialized=!0)},this.set=async(c,u)=>{this.isInitialized(),this.map.has(c)?await this.update(c,u):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:c,value:u}),this.map.set(c,u),await this.persist())},this.get=c=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:c}),this.getData(c)),this.getAll=c=>(this.isInitialized(),c?this.values.filter(u=>Object.keys(c).every(h=>N0(u[h],c[h]))):this.values),this.update=async(c,u)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:c,update:u});const h=ca(ca({},this.getData(c)),u);this.map.set(c,h),await this.persist()},this.delete=async(c,u)=>{this.isInitialized(),this.map.has(c)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:c,reason:u}),this.map.delete(c),await this.persist())},this.logger=Se.generateChildLogger(r,this.name),this.storagePrefix=i,this.getKey=s}get context(){return Se.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){const r=this.map.get(e);if(!r){const{message:n}=Te("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(n),new Error(n)}return r}async persist(){await this.setDataStore(this.values)}async restore(){try{const e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){const{message:r}=Te("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(r),new Error(r)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}}class fa{constructor(e,r){this.core=e,this.logger=r,this.name=Ro,this.version=Ao,this.events=new ut.exports,this.initialized=!1,this.storagePrefix=vt,this.ignoredPayloadTypes=[Vt],this.registeredMethods=[],this.init=async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))},this.register=({methods:n})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...n])]},this.create=async()=>{this.isInitialized();const n=Fn(),i=await this.core.crypto.setSymKey(n),s=Hn(ye.FIVE_MINUTES),c={protocol:bo},u={topic:i,expiry:s,relay:c,active:!1},h=md({protocol:this.core.protocol,version:this.core.version,topic:i,symKey:n,relay:c});return await this.pairings.set(i,u),await this.core.relayer.subscribe(i),this.core.expirer.set(i,s),{topic:i,uri:h}},this.pair=async n=>{this.isInitialized(),this.isValidPair(n);const{topic:i,symKey:s,relay:c}=vd(n.uri);if(this.pairings.keys.includes(i))throw new Error(`Pairing already exists: ${i}`);if(this.core.crypto.hasKeys(i))throw new Error(`Keychain already exists: ${i}`);const u=Hn(ye.FIVE_MINUTES),h={topic:i,relay:c,expiry:u,active:!1};return await this.pairings.set(i,h),await this.core.crypto.setSymKey(s,i),await this.core.relayer.subscribe(i,{relay:c}),this.core.expirer.set(i,u),n.activatePairing&&await this.activate({topic:i}),h},this.activate=async({topic:n})=>{this.isInitialized();const i=Hn(ye.THIRTY_DAYS);await this.pairings.update(n,{active:!0,expiry:i}),this.core.expirer.set(n,i)},this.ping=async n=>{this.isInitialized(),await this.isValidPing(n);const{topic:i}=n;if(this.pairings.keys.includes(i)){const s=await this.sendRequest(i,"wc_pairingPing",{}),{done:c,resolve:u,reject:h}=ud();this.events.once(Kn("pairing_ping",s),({error:f})=>{f?h(f):u()}),await c()}},this.updateExpiry=async({topic:n,expiry:i})=>{this.isInitialized(),await this.pairings.update(n,{expiry:i})},this.updateMetadata=async({topic:n,metadata:i})=>{this.isInitialized(),await this.pairings.update(n,{peerMetadata:i})},this.getPairings=()=>(this.isInitialized(),this.pairings.values),this.disconnect=async n=>{this.isInitialized(),await this.isValidDisconnect(n);const{topic:i}=n;this.pairings.keys.includes(i)&&(await this.sendRequest(i,"wc_pairingDelete",dr("USER_DISCONNECTED")),await this.deletePairing(i))},this.sendRequest=async(n,i,s)=>{const c=ei(i,s),u=await this.core.crypto.encode(n,c),h=Yt[i].req;return this.core.history.set(n,c),this.core.relayer.publish(n,u,h),c.id},this.sendResult=async(n,i,s)=>{const c=Yo(n,s),u=await this.core.crypto.encode(i,c),h=await this.core.history.get(i,n),f=Yt[h.request.method].res;await this.core.relayer.publish(i,u,f),await this.core.history.resolve(c)},this.sendError=async(n,i,s)=>{const c=Wo(n,s),u=await this.core.crypto.encode(i,c),h=await this.core.history.get(i,n),f=Yt[h.request.method]?Yt[h.request.method].res:Yt.unregistered_method.res;await this.core.relayer.publish(i,u,f),await this.core.history.resolve(c)},this.deletePairing=async(n,i)=>{await this.core.relayer.unsubscribe(n),await Promise.all([this.pairings.delete(n,dr("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(n),i?Promise.resolve():this.core.expirer.del(n)])},this.cleanup=async()=>{const n=this.pairings.getAll().filter(i=>ro(i.expiry));await Promise.all(n.map(i=>this.deletePairing(i.topic)))},this.onRelayEventRequest=n=>{const{topic:i,payload:s}=n,c=s.method;if(this.pairings.keys.includes(i))switch(c){case"wc_pairingPing":return this.onPairingPingRequest(i,s);case"wc_pairingDelete":return this.onPairingDeleteRequest(i,s);default:return this.onUnknownRpcMethodRequest(i,s)}},this.onRelayEventResponse=async n=>{const{topic:i,payload:s}=n,c=(await this.core.history.get(i,s.id)).request.method;if(this.pairings.keys.includes(i))switch(c){case"wc_pairingPing":return this.onPairingPingResponse(i,s);default:return this.onUnknownRpcMethodResponse(c)}},this.onPairingPingRequest=async(n,i)=>{const{id:s}=i;try{this.isValidPing({topic:n}),await this.sendResult(s,n,!0),this.events.emit("pairing_ping",{id:s,topic:n})}catch(c){await this.sendError(s,n,c),this.logger.error(c)}},this.onPairingPingResponse=(n,i)=>{const{id:s}=i;setTimeout(()=>{Zo(i)?this.events.emit(Kn("pairing_ping",s),{}):Br(i)&&this.events.emit(Kn("pairing_ping",s),{error:i.error})},500)},this.onPairingDeleteRequest=async(n,i)=>{const{id:s}=i;try{this.isValidDisconnect({topic:n}),await this.deletePairing(n),this.events.emit("pairing_delete",{id:s,topic:n})}catch(c){await this.sendError(s,n,c),this.logger.error(c)}},this.onUnknownRpcMethodRequest=async(n,i)=>{const{id:s,method:c}=i;try{if(this.registeredMethods.includes(c))return;const u=dr("WC_METHOD_UNSUPPORTED",c);await this.sendError(s,n,u),this.logger.error(u)}catch(u){await this.sendError(s,n,u),this.logger.error(u)}},this.onUnknownRpcMethodResponse=n=>{this.registeredMethods.includes(n)||this.logger.error(dr("WC_METHOD_UNSUPPORTED",n))},this.isValidPair=n=>{if(!Vn(n)){const{message:i}=Te("MISSING_OR_INVALID",`pair() params: ${n}`);throw new Error(i)}if(!xd(n.uri)){const{message:i}=Te("MISSING_OR_INVALID",`pair() uri: ${n.uri}`);throw new Error(i)}},this.isValidPing=async n=>{if(!Vn(n)){const{message:s}=Te("MISSING_OR_INVALID",`ping() params: ${n}`);throw new Error(s)}const{topic:i}=n;await this.isValidPairingTopic(i)},this.isValidDisconnect=async n=>{if(!Vn(n)){const{message:s}=Te("MISSING_OR_INVALID",`disconnect() params: ${n}`);throw new Error(s)}const{topic:i}=n;await this.isValidPairingTopic(i)},this.isValidPairingTopic=async n=>{if(!so(n,!1)){const{message:i}=Te("MISSING_OR_INVALID",`pairing topic should be a string: ${n}`);throw new Error(i)}if(!this.pairings.keys.includes(n)){const{message:i}=Te("NO_MATCHING_KEY",`pairing topic doesn't exist: ${n}`);throw new Error(i)}if(ro(this.pairings.get(n).expiry)){await this.deletePairing(n);const{message:i}=Te("EXPIRED",`pairing topic: ${n}`);throw new Error(i)}},this.core=e,this.logger=Se.generateChildLogger(r,this.name),this.pairings=new ua(this.core,this.logger,this.name,this.storagePrefix)}get context(){return Se.getLoggerContext(this.logger)}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(ze.message,async e=>{const{topic:r,message:n}=e;if(this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(n)))return;const i=await this.core.crypto.decode(r,n);Jo(i)?(this.core.history.set(r,i),this.onRelayEventRequest({topic:r,payload:i})):ti(i)&&(await this.core.history.resolve(i),this.onRelayEventResponse({topic:r,payload:i}))})}registerExpirerEvents(){this.core.expirer.on(ft.expired,async e=>{const{topic:r}=ld(e.target);r&&this.pairings.keys.includes(r)&&(await this.deletePairing(r,!0),this.events.emit("pairing_expire",{topic:r}))})}}class ha extends Pu{constructor(e,r){super(e,r),this.core=e,this.logger=r,this.records=new Map,this.events=new ut.exports.EventEmitter,this.name=Co,this.version=Po,this.cached=[],this.initialized=!1,this.storagePrefix=vt,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(n=>this.records.set(n.id,n)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.set=(n,i,s)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:n,request:i,chainId:s}),this.records.has(i.id))return;const c={id:i.id,topic:n,request:{method:i.method,params:i.params||null},chainId:s};this.records.set(c.id,c),this.events.emit(gt.created,c)},this.resolve=async n=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:n}),!this.records.has(n.id))return;const i=await this.getRecord(n.id);typeof i.response>"u"&&(i.response=Br(n)?{error:n.error}:{result:n.result},this.records.set(i.id,i),this.events.emit(gt.updated,i))},this.get=async(n,i)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:n,id:i}),await this.getRecord(i)),this.delete=(n,i)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:i}),this.values.forEach(s=>{if(s.topic===n){if(typeof i<"u"&&s.id!==i)return;this.records.delete(s.id),this.events.emit(gt.deleted,s)}})},this.exists=async(n,i)=>(this.isInitialized(),this.records.has(i)?(await this.getRecord(i)).topic===n:!1),this.on=(n,i)=>{this.events.on(n,i)},this.once=(n,i)=>{this.events.once(n,i)},this.off=(n,i)=>{this.events.off(n,i)},this.removeListener=(n,i)=>{this.events.removeListener(n,i)},this.logger=Se.generateChildLogger(r,this.name)}get context(){return Se.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){const e=[];return this.values.forEach(r=>{if(typeof r.response<"u")return;const n={topic:r.topic,request:ei(r.request.method,r.request.params,r.id),chainId:r.chainId};return e.push(n)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();const r=this.records.get(e);if(!r){const{message:n}=Te("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(n)}return r}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(gt.sync)}async restore(){try{const e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){const{message:r}=Te("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(r),new Error(r)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(gt.created,e=>{const r=gt.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,record:e}),this.persist()}),this.events.on(gt.updated,e=>{const r=gt.updated;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,record:e}),this.persist()}),this.events.on(gt.deleted,e=>{const r=gt.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,record:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}}class la extends $u{constructor(e,r){super(e,r),this.core=e,this.logger=r,this.expirations=new Map,this.events=new ut.exports.EventEmitter,this.name=Lo,this.version=No,this.cached=[],this.initialized=!1,this.storagePrefix=vt,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(n=>this.expirations.set(n.target,n)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.has=n=>{try{const i=this.formatTarget(n);return typeof this.getExpiration(i)<"u"}catch{return!1}},this.set=(n,i)=>{this.isInitialized();const s=this.formatTarget(n),c={target:s,expiry:i};this.expirations.set(s,c),this.checkExpiry(s,c),this.events.emit(ft.created,{target:s,expiration:c})},this.get=n=>{this.isInitialized();const i=this.formatTarget(n);return this.getExpiration(i)},this.del=n=>{if(this.isInitialized(),this.has(n)){const i=this.formatTarget(n),s=this.getExpiration(i);this.expirations.delete(i),this.events.emit(ft.deleted,{target:i,expiration:s})}},this.on=(n,i)=>{this.events.on(n,i)},this.once=(n,i)=>{this.events.once(n,i)},this.off=(n,i)=>{this.events.off(n,i)},this.removeListener=(n,i)=>{this.events.removeListener(n,i)},this.logger=Se.generateChildLogger(r,this.name)}get context(){return Se.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return fd(e);if(typeof e=="number")return hd(e);const{message:r}=Te("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(r)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(ft.sync)}async restore(){try{const e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){const{message:r}=Te("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(r),new Error(r)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){const r=this.expirations.get(e);if(!r){const{message:n}=Te("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(n),new Error(n)}return r}checkExpiry(e,r){const{expiry:n}=r;ye.toMiliseconds(n)-Date.now()<=0&&this.expire(e,r)}expire(e,r){this.expirations.delete(e),this.events.emit(ft.expired,{target:e,expiration:r})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,r)=>this.checkExpiry(r,e))}registerEventListeners(){this.core.heartbeat.on(er.HEARTBEAT_EVENTS.pulse,()=>this.checkExpirations()),this.events.on(ft.created,e=>{const r=ft.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:e}),this.persist()}),this.events.on(ft.expired,e=>{const r=ft.expired;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:e}),this.persist()}),this.events.on(ft.deleted,e=>{const r=ft.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}}class da extends Fu{constructor(e,r){super(e,r),this.projectId=e,this.logger=r,this.name=Fr,this.initialized=!1,this.init=async n=>{Js()||!Zs()||(this.verifyUrl=n?.verifyUrl||Xn,await this.createIframe())},this.register=async n=>{var i;this.initialized||await this.init(),this.iframe&&((i=this.iframe.contentWindow)==null||i.postMessage(n.attestationId,this.verifyUrl),this.logger.info(`postMessage sent: ${n.attestationId} ${this.verifyUrl}`))},this.resolve=async n=>{var i;if(this.isDevEnv)return"";this.logger.info(`resolving attestation: ${n.attestationId}`);const s=this.startAbortTimer(ye.FIVE_SECONDS),c=await fetch(`${this.verifyUrl}/attestation/${n.attestationId}`,{signal:this.abortController.signal});return clearTimeout(s),c.status===200?(i=await c.json())==null?void 0:i.origin:""},this.createIframe=async()=>{try{await Promise.race([new Promise((n,i)=>{if(document.getElementById(Fr))return n();const s=document.createElement("iframe");s.setAttribute("id",Fr),s.setAttribute("src",`${this.verifyUrl}/${this.projectId}`),s.style.display="none",s.addEventListener("load",()=>{this.initialized=!0,n()}),s.addEventListener("error",c=>{i(c)}),document.body.append(s),this.iframe=s}),new Promise(n=>{setTimeout(()=>n("iframe load timeout"),ye.toMiliseconds(ye.ONE_SECOND/2))})])}catch(n){this.logger.error(`Verify iframe failed to load: ${this.verifyUrl}`),this.logger.error(n)}},this.logger=Se.generateChildLogger(r,this.name),this.verifyUrl=Xn,this.abortController=new AbortController,this.isDevEnv=zn()&&process.env.IS_VITEST}get context(){return Se.getLoggerContext(this.logger)}startAbortTimer(e){return setTimeout(()=>this.abortController.abort(),ye.toMiliseconds(e))}}var $0=Object.defineProperty,ga=Object.getOwnPropertySymbols,F0=Object.prototype.hasOwnProperty,B0=Object.prototype.propertyIsEnumerable,_a=(t,e,r)=>e in t?$0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ya=(t,e)=>{for(var r in e||(e={}))F0.call(e,r)&&_a(t,r,e[r]);if(ga)for(var r of ga(e))B0.call(e,r)&&_a(t,r,e[r]);return t};class zr extends Cu{constructor(e){super(e),this.protocol=qn,this.version=oo,this.name=$r,this.events=new ut.exports.EventEmitter,this.initialized=!1,this.on=(n,i)=>this.events.on(n,i),this.once=(n,i)=>this.events.once(n,i),this.off=(n,i)=>this.events.off(n,i),this.removeListener=(n,i)=>this.events.removeListener(n,i),this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||Wn;const r=typeof e?.logger<"u"&&typeof e?.logger!="string"?e.logger:Se.pino(Se.getDefaultLoggerOptions({level:e?.logger||ao.logger}));this.logger=Se.generateChildLogger(r,this.name),this.heartbeat=new er.HeartBeat,this.crypto=new Mo(this,this.logger,e?.keychain),this.history=new ha(this,this.logger),this.expirer=new la(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new ac(ya(ya({},co),e?.storageOptions)),this.relayer=new sa({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new fa(this,this.logger),this.verify=new da(this.projectId||"",this.logger)}static async init(e){const r=new zr(e);return await r.initialize(),r}get context(){return Se.getLoggerContext(this.logger)}async start(){this.initialized||await this.initialize()}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}}const z0=zr;J.CORE_CONTEXT=$r,J.CORE_DEFAULT=ao,J.CORE_PROTOCOL=qn,J.CORE_STORAGE_OPTIONS=co,J.CORE_STORAGE_PREFIX=vt,J.CORE_VERSION=oo,J.CRYPTO_CLIENT_SEED=Yn,J.CRYPTO_CONTEXT=uo,J.CRYPTO_JWT_TTL=fo,J.Core=z0,J.Crypto=Mo,J.EXPIRER_CONTEXT=Lo,J.EXPIRER_DEFAULT_TTL=Pd,J.EXPIRER_EVENTS=ft,J.EXPIRER_STORAGE_VERSION=No,J.Expirer=la,J.HISTORY_CONTEXT=Co,J.HISTORY_EVENTS=gt,J.HISTORY_STORAGE_VERSION=Po,J.JsonRpcHistory=ha,J.KEYCHAIN_CONTEXT=ho,J.KEYCHAIN_STORAGE_VERSION=lo,J.KeyChain=Uo,J.MESSAGES_CONTEXT=go,J.MESSAGES_STORAGE_VERSION=_o,J.MessageTracker=jo,J.PAIRING_CONTEXT=Ro,J.PAIRING_DEFAULT_TTL=Cd,J.PAIRING_RPC_OPTS=Yt,J.PAIRING_STORAGE_VERSION=Ao,J.PENDING_SUB_RESOLUTION_TIMEOUT=Io,J.PUBLISHER_CONTEXT=po,J.PUBLISHER_DEFAULT_TTL=yo,J.Pairing=fa,J.RELAYER_CONTEXT=Eo,J.RELAYER_DEFAULT_LOGGER=vo,J.RELAYER_DEFAULT_PROTOCOL=bo,J.RELAYER_DEFAULT_RELAY_URL=Wn,J.RELAYER_EVENTS=ze,J.RELAYER_PROVIDER_EVENTS=qt,J.RELAYER_RECONNECT_TIMEOUT=mo,J.RELAYER_SDK_VERSION=Do,J.RELAYER_STORAGE_OPTIONS=Rd,J.RELAYER_SUBSCRIBER_SUFFIX=wo,J.RELAYER_TRANSPORT_CUTOFF=So,J.Relayer=sa,J.STORE_STORAGE_VERSION=Oo,J.SUBSCRIBER_CONTEXT=xo,J.SUBSCRIBER_DEFAULT_TTL=Ad,J.SUBSCRIBER_EVENTS=dt,J.SUBSCRIBER_STORAGE_VERSION=To,J.Store=ua,J.Subscriber=ra,J.VERIFY_CONTEXT=Fr,J.VERIFY_SERVER=Xn,J.Verify=da,J.default=zr,Object.defineProperty(J,"__esModule",{value:!0})});
+	***************************************************************************** */var Jn=function(t,e){return Jn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var i in n)n.hasOwnProperty(i)&&(r[i]=n[i])},Jn(t,e)};function zd(t,e){Jn(t,e);function r(){this.constructor=t}t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}var Zn=function(){return Zn=Object.assign||function(e){for(var r,n=1,i=arguments.length;n<i;n++){r=arguments[n];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},Zn.apply(this,arguments)};function Hd(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(t);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(t,n[i])&&(r[n[i]]=t[n[i]]);return r}function Kd(t,e,r,n){var i=arguments.length,s=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(t,e,r,n);else for(var u=t.length-1;u>=0;u--)(c=t[u])&&(s=(i<3?c(s):i>3?c(e,r,s):c(e,r))||s);return i>3&&s&&Object.defineProperty(e,r,s),s}function Gd(t,e){return function(r,n){e(r,n,t)}}function Vd(t,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(t,e)}function qd(t,e,r,n){function i(s){return s instanceof r?s:new r(function(c){c(s)})}return new(r||(r=Promise))(function(s,c){function u(_){try{f(n.next(_))}catch(O){c(O)}}function h(_){try{f(n.throw(_))}catch(O){c(O)}}function f(_){_.done?s(_.value):i(_.value).then(u,h)}f((n=n.apply(t,e||[])).next())})}function Yd(t,e){var r={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,c;return c={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function u(f){return function(_){return h([f,_])}}function h(f){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(s=f[0]&2?i.return:f[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,f[1])).done)return s;switch(i=0,s&&(f=[f[0]&2,s.value]),f[0]){case 0:case 1:s=f;break;case 4:return r.label++,{value:f[1],done:!1};case 5:r.label++,i=f[1],f=[0];continue;case 7:f=r.ops.pop(),r.trys.pop();continue;default:if(s=r.trys,!(s=s.length>0&&s[s.length-1])&&(f[0]===6||f[0]===2)){r=0;continue}if(f[0]===3&&(!s||f[1]>s[0]&&f[1]<s[3])){r.label=f[1];break}if(f[0]===6&&r.label<s[1]){r.label=s[1],s=f;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(f);break}s[2]&&r.ops.pop(),r.trys.pop();continue}f=e.call(t,r)}catch(_){f=[6,_],i=0}finally{n=s=0}if(f[0]&5)throw f[1];return{value:f[0]?f[1]:void 0,done:!0}}}function Wd(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}function Xd(t,e){for(var r in t)r!=="default"&&!e.hasOwnProperty(r)&&(e[r]=t[r])}function Qn(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Ho(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var n=r.call(t),i,s=[],c;try{for(;(e===void 0||e-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(u){c={error:u}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(c)throw c.error}}return s}function kd(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(Ho(arguments[e]));return t}function Jd(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;for(var n=Array(t),i=0,e=0;e<r;e++)for(var s=arguments[e],c=0,u=s.length;c<u;c++,i++)n[i]=s[c];return n}function _r(t){return this instanceof _r?(this.v=t,this):new _r(t)}function Zd(t,e,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(t,e||[]),i,s=[];return i={},c("next"),c("throw"),c("return"),i[Symbol.asyncIterator]=function(){return this},i;function c(p){n[p]&&(i[p]=function(E){return new Promise(function(A,C){s.push([p,E,A,C])>1||u(p,E)})})}function u(p,E){try{h(n[p](E))}catch(A){O(s[0][3],A)}}function h(p){p.value instanceof _r?Promise.resolve(p.value.v).then(f,_):O(s[0][2],p)}function f(p){u("next",p)}function _(p){u("throw",p)}function O(p,E){p(E),s.shift(),s.length&&u(s[0][0],s[0][1])}}function Qd(t){var e,r;return e={},n("next"),n("throw",function(i){throw i}),n("return"),e[Symbol.iterator]=function(){return this},e;function n(i,s){e[i]=t[i]?function(c){return(r=!r)?{value:_r(t[i](c)),done:i==="return"}:s?s(c):c}:s}}function e0(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=t[Symbol.asyncIterator],r;return e?e.call(t):(t=typeof Qn=="function"?Qn(t):t[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(s){r[s]=t[s]&&function(c){return new Promise(function(u,h){c=t[s](c),i(u,h,c.done,c.value)})}}function i(s,c,u,h){Promise.resolve(h).then(function(f){s({value:f,done:u})},c)}}function t0(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t}function r0(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)Object.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e.default=t,e}function n0(t){return t&&t.__esModule?t:{default:t}}function i0(t,e){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return e.get(t)}function s0(t,e,r){if(!e.has(t))throw new TypeError("attempted to set private field on non-instance");return e.set(t,r),r}var o0=Object.freeze({__proto__:null,__extends:zd,get __assign(){return Zn},__rest:Hd,__decorate:Kd,__param:Gd,__metadata:Vd,__awaiter:qd,__generator:Yd,__createBinding:Wd,__exportStar:Xd,__values:Qn,__read:Ho,__spread:kd,__spreadArrays:Jd,__await:_r,__asyncGenerator:Zd,__asyncDelegator:Qd,__asyncValues:e0,__makeTemplateObject:t0,__importStar:r0,__importDefault:n0,__classPrivateFieldGet:i0,__classPrivateFieldSet:s0}),a0=Rt(o0),Et={},Ko;function c0(){if(Ko)return Et;Ko=1,Object.defineProperty(Et,"__esModule",{value:!0}),Et.isBrowserCryptoAvailable=Et.getSubtleCrypto=Et.getBrowerCrypto=void 0;function t(){return Je?.crypto||Je?.msCrypto||{}}Et.getBrowerCrypto=t;function e(){const n=t();return n.subtle||n.webkitSubtle}Et.getSubtleCrypto=e;function r(){return!!t()&&!!e()}return Et.isBrowserCryptoAvailable=r,Et}var wt={},Go;function u0(){if(Go)return wt;Go=1,Object.defineProperty(wt,"__esModule",{value:!0}),wt.isBrowser=wt.isNode=wt.isReactNative=void 0;function t(){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"}wt.isReactNative=t;function e(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}wt.isNode=e;function r(){return!t()&&!e()}return wt.isBrowser=r,wt}(function(t){Object.defineProperty(t,"__esModule",{value:!0});const e=a0;e.__exportStar(c0(),t),e.__exportStar(u0(),t)})(zo);function Vo(t=3){const e=Date.now()*Math.pow(10,t),r=Math.floor(Math.random()*Math.pow(10,t));return e+r}function qo(t=6){return BigInt(Vo(t))}function ei(t,e,r){return{id:r||Vo(),jsonrpc:"2.0",method:t,params:e}}function Yo(t,e){return{id:t,jsonrpc:"2.0",result:e}}function Wo(t,e,r){return{id:t,jsonrpc:"2.0",error:f0(e,r)}}function f0(t,e){return typeof t>"u"?Bo($o):(typeof t=="string"&&(t=Object.assign(Object.assign({},Bo(kn)),{message:t})),typeof e<"u"&&(t.data=e),$d(t.code)&&(t=Fd(t.code)),t)}class h0{}class l0 extends h0{constructor(){super()}}class d0 extends l0{constructor(e){super()}}const g0="^wss?:";function _0(t){const e=t.match(new RegExp(/^\w+:/,"gi"));if(!(!e||!e.length))return e[0]}function y0(t,e){const r=_0(t);return typeof r>"u"?!1:new RegExp(e).test(r)}function Xo(t){return y0(t,g0)}function p0(t){return new RegExp("wss?://localhost(:d{2,5})?").test(t)}function ko(t){return typeof t=="object"&&"id"in t&&"jsonrpc"in t&&t.jsonrpc==="2.0"}function Jo(t){return ko(t)&&"method"in t}function ti(t){return ko(t)&&(Zo(t)||Br(t))}function Zo(t){return"result"in t}function Br(t){return"error"in t}class b0 extends d0{constructor(e){super(e),this.events=new ut.exports.EventEmitter,this.hasRegisteredEventListeners=!1,this.connection=this.setConnection(e),this.connection.connected&&this.registerEventListeners()}async connect(e=this.connection){await this.open(e)}async disconnect(){await this.close()}on(e,r){this.events.on(e,r)}once(e,r){this.events.once(e,r)}off(e,r){this.events.off(e,r)}removeListener(e,r){this.events.removeListener(e,r)}async request(e,r){return this.requestStrict(ei(e.method,e.params||[],e.id||qo().toString()),r)}async requestStrict(e,r){return new Promise(async(n,i)=>{if(!this.connection.connected)try{await this.open()}catch(s){i(s)}this.events.on(`${e.id}`,s=>{Br(s)?i(s.error):n(s.result)});try{await this.connection.send(e,r)}catch(s){i(s)}})}setConnection(e=this.connection){return e}onPayload(e){this.events.emit("payload",e),ti(e)?this.events.emit(`${e.id}`,e):this.events.emit("message",{type:e.method,data:e.params})}onClose(e){e&&e.code===3e3&&this.events.emit("error",new Error(`WebSocket connection closed abnormally with code: ${e.code} ${e.reason?`(${e.reason})`:""}`)),this.events.emit("disconnect")}async open(e=this.connection){this.connection===e&&this.connection.connected||(this.connection.connected&&this.close(),typeof e=="string"&&(await this.connection.open(e),e=this.connection),this.connection=this.setConnection(e),await this.connection.open(),this.registerEventListeners(),this.events.emit("connect"))}async close(){await this.connection.close()}registerEventListeners(){this.hasRegisteredEventListeners||(this.connection.on("payload",e=>this.onPayload(e)),this.connection.on("close",e=>this.onClose(e)),this.connection.on("error",e=>this.events.emit("error",e)),this.connection.on("register_error",e=>this.onClose()),this.hasRegisteredEventListeners=!0)}}const Qo=10,v0=()=>typeof global<"u"&&typeof global.WebSocket<"u"?global.WebSocket:typeof window<"u"&&typeof window.WebSocket<"u"?window.WebSocket:require("ws"),E0=()=>typeof window<"u",w0=v0();class m0{constructor(e){if(this.url=e,this.events=new ut.exports.EventEmitter,this.registering=!1,!Xo(e))throw new Error(`Provided URL is not compatible with WebSocket connection: ${e}`);this.url=e}get connected(){return typeof this.socket<"u"}get connecting(){return this.registering}on(e,r){this.events.on(e,r)}once(e,r){this.events.once(e,r)}off(e,r){this.events.off(e,r)}removeListener(e,r){this.events.removeListener(e,r)}async open(e=this.url){await this.register(e)}async close(){return new Promise((e,r)=>{if(typeof this.socket>"u"){r(new Error("Connection already closed"));return}this.socket.onclose=n=>{this.onClose(n),e()},this.socket.close()})}async send(e,r){typeof this.socket>"u"&&(this.socket=await this.register());try{this.socket.send(pn(e))}catch(n){this.onError(e.id,n)}}register(e=this.url){if(!Xo(e))throw new Error(`Provided URL is not compatible with WebSocket connection: ${e}`);if(this.registering){const r=this.events.getMaxListeners();return(this.events.listenerCount("register_error")>=r||this.events.listenerCount("open")>=r)&&this.events.setMaxListeners(r+1),new Promise((n,i)=>{this.events.once("register_error",s=>{this.resetMaxListeners(),i(s)}),this.events.once("open",()=>{if(this.resetMaxListeners(),typeof this.socket>"u")return i(new Error("WebSocket connection is missing or invalid"));n(this.socket)})})}return this.url=e,this.registering=!0,new Promise((r,n)=>{const i=zo.isReactNative()?void 0:{rejectUnauthorized:!p0(e)},s=new w0(e,[],i);E0()?s.onerror=c=>{const u=c;n(this.emitError(u.error))}:s.on("error",c=>{n(this.emitError(c))}),s.onopen=()=>{this.onOpen(s),r(s)}})}onOpen(e){e.onmessage=r=>this.onPayload(r),e.onclose=r=>this.onClose(r),this.socket=e,this.registering=!1,this.events.emit("open")}onClose(e){this.socket=void 0,this.registering=!1,this.events.emit("close",e)}onPayload(e){if(typeof e.data>"u")return;const r=typeof e.data=="string"?Wi(e.data):e.data;this.events.emit("payload",r)}onError(e,r){const n=this.parseError(r),i=n.message||n.toString(),s=Wo(e,i);this.events.emit("payload",s)}parseError(e,r=this.url){return Bd(e,r,"WS")}resetMaxListeners(){this.events.getMaxListeners()>Qo&&this.events.setMaxListeners(Qo)}emitError(e){const r=this.parseError(new Error(e?.message||`WebSocket connection failed for URL: ${this.url}`));return this.events.emit("register_error",r),r}}class D0 extends Nu{constructor(e,r){super(e,r),this.relayer=e,this.logger=r,this.events=new ut.exports.EventEmitter,this.name=po,this.queue=new Map,this.publishTimeout=1e4,this.publish=async(n,i,s)=>{this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:n,message:i,opts:s}});try{const c=s?.ttl||yo,u=Gn(s),h=s?.prompt||!1,f=s?.tag||0,_=s?.id||qo().toString(),O={topic:n,message:i,opts:{ttl:c,relay:u,prompt:h,tag:f,id:_}};this.queue.set(_,O);try{await await Ur(this.rpcPublish(n,i,c,u,h,f,_),this.publishTimeout),this.relayer.events.emit(ze.publish,O)}catch{this.logger.debug("Publishing Payload stalled"),this.relayer.events.emit(ze.connection_stalled);return}this.logger.debug("Successfully Published Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:n,message:i,opts:s}})}catch(c){throw this.logger.debug("Failed to Publish Payload"),this.logger.error(c),c}},this.on=(n,i)=>{this.events.on(n,i)},this.once=(n,i)=>{this.events.once(n,i)},this.off=(n,i)=>{this.events.off(n,i)},this.removeListener=(n,i)=>{this.events.removeListener(n,i)},this.relayer=e,this.logger=Se.generateChildLogger(r,this.name),this.registerEventListeners()}get context(){return Se.getLoggerContext(this.logger)}rpcPublish(e,r,n,i,s,c,u){var h,f,_,O;const p={method:Mr(i.protocol).publish,params:{topic:e,message:r,ttl:n,prompt:s,tag:c},id:u};return jr((h=p.params)==null?void 0:h.prompt)&&((f=p.params)==null||delete f.prompt),jr((_=p.params)==null?void 0:_.tag)&&((O=p.params)==null||delete O.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:p}),this.relayer.request(p)}onPublish(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async e=>{const{topic:r,message:n,opts:i}=e;await this.publish(r,n,i)})}registerEventListeners(){this.relayer.core.heartbeat.on(er.HEARTBEAT_EVENTS.pulse,()=>{this.checkQueue()}),this.relayer.on(ze.message_ack,e=>{this.onPublish(e.id.toString())})}}class S0{constructor(){this.map=new Map,this.set=(e,r)=>{const n=this.get(e);this.exists(e,r)||this.map.set(e,[...n,r])},this.get=e=>this.map.get(e)||[],this.exists=(e,r)=>this.get(e).includes(r),this.delete=(e,r)=>{if(typeof r>"u"){this.map.delete(e);return}if(!this.map.has(e))return;const n=this.get(e);if(!this.exists(e,r))return;const i=n.filter(s=>s!==r);if(!i.length){this.map.delete(e);return}this.map.set(e,i)},this.clear=()=>{this.map.clear()}}get topics(){return Array.from(this.map.keys())}}var O0=Object.defineProperty,x0=Object.defineProperties,T0=Object.getOwnPropertyDescriptors,ea=Object.getOwnPropertySymbols,I0=Object.prototype.hasOwnProperty,R0=Object.prototype.propertyIsEnumerable,ta=(t,e,r)=>e in t?O0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,yr=(t,e)=>{for(var r in e||(e={}))I0.call(e,r)&&ta(t,r,e[r]);if(ea)for(var r of ea(e))R0.call(e,r)&&ta(t,r,e[r]);return t},ri=(t,e)=>x0(t,T0(e));class ra extends ju{constructor(e,r){super(e,r),this.relayer=e,this.logger=r,this.subscriptions=new Map,this.topicMap=new S0,this.events=new ut.exports.EventEmitter,this.name=xo,this.version=To,this.pending=new Map,this.cached=[],this.initialized=!1,this.pendingSubscriptionWatchLabel="pending_sub_watch_label",this.pollingInterval=20,this.storagePrefix=vt,this.subscribeTimeout=1e4,this.restartInProgress=!1,this.batchSubscribeTopicsLimit=500,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restart(),this.registerEventListeners(),this.onEnable(),this.clientId=await this.relayer.core.crypto.getClientId())},this.subscribe=async(n,i)=>{await this.restartToComplete(),this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:n,opts:i}});try{const s=Gn(i),c={topic:n,relay:s};this.pending.set(n,c);const u=await this.rpcSubscribe(n,s);return this.onSubscribe(u,c),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:n,opts:i}}),u}catch(s){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(s),s}},this.unsubscribe=async(n,i)=>{await this.restartToComplete(),this.isInitialized(),typeof i?.id<"u"?await this.unsubscribeById(n,i.id,i):await this.unsubscribeByTopic(n,i)},this.isSubscribed=async n=>this.topics.includes(n)?!0:await new Promise((i,s)=>{const c=new ye.Watch;c.start(this.pendingSubscriptionWatchLabel);const u=setInterval(()=>{!this.pending.has(n)&&this.topics.includes(n)&&(clearInterval(u),c.stop(this.pendingSubscriptionWatchLabel),i(!0)),c.elapsed(this.pendingSubscriptionWatchLabel)>=Io&&(clearInterval(u),c.stop(this.pendingSubscriptionWatchLabel),s(new Error("Subscription resolution timeout")))},this.pollingInterval)}).catch(()=>!1),this.on=(n,i)=>{this.events.on(n,i)},this.once=(n,i)=>{this.events.once(n,i)},this.off=(n,i)=>{this.events.off(n,i)},this.removeListener=(n,i)=>{this.events.removeListener(n,i)},this.restart=async()=>{this.restartInProgress=!0,await this.restore(),await this.reset(),this.restartInProgress=!1},this.relayer=e,this.logger=Se.generateChildLogger(r,this.name),this.clientId=""}get context(){return Se.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}hasSubscription(e,r){let n=!1;try{n=this.getSubscription(e).topic===r}catch{}return n}onEnable(){this.cached=[],this.initialized=!0}onDisable(){this.cached=this.values,this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,r){const n=this.topicMap.get(e);await Promise.all(n.map(async i=>await this.unsubscribeById(e,i,r)))}async unsubscribeById(e,r,n){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:r,opts:n}});try{const i=Gn(n);await this.rpcUnsubscribe(e,r,i);const s=dr("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,r,s),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:r,opts:n}})}catch(i){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(i),i}}async rpcSubscribe(e,r){const n={method:Mr(r.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:n});try{await await Ur(this.relayer.request(n),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(ze.connection_stalled)}return Bn(e+this.clientId)}async rpcBatchSubscribe(e){if(!e.length)return;const r=e[0].relay,n={method:Mr(r.protocol).batchSubscribe,params:{topics:e.map(i=>i.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:n});try{return await await Ur(this.relayer.request(n),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Payload stalled"),this.relayer.events.emit(ze.connection_stalled)}}rpcUnsubscribe(e,r,n){const i={method:Mr(n.protocol).unsubscribe,params:{topic:e,id:r}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i}),this.relayer.request(i)}onSubscribe(e,r){this.setSubscription(e,ri(yr({},r),{id:e})),this.pending.delete(r.topic)}onBatchSubscribe(e){e.length&&e.forEach(r=>{this.setSubscription(r.id,yr({},r)),this.pending.delete(r.topic)})}async onUnsubscribe(e,r,n){this.events.removeAllListeners(r),this.hasSubscription(r,e)&&this.deleteSubscription(r,n),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,r){this.subscriptions.has(e)||(this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:r}),this.addSubscription(e,r))}addSubscription(e,r){this.subscriptions.set(e,yr({},r)),this.topicMap.set(r.topic,e),this.events.emit(dt.created,r)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});const r=this.subscriptions.get(e);if(!r){const{message:n}=Te("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(n)}return r}deleteSubscription(e,r){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:r});const n=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(n.topic,e),this.events.emit(dt.deleted,ri(yr({},n),{reason:r}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(dt.sync)}async reset(){if(this.cached.length){const e=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let r=0;r<e;r++){const n=this.cached.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(n)}}this.events.emit(dt.resubscribed)}async restore(){try{const e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){const{message:r}=Te("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(r),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(r)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){if(!e.length)return;const r=await this.rpcBatchSubscribe(e);Od(r)&&this.onBatchSubscribe(r.map((n,i)=>ri(yr({},e[i]),{id:n})))}async onConnect(){this.restartInProgress||(await this.restart(),this.onEnable())}onDisconnect(){this.onDisable()}async checkPending(){if(this.relayer.transportExplicitlyClosed)return;const e=[];this.pending.forEach(r=>{e.push(r)}),await this.batchSubscribe(e)}registerEventListeners(){this.relayer.core.heartbeat.on(er.HEARTBEAT_EVENTS.pulse,async()=>{await this.checkPending()}),this.relayer.on(ze.connect,async()=>{await this.onConnect()}),this.relayer.on(ze.disconnect,()=>{this.onDisconnect()}),this.events.on(dt.created,async e=>{const r=dt.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:e}),await this.persist()}),this.events.on(dt.deleted,async e=>{const r=dt.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:e}),await this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(){this.restartInProgress&&await new Promise(e=>{const r=setInterval(()=>{this.restartInProgress||(clearInterval(r),e())},this.pollingInterval)})}}var A0=Object.defineProperty,na=Object.getOwnPropertySymbols,C0=Object.prototype.hasOwnProperty,P0=Object.prototype.propertyIsEnumerable,ia=(t,e,r)=>e in t?A0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,L0=(t,e)=>{for(var r in e||(e={}))C0.call(e,r)&&ia(t,r,e[r]);if(na)for(var r of na(e))P0.call(e,r)&&ia(t,r,e[r]);return t};class sa extends Uu{constructor(e){super(e),this.protocol="wc",this.version=2,this.events=new ut.exports.EventEmitter,this.name=Eo,this.transportExplicitlyClosed=!1,this.initialized=!1,this.reconnecting=!1,this.connectionStatusPollingInterval=20,this.staleConnectionErrors=["socket hang up","socket stalled"],this.request=async r=>{this.logger.debug("Publishing Request Payload");try{return await this.toEstablishConnection(),await this.provider.request(r)}catch(n){throw this.logger.debug("Failed to Publish Request"),this.logger.error(n),n}},this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?Se.generateChildLogger(e.logger,this.name):Se.pino(Se.getDefaultLoggerOptions({level:e.logger||vo})),this.messages=new jo(this.logger,e.core),this.subscriber=new ra(this,this.logger),this.publisher=new D0(this,this.logger),this.relayUrl=e?.relayUrl||Wn,this.projectId=e.projectId,this.provider={}}async init(){this.logger.trace("Initialized"),await this.createProvider(),await Promise.all([this.messages.init(),this.transportOpen(),this.subscriber.init()]),this.registerEventListeners(),this.initialized=!0,setTimeout(async()=>{this.subscriber.topics.length===0&&(this.logger.info("No topics subscribted to after init, closing transport"),await this.transportClose(),this.transportExplicitlyClosed=!1)},So)}get context(){return Se.getLoggerContext(this.logger)}get connected(){return this.provider.connection.connected}get connecting(){return this.provider.connection.connecting}async publish(e,r,n){this.isInitialized(),await this.publisher.publish(e,r,n),await this.recordMessageEvent({topic:e,message:r,publishedAt:Date.now()})}async subscribe(e,r){var n;this.isInitialized();let i=((n=this.subscriber.topicMap.get(e))==null?void 0:n[0])||"";return i||(await Promise.all([new Promise(s=>{this.subscriber.once(dt.created,c=>{c.topic===e&&s()})}),new Promise(async s=>{i=await this.subscriber.subscribe(e,r),s()})]),i)}async unsubscribe(e,r){this.isInitialized(),await this.subscriber.unsubscribe(e,r)}on(e,r){this.events.on(e,r)}once(e,r){this.events.once(e,r)}off(e,r){this.events.off(e,r)}removeListener(e,r){this.events.removeListener(e,r)}async transportClose(){this.transportExplicitlyClosed=!0,this.connected&&(await this.provider.disconnect(),this.events.emit(ze.transport_closed))}async transportOpen(e){if(this.transportExplicitlyClosed=!1,!this.reconnecting){this.relayUrl=e||this.relayUrl,this.reconnecting=!0;try{await Promise.all([new Promise(r=>{this.initialized||r(),this.subscriber.once(dt.resubscribed,()=>{r()})}),await Promise.race([new Promise(async(r,n)=>{await Ur(this.provider.connect(),1e4,"socket stalled").catch(i=>n(i)).then(()=>r()).finally(()=>this.removeListener(ze.transport_closed,this.rejectTransportOpen))}),new Promise(r=>this.once(ze.transport_closed,this.rejectTransportOpen))])])}catch(r){this.logger.error(r);const n=r;if(!this.isConnectionStalled(n.message))throw r;this.events.emit(ze.transport_closed)}finally{this.reconnecting=!1}}}async restartTransport(e){this.transportExplicitlyClosed||this.reconnecting||(this.relayUrl=e||this.relayUrl,this.connected&&await Promise.all([new Promise(r=>{this.provider.once(qt.disconnect,()=>{r()})}),this.transportClose()]),await this.createProvider(),await this.transportOpen())}isConnectionStalled(e){return this.staleConnectionErrors.some(r=>e.includes(r))}rejectTransportOpen(){throw new Error("closeTransport called before connection was established")}async createProvider(){const e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new b0(new m0(cd({sdkVersion:Do,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0}))),this.registerProviderListeners()}async recordMessageEvent(e){const{topic:r,message:n}=e;await this.messages.set(r,n)}async shouldIgnoreMessageEvent(e){const{topic:r,message:n}=e;return await this.subscriber.isSubscribed(r)?this.messages.has(r,n):!0}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),Jo(e)){if(!e.method.endsWith(wo))return;const r=e.params,{topic:n,message:i,publishedAt:s}=r.data,c={topic:n,message:i,publishedAt:s};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(L0({type:"event",event:r.id},c)),this.events.emit(r.id,c),await this.acknowledgePayload(e),await this.onMessageEvent(c)}else ti(e)&&this.events.emit(ze.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(this.events.emit(ze.message,e),await this.recordMessageEvent(e))}async acknowledgePayload(e){const r=Yo(e.id,!0);await this.provider.connection.send(r)}registerProviderListeners(){this.provider.on(qt.payload,e=>this.onProviderPayload(e)),this.provider.on(qt.connect,()=>{this.events.emit(ze.connect)}),this.provider.on(qt.disconnect,()=>{this.onProviderDisconnect()}),this.provider.on(qt.error,e=>{this.logger.error(e),this.events.emit(ze.error,e)})}registerEventListeners(){this.events.on(ze.connection_stalled,async()=>{await this.restartTransport()})}onProviderDisconnect(){this.events.emit(ze.disconnect),this.attemptToReconnect()}attemptToReconnect(){this.transportExplicitlyClosed||setTimeout(async()=>{await this.restartTransport()},ye.toMiliseconds(mo))}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(!this.connected){if(this.connecting)return await new Promise(e=>{const r=setInterval(()=>{this.connected&&(clearInterval(r),e())},this.connectionStatusPollingInterval)});await this.restartTransport()}}}var ni={exports:{}};(function(t,e){var r=200,n="__lodash_hash_undefined__",i=1,s=2,c=9007199254740991,u="[object Arguments]",h="[object Array]",f="[object AsyncFunction]",_="[object Boolean]",O="[object Date]",p="[object Error]",E="[object Function]",A="[object GeneratorFunction]",C="[object Map]",U="[object Number]",Y="[object Null]",S="[object Object]",R="[object Promise]",b="[object Proxy]",v="[object RegExp]",d="[object Set]",o="[object String]",l="[object Symbol]",L="[object Undefined]",P="[object WeakMap]",H="[object ArrayBuffer]",G="[object DataView]",k="[object Float32Array]",D="[object Float64Array]",I="[object Int8Array]",V="[object Int16Array]",F="[object Int32Array]",M="[object Uint8Array]",$="[object Uint8ClampedArray]",N="[object Uint16Array]",B="[object Uint32Array]",ee=/[\\^$.*+?()[\]{}|]/g,z=/^\[object .+?Constructor\]$/,Z=/^(?:0|[1-9]\d*)$/,W={};W[k]=W[D]=W[I]=W[V]=W[F]=W[M]=W[$]=W[N]=W[B]=!0,W[u]=W[h]=W[H]=W[_]=W[G]=W[O]=W[p]=W[E]=W[C]=W[U]=W[S]=W[v]=W[d]=W[o]=W[P]=!1;var Q=typeof Je=="object"&&Je&&Je.Object===Object&&Je,T=typeof self=="object"&&self&&self.Object===Object&&self,x=Q||T||Function("return this")(),w=e&&!e.nodeType&&e,a=w&&!0&&t&&!t.nodeType&&t,y=a&&a.exports===w,K=y&&Q.process,q=function(){try{return K&&K.binding&&K.binding("util")}catch{}}(),fe=q&&q.isTypedArray;function pe(g,m){for(var j=-1,X=g==null?0:g.length,Ie=0,ie=[];++j<X;){var Ne=g[j];m(Ne,j,g)&&(ie[Ie++]=Ne)}return ie}function le(g,m){for(var j=-1,X=m.length,Ie=g.length;++j<X;)g[Ie+j]=m[j];return g}function Ee(g,m){for(var j=-1,X=g==null?0:g.length;++j<X;)if(m(g[j],j,g))return!0;return!1}function Ue(g,m){for(var j=-1,X=Array(g);++j<g;)X[j]=m(j);return X}function Ce(g){return function(m){return g(m)}}function _e(g,m){return g.has(m)}function de(g,m){return g?.[m]}function he(g){var m=-1,j=Array(g.size);return g.forEach(function(X,Ie){j[++m]=[Ie,X]}),j}function ce(g,m){return function(j){return g(m(j))}}function ae(g){var m=-1,j=Array(g.size);return g.forEach(function(X){j[++m]=X}),j}var oe=Array.prototype,se=Function.prototype,te=Object.prototype,ue=x["__core-js_shared__"],ge=se.toString,ne=te.hasOwnProperty,be=function(){var g=/[^.]+$/.exec(ue&&ue.keys&&ue.keys.IE_PROTO||"");return g?"Symbol(src)_1."+g:""}(),ve=te.toString,me=RegExp("^"+ge.call(ne).replace(ee,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),De=y?x.Buffer:void 0,we=x.Symbol,_t=x.Uint8Array,bt=te.propertyIsEnumerable,Ot=oe.splice,at=we?we.toStringTag:void 0,Mt=Object.getOwnPropertySymbols,pr=De?De.isBuffer:void 0,Hr=ce(Object.keys,Object),Me=Wt(x,"DataView"),Pe=Wt(x,"Map"),je=Wt(x,"Promise"),$e=Wt(x,"Set"),Fe=Wt(x,"WeakMap"),Le=Wt(Object,"create"),Ke=$t(Me),Ge=$t(Pe),Ve=$t(je),qe=$t($e),Ye=$t(Fe),He=we?we.prototype:void 0,Be=He?He.valueOf:void 0;function Re(g){var m=-1,j=g==null?0:g.length;for(this.clear();++m<j;){var X=g[m];this.set(X[0],X[1])}}function We(){this.__data__=Le?Le(null):{},this.size=0}function Xe(g){var m=this.has(g)&&delete this.__data__[g];return this.size-=m?1:0,m}function H0(g){var m=this.__data__;if(Le){var j=m[g];return j===n?void 0:j}return ne.call(m,g)?m[g]:void 0}function K0(g){var m=this.__data__;return Le?m[g]!==void 0:ne.call(m,g)}function G0(g,m){var j=this.__data__;return this.size+=this.has(g)?0:1,j[g]=Le&&m===void 0?n:m,this}Re.prototype.clear=We,Re.prototype.delete=Xe,Re.prototype.get=H0,Re.prototype.has=K0,Re.prototype.set=G0;function mt(g){var m=-1,j=g==null?0:g.length;for(this.clear();++m<j;){var X=g[m];this.set(X[0],X[1])}}function V0(){this.__data__=[],this.size=0}function q0(g){var m=this.__data__,j=Gr(m,g);if(j<0)return!1;var X=m.length-1;return j==X?m.pop():Ot.call(m,j,1),--this.size,!0}function Y0(g){var m=this.__data__,j=Gr(m,g);return j<0?void 0:m[j][1]}function W0(g){return Gr(this.__data__,g)>-1}function X0(g,m){var j=this.__data__,X=Gr(j,g);return X<0?(++this.size,j.push([g,m])):j[X][1]=m,this}mt.prototype.clear=V0,mt.prototype.delete=q0,mt.prototype.get=Y0,mt.prototype.has=W0,mt.prototype.set=X0;function jt(g){var m=-1,j=g==null?0:g.length;for(this.clear();++m<j;){var X=g[m];this.set(X[0],X[1])}}function k0(){this.size=0,this.__data__={hash:new Re,map:new(Pe||mt),string:new Re}}function J0(g){var m=Vr(this,g).delete(g);return this.size-=m?1:0,m}function Z0(g){return Vr(this,g).get(g)}function Q0(g){return Vr(this,g).has(g)}function eg(g,m){var j=Vr(this,g),X=j.size;return j.set(g,m),this.size+=j.size==X?0:1,this}jt.prototype.clear=k0,jt.prototype.delete=J0,jt.prototype.get=Z0,jt.prototype.has=Q0,jt.prototype.set=eg;function Kr(g){var m=-1,j=g==null?0:g.length;for(this.__data__=new jt;++m<j;)this.add(g[m])}function tg(g){return this.__data__.set(g,n),this}function rg(g){return this.__data__.has(g)}Kr.prototype.add=Kr.prototype.push=tg,Kr.prototype.has=rg;function xt(g){var m=this.__data__=new mt(g);this.size=m.size}function ng(){this.__data__=new mt,this.size=0}function ig(g){var m=this.__data__,j=m.delete(g);return this.size=m.size,j}function sg(g){return this.__data__.get(g)}function og(g){return this.__data__.has(g)}function ag(g,m){var j=this.__data__;if(j instanceof mt){var X=j.__data__;if(!Pe||X.length<r-1)return X.push([g,m]),this.size=++j.size,this;j=this.__data__=new jt(X)}return j.set(g,m),this.size=j.size,this}xt.prototype.clear=ng,xt.prototype.delete=ig,xt.prototype.get=sg,xt.prototype.has=og,xt.prototype.set=ag;function cg(g,m){var j=qr(g),X=!j&&Dg(g),Ie=!j&&!X&&ii(g),ie=!j&&!X&&!Ie&&Oa(g),Ne=j||X||Ie||ie,ke=Ne?Ue(g.length,String):[],Qe=ke.length;for(var Ae in g)(m||ne.call(g,Ae))&&!(Ne&&(Ae=="length"||Ie&&(Ae=="offset"||Ae=="parent")||ie&&(Ae=="buffer"||Ae=="byteLength"||Ae=="byteOffset")||bg(Ae,Qe)))&&ke.push(Ae);return ke}function Gr(g,m){for(var j=g.length;j--;)if(wa(g[j][0],m))return j;return-1}function ug(g,m,j){var X=m(g);return qr(g)?X:le(X,j(g))}function br(g){return g==null?g===void 0?L:Y:at&&at in Object(g)?yg(g):mg(g)}function pa(g){return vr(g)&&br(g)==u}function ba(g,m,j,X,Ie){return g===m?!0:g==null||m==null||!vr(g)&&!vr(m)?g!==g&&m!==m:fg(g,m,j,X,ba,Ie)}function fg(g,m,j,X,Ie,ie){var Ne=qr(g),ke=qr(m),Qe=Ne?h:Tt(g),Ae=ke?h:Tt(m);Qe=Qe==u?S:Qe,Ae=Ae==u?S:Ae;var ct=Qe==S,yt=Ae==S,tt=Qe==Ae;if(tt&&ii(g)){if(!ii(m))return!1;Ne=!0,ct=!1}if(tt&&!ct)return ie||(ie=new xt),Ne||Oa(g)?va(g,m,j,X,Ie,ie):gg(g,m,Qe,j,X,Ie,ie);if(!(j&i)){var ht=ct&&ne.call(g,"__wrapped__"),lt=yt&&ne.call(m,"__wrapped__");if(ht||lt){var It=ht?g.value():g,Dt=lt?m.value():m;return ie||(ie=new xt),Ie(It,Dt,j,X,ie)}}return tt?(ie||(ie=new xt),_g(g,m,j,X,Ie,ie)):!1}function hg(g){if(!Sa(g)||Eg(g))return!1;var m=ma(g)?me:z;return m.test($t(g))}function lg(g){return vr(g)&&Da(g.length)&&!!W[br(g)]}function dg(g){if(!wg(g))return Hr(g);var m=[];for(var j in Object(g))ne.call(g,j)&&j!="constructor"&&m.push(j);return m}function va(g,m,j,X,Ie,ie){var Ne=j&i,ke=g.length,Qe=m.length;if(ke!=Qe&&!(Ne&&Qe>ke))return!1;var Ae=ie.get(g);if(Ae&&ie.get(m))return Ae==m;var ct=-1,yt=!0,tt=j&s?new Kr:void 0;for(ie.set(g,m),ie.set(m,g);++ct<ke;){var ht=g[ct],lt=m[ct];if(X)var It=Ne?X(lt,ht,ct,m,g,ie):X(ht,lt,ct,g,m,ie);if(It!==void 0){if(It)continue;yt=!1;break}if(tt){if(!Ee(m,function(Dt,Ft){if(!_e(tt,Ft)&&(ht===Dt||Ie(ht,Dt,j,X,ie)))return tt.push(Ft)})){yt=!1;break}}else if(!(ht===lt||Ie(ht,lt,j,X,ie))){yt=!1;break}}return ie.delete(g),ie.delete(m),yt}function gg(g,m,j,X,Ie,ie,Ne){switch(j){case G:if(g.byteLength!=m.byteLength||g.byteOffset!=m.byteOffset)return!1;g=g.buffer,m=m.buffer;case H:return!(g.byteLength!=m.byteLength||!ie(new _t(g),new _t(m)));case _:case O:case U:return wa(+g,+m);case p:return g.name==m.name&&g.message==m.message;case v:case o:return g==m+"";case C:var ke=he;case d:var Qe=X&i;if(ke||(ke=ae),g.size!=m.size&&!Qe)return!1;var Ae=Ne.get(g);if(Ae)return Ae==m;X|=s,Ne.set(g,m);var ct=va(ke(g),ke(m),X,Ie,ie,Ne);return Ne.delete(g),ct;case l:if(Be)return Be.call(g)==Be.call(m)}return!1}function _g(g,m,j,X,Ie,ie){var Ne=j&i,ke=Ea(g),Qe=ke.length,Ae=Ea(m),ct=Ae.length;if(Qe!=ct&&!Ne)return!1;for(var yt=Qe;yt--;){var tt=ke[yt];if(!(Ne?tt in m:ne.call(m,tt)))return!1}var ht=ie.get(g);if(ht&&ie.get(m))return ht==m;var lt=!0;ie.set(g,m),ie.set(m,g);for(var It=Ne;++yt<Qe;){tt=ke[yt];var Dt=g[tt],Ft=m[tt];if(X)var xa=Ne?X(Ft,Dt,tt,m,g,ie):X(Dt,Ft,tt,g,m,ie);if(!(xa===void 0?Dt===Ft||Ie(Dt,Ft,j,X,ie):xa)){lt=!1;break}It||(It=tt=="constructor")}if(lt&&!It){var Yr=g.constructor,Wr=m.constructor;Yr!=Wr&&"constructor"in g&&"constructor"in m&&!(typeof Yr=="function"&&Yr instanceof Yr&&typeof Wr=="function"&&Wr instanceof Wr)&&(lt=!1)}return ie.delete(g),ie.delete(m),lt}function Ea(g){return ug(g,xg,pg)}function Vr(g,m){var j=g.__data__;return vg(m)?j[typeof m=="string"?"string":"hash"]:j.map}function Wt(g,m){var j=de(g,m);return hg(j)?j:void 0}function yg(g){var m=ne.call(g,at),j=g[at];try{g[at]=void 0;var X=!0}catch{}var Ie=ve.call(g);return X&&(m?g[at]=j:delete g[at]),Ie}var pg=Mt?function(g){return g==null?[]:(g=Object(g),pe(Mt(g),function(m){return bt.call(g,m)}))}:Tg,Tt=br;(Me&&Tt(new Me(new ArrayBuffer(1)))!=G||Pe&&Tt(new Pe)!=C||je&&Tt(je.resolve())!=R||$e&&Tt(new $e)!=d||Fe&&Tt(new Fe)!=P)&&(Tt=function(g){var m=br(g),j=m==S?g.constructor:void 0,X=j?$t(j):"";if(X)switch(X){case Ke:return G;case Ge:return C;case Ve:return R;case qe:return d;case Ye:return P}return m});function bg(g,m){return m=m??c,!!m&&(typeof g=="number"||Z.test(g))&&g>-1&&g%1==0&&g<m}function vg(g){var m=typeof g;return m=="string"||m=="number"||m=="symbol"||m=="boolean"?g!=="__proto__":g===null}function Eg(g){return!!be&&be in g}function wg(g){var m=g&&g.constructor,j=typeof m=="function"&&m.prototype||te;return g===j}function mg(g){return ve.call(g)}function $t(g){if(g!=null){try{return ge.call(g)}catch{}try{return g+""}catch{}}return""}function wa(g,m){return g===m||g!==g&&m!==m}var Dg=pa(function(){return arguments}())?pa:function(g){return vr(g)&&ne.call(g,"callee")&&!bt.call(g,"callee")},qr=Array.isArray;function Sg(g){return g!=null&&Da(g.length)&&!ma(g)}var ii=pr||Ig;function Og(g,m){return ba(g,m)}function ma(g){if(!Sa(g))return!1;var m=br(g);return m==E||m==A||m==f||m==b}function Da(g){return typeof g=="number"&&g>-1&&g%1==0&&g<=c}function Sa(g){var m=typeof g;return g!=null&&(m=="object"||m=="function")}function vr(g){return g!=null&&typeof g=="object"}var Oa=fe?Ce(fe):lg;function xg(g){return Sg(g)?cg(g):dg(g)}function Tg(){return[]}function Ig(){return!1}t.exports=Og})(ni,ni.exports);var N0=ni.exports,U0=Object.defineProperty,oa=Object.getOwnPropertySymbols,M0=Object.prototype.hasOwnProperty,j0=Object.prototype.propertyIsEnumerable,aa=(t,e,r)=>e in t?U0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ca=(t,e)=>{for(var r in e||(e={}))M0.call(e,r)&&aa(t,r,e[r]);if(oa)for(var r of oa(e))j0.call(e,r)&&aa(t,r,e[r]);return t};class ua extends Mu{constructor(e,r,n,i=vt,s=void 0){super(e,r,n,i),this.core=e,this.logger=r,this.name=n,this.map=new Map,this.version=Oo,this.cached=[],this.initialized=!1,this.storagePrefix=vt,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(c=>{this.getKey&&c!==null&&!jr(c)?this.map.set(this.getKey(c),c):Td(c)?this.map.set(c.id,c):Id(c)&&this.map.set(c.topic,c)}),this.cached=[],this.initialized=!0)},this.set=async(c,u)=>{this.isInitialized(),this.map.has(c)?await this.update(c,u):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:c,value:u}),this.map.set(c,u),await this.persist())},this.get=c=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:c}),this.getData(c)),this.getAll=c=>(this.isInitialized(),c?this.values.filter(u=>Object.keys(c).every(h=>N0(u[h],c[h]))):this.values),this.update=async(c,u)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:c,update:u});const h=ca(ca({},this.getData(c)),u);this.map.set(c,h),await this.persist()},this.delete=async(c,u)=>{this.isInitialized(),this.map.has(c)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:c,reason:u}),this.map.delete(c),await this.persist())},this.logger=Se.generateChildLogger(r,this.name),this.storagePrefix=i,this.getKey=s}get context(){return Se.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){const r=this.map.get(e);if(!r){const{message:n}=Te("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(n),new Error(n)}return r}async persist(){await this.setDataStore(this.values)}async restore(){try{const e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){const{message:r}=Te("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(r),new Error(r)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}}class fa{constructor(e,r){this.core=e,this.logger=r,this.name=Ro,this.version=Ao,this.events=new ut.exports,this.initialized=!1,this.storagePrefix=vt,this.ignoredPayloadTypes=[Vt],this.registeredMethods=[],this.init=async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))},this.register=({methods:n})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...n])]},this.create=async()=>{this.isInitialized();const n=Fn(),i=await this.core.crypto.setSymKey(n),s=Hn(ye.FIVE_MINUTES),c={protocol:bo},u={topic:i,expiry:s,relay:c,active:!1},h=md({protocol:this.core.protocol,version:this.core.version,topic:i,symKey:n,relay:c});return await this.pairings.set(i,u),await this.core.relayer.subscribe(i),this.core.expirer.set(i,s),{topic:i,uri:h}},this.pair=async n=>{this.isInitialized(),this.isValidPair(n);const{topic:i,symKey:s,relay:c}=vd(n.uri);if(this.pairings.keys.includes(i))throw new Error(`Pairing already exists: ${i}`);if(this.core.crypto.hasKeys(i))throw new Error(`Keychain already exists: ${i}`);const u=Hn(ye.FIVE_MINUTES),h={topic:i,relay:c,expiry:u,active:!1};return await this.pairings.set(i,h),await this.core.crypto.setSymKey(s,i),await this.core.relayer.subscribe(i,{relay:c}),this.core.expirer.set(i,u),n.activatePairing&&await this.activate({topic:i}),h},this.activate=async({topic:n})=>{this.isInitialized();const i=Hn(ye.THIRTY_DAYS);await this.pairings.update(n,{active:!0,expiry:i}),this.core.expirer.set(n,i)},this.ping=async n=>{this.isInitialized(),await this.isValidPing(n);const{topic:i}=n;if(this.pairings.keys.includes(i)){const s=await this.sendRequest(i,"wc_pairingPing",{}),{done:c,resolve:u,reject:h}=ud();this.events.once(Kn("pairing_ping",s),({error:f})=>{f?h(f):u()}),await c()}},this.updateExpiry=async({topic:n,expiry:i})=>{this.isInitialized(),await this.pairings.update(n,{expiry:i})},this.updateMetadata=async({topic:n,metadata:i})=>{this.isInitialized(),await this.pairings.update(n,{peerMetadata:i})},this.getPairings=()=>(this.isInitialized(),this.pairings.values),this.disconnect=async n=>{this.isInitialized(),await this.isValidDisconnect(n);const{topic:i}=n;this.pairings.keys.includes(i)&&(await this.sendRequest(i,"wc_pairingDelete",dr("USER_DISCONNECTED")),await this.deletePairing(i))},this.sendRequest=async(n,i,s)=>{const c=ei(i,s),u=await this.core.crypto.encode(n,c),h=Yt[i].req;return this.core.history.set(n,c),this.core.relayer.publish(n,u,h),c.id},this.sendResult=async(n,i,s)=>{const c=Yo(n,s),u=await this.core.crypto.encode(i,c),h=await this.core.history.get(i,n),f=Yt[h.request.method].res;await this.core.relayer.publish(i,u,f),await this.core.history.resolve(c)},this.sendError=async(n,i,s)=>{const c=Wo(n,s),u=await this.core.crypto.encode(i,c),h=await this.core.history.get(i,n),f=Yt[h.request.method]?Yt[h.request.method].res:Yt.unregistered_method.res;await this.core.relayer.publish(i,u,f),await this.core.history.resolve(c)},this.deletePairing=async(n,i)=>{await this.core.relayer.unsubscribe(n),await Promise.all([this.pairings.delete(n,dr("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(n),i?Promise.resolve():this.core.expirer.del(n)])},this.cleanup=async()=>{const n=this.pairings.getAll().filter(i=>ro(i.expiry));await Promise.all(n.map(i=>this.deletePairing(i.topic)))},this.onRelayEventRequest=n=>{const{topic:i,payload:s}=n,c=s.method;if(this.pairings.keys.includes(i))switch(c){case"wc_pairingPing":return this.onPairingPingRequest(i,s);case"wc_pairingDelete":return this.onPairingDeleteRequest(i,s);default:return this.onUnknownRpcMethodRequest(i,s)}},this.onRelayEventResponse=async n=>{const{topic:i,payload:s}=n,c=(await this.core.history.get(i,s.id)).request.method;if(this.pairings.keys.includes(i))switch(c){case"wc_pairingPing":return this.onPairingPingResponse(i,s);default:return this.onUnknownRpcMethodResponse(c)}},this.onPairingPingRequest=async(n,i)=>{const{id:s}=i;try{this.isValidPing({topic:n}),await this.sendResult(s,n,!0),this.events.emit("pairing_ping",{id:s,topic:n})}catch(c){await this.sendError(s,n,c),this.logger.error(c)}},this.onPairingPingResponse=(n,i)=>{const{id:s}=i;setTimeout(()=>{Zo(i)?this.events.emit(Kn("pairing_ping",s),{}):Br(i)&&this.events.emit(Kn("pairing_ping",s),{error:i.error})},500)},this.onPairingDeleteRequest=async(n,i)=>{const{id:s}=i;try{this.isValidDisconnect({topic:n}),await this.deletePairing(n),this.events.emit("pairing_delete",{id:s,topic:n})}catch(c){await this.sendError(s,n,c),this.logger.error(c)}},this.onUnknownRpcMethodRequest=async(n,i)=>{const{id:s,method:c}=i;try{if(this.registeredMethods.includes(c))return;const u=dr("WC_METHOD_UNSUPPORTED",c);await this.sendError(s,n,u),this.logger.error(u)}catch(u){await this.sendError(s,n,u),this.logger.error(u)}},this.onUnknownRpcMethodResponse=n=>{this.registeredMethods.includes(n)||this.logger.error(dr("WC_METHOD_UNSUPPORTED",n))},this.isValidPair=n=>{if(!Vn(n)){const{message:i}=Te("MISSING_OR_INVALID",`pair() params: ${n}`);throw new Error(i)}if(!xd(n.uri)){const{message:i}=Te("MISSING_OR_INVALID",`pair() uri: ${n.uri}`);throw new Error(i)}},this.isValidPing=async n=>{if(!Vn(n)){const{message:s}=Te("MISSING_OR_INVALID",`ping() params: ${n}`);throw new Error(s)}const{topic:i}=n;await this.isValidPairingTopic(i)},this.isValidDisconnect=async n=>{if(!Vn(n)){const{message:s}=Te("MISSING_OR_INVALID",`disconnect() params: ${n}`);throw new Error(s)}const{topic:i}=n;await this.isValidPairingTopic(i)},this.isValidPairingTopic=async n=>{if(!so(n,!1)){const{message:i}=Te("MISSING_OR_INVALID",`pairing topic should be a string: ${n}`);throw new Error(i)}if(!this.pairings.keys.includes(n)){const{message:i}=Te("NO_MATCHING_KEY",`pairing topic doesn't exist: ${n}`);throw new Error(i)}if(ro(this.pairings.get(n).expiry)){await this.deletePairing(n);const{message:i}=Te("EXPIRED",`pairing topic: ${n}`);throw new Error(i)}},this.core=e,this.logger=Se.generateChildLogger(r,this.name),this.pairings=new ua(this.core,this.logger,this.name,this.storagePrefix)}get context(){return Se.getLoggerContext(this.logger)}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(ze.message,async e=>{const{topic:r,message:n}=e;if(this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(n)))return;const i=await this.core.crypto.decode(r,n);Jo(i)?(this.core.history.set(r,i),this.onRelayEventRequest({topic:r,payload:i})):ti(i)&&(await this.core.history.resolve(i),this.onRelayEventResponse({topic:r,payload:i}))})}registerExpirerEvents(){this.core.expirer.on(ft.expired,async e=>{const{topic:r}=ld(e.target);r&&this.pairings.keys.includes(r)&&(await this.deletePairing(r,!0),this.events.emit("pairing_expire",{topic:r}))})}}class ha extends Pu{constructor(e,r){super(e,r),this.core=e,this.logger=r,this.records=new Map,this.events=new ut.exports.EventEmitter,this.name=Co,this.version=Po,this.cached=[],this.initialized=!1,this.storagePrefix=vt,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(n=>this.records.set(n.id,n)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.set=(n,i,s)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:n,request:i,chainId:s}),this.records.has(i.id))return;const c={id:i.id,topic:n,request:{method:i.method,params:i.params||null},chainId:s};this.records.set(c.id,c),this.events.emit(gt.created,c)},this.resolve=async n=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:n}),!this.records.has(n.id))return;const i=await this.getRecord(n.id);typeof i.response>"u"&&(i.response=Br(n)?{error:n.error}:{result:n.result},this.records.set(i.id,i),this.events.emit(gt.updated,i))},this.get=async(n,i)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:n,id:i}),await this.getRecord(i)),this.delete=(n,i)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:i}),this.values.forEach(s=>{if(s.topic===n){if(typeof i<"u"&&s.id!==i)return;this.records.delete(s.id),this.events.emit(gt.deleted,s)}})},this.exists=async(n,i)=>(this.isInitialized(),this.records.has(i)?(await this.getRecord(i)).topic===n:!1),this.on=(n,i)=>{this.events.on(n,i)},this.once=(n,i)=>{this.events.once(n,i)},this.off=(n,i)=>{this.events.off(n,i)},this.removeListener=(n,i)=>{this.events.removeListener(n,i)},this.logger=Se.generateChildLogger(r,this.name)}get context(){return Se.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){const e=[];return this.values.forEach(r=>{if(typeof r.response<"u")return;const n={topic:r.topic,request:ei(r.request.method,r.request.params,r.id),chainId:r.chainId};return e.push(n)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();const r=this.records.get(e);if(!r){const{message:n}=Te("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(n)}return r}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(gt.sync)}async restore(){try{const e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){const{message:r}=Te("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(r),new Error(r)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(gt.created,e=>{const r=gt.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,record:e}),this.persist()}),this.events.on(gt.updated,e=>{const r=gt.updated;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,record:e}),this.persist()}),this.events.on(gt.deleted,e=>{const r=gt.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,record:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}}class la extends $u{constructor(e,r){super(e,r),this.core=e,this.logger=r,this.expirations=new Map,this.events=new ut.exports.EventEmitter,this.name=Lo,this.version=No,this.cached=[],this.initialized=!1,this.storagePrefix=vt,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(n=>this.expirations.set(n.target,n)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.has=n=>{try{const i=this.formatTarget(n);return typeof this.getExpiration(i)<"u"}catch{return!1}},this.set=(n,i)=>{this.isInitialized();const s=this.formatTarget(n),c={target:s,expiry:i};this.expirations.set(s,c),this.checkExpiry(s,c),this.events.emit(ft.created,{target:s,expiration:c})},this.get=n=>{this.isInitialized();const i=this.formatTarget(n);return this.getExpiration(i)},this.del=n=>{if(this.isInitialized(),this.has(n)){const i=this.formatTarget(n),s=this.getExpiration(i);this.expirations.delete(i),this.events.emit(ft.deleted,{target:i,expiration:s})}},this.on=(n,i)=>{this.events.on(n,i)},this.once=(n,i)=>{this.events.once(n,i)},this.off=(n,i)=>{this.events.off(n,i)},this.removeListener=(n,i)=>{this.events.removeListener(n,i)},this.logger=Se.generateChildLogger(r,this.name)}get context(){return Se.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return fd(e);if(typeof e=="number")return hd(e);const{message:r}=Te("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(r)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(ft.sync)}async restore(){try{const e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){const{message:r}=Te("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(r),new Error(r)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){const r=this.expirations.get(e);if(!r){const{message:n}=Te("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(n),new Error(n)}return r}checkExpiry(e,r){const{expiry:n}=r;ye.toMiliseconds(n)-Date.now()<=0&&this.expire(e,r)}expire(e,r){this.expirations.delete(e),this.events.emit(ft.expired,{target:e,expiration:r})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,r)=>this.checkExpiry(r,e))}registerEventListeners(){this.core.heartbeat.on(er.HEARTBEAT_EVENTS.pulse,()=>this.checkExpirations()),this.events.on(ft.created,e=>{const r=ft.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:e}),this.persist()}),this.events.on(ft.expired,e=>{const r=ft.expired;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:e}),this.persist()}),this.events.on(ft.deleted,e=>{const r=ft.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=Te("NOT_INITIALIZED",this.name);throw new Error(e)}}}class da extends Fu{constructor(e,r){super(e,r),this.projectId=e,this.logger=r,this.name=Fr,this.initialized=!1,this.init=async n=>{Js()||!Zs()||(this.verifyUrl=n?.verifyUrl||Xn,await this.createIframe())},this.register=async n=>{var i;this.initialized||await this.init(),this.iframe&&((i=this.iframe.contentWindow)==null||i.postMessage(n.attestationId,this.verifyUrl),this.logger.info(`postMessage sent: ${n.attestationId} ${this.verifyUrl}`))},this.resolve=async n=>{var i;if(this.isDevEnv)return"";this.logger.info(`resolving attestation: ${n.attestationId}`);const s=this.startAbortTimer(ye.FIVE_SECONDS),c=await fetch(`${this.verifyUrl}/attestation/${n.attestationId}`,{signal:this.abortController.signal});return clearTimeout(s),c.status===200?(i=await c.json())==null?void 0:i.origin:""},this.createIframe=async()=>{try{await Promise.race([new Promise((n,i)=>{if(document.getElementById(Fr))return n();const s=document.createElement("iframe");s.setAttribute("id",Fr),s.setAttribute("src",`${this.verifyUrl}/${this.projectId}`),s.style.display="none",s.addEventListener("load",()=>{this.initialized=!0,n()}),s.addEventListener("error",c=>{i(c)}),document.body.append(s),this.iframe=s}),new Promise(n=>{setTimeout(()=>n("iframe load timeout"),ye.toMiliseconds(ye.ONE_SECOND/2))})])}catch(n){this.logger.error(`Verify iframe failed to load: ${this.verifyUrl}`),this.logger.error(n)}},this.logger=Se.generateChildLogger(r,this.name),this.verifyUrl=Xn,this.abortController=new AbortController,this.isDevEnv=zn()&&process.env.IS_VITEST}get context(){return Se.getLoggerContext(this.logger)}startAbortTimer(e){return setTimeout(()=>this.abortController.abort(),ye.toMiliseconds(e))}}var $0=Object.defineProperty,ga=Object.getOwnPropertySymbols,F0=Object.prototype.hasOwnProperty,B0=Object.prototype.propertyIsEnumerable,_a=(t,e,r)=>e in t?$0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ya=(t,e)=>{for(var r in e||(e={}))F0.call(e,r)&&_a(t,r,e[r]);if(ga)for(var r of ga(e))B0.call(e,r)&&_a(t,r,e[r]);return t};class zr extends Cu{constructor(e){super(e),this.protocol=qn,this.version=oo,this.name=$r,this.events=new ut.exports.EventEmitter,this.initialized=!1,this.on=(n,i)=>this.events.on(n,i),this.once=(n,i)=>this.events.once(n,i),this.off=(n,i)=>this.events.off(n,i),this.removeListener=(n,i)=>this.events.removeListener(n,i),this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||Wn;const r=typeof e?.logger<"u"&&typeof e?.logger!="string"?e.logger:Se.pino(Se.getDefaultLoggerOptions({level:e?.logger||ao.logger}));this.logger=Se.generateChildLogger(r,this.name),this.heartbeat=new er.HeartBeat,this.crypto=new Mo(this,this.logger,e?.keychain),this.history=new ha(this,this.logger),this.expirer=new la(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new ac(ya(ya({},co),e?.storageOptions)),this.relayer=new sa({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new fa(this,this.logger),this.verify=new da(this.projectId||"",this.logger)}static async init(e){const r=new zr(e);return await r.initialize(),r}get context(){return Se.getLoggerContext(this.logger)}async start(){this.initialized||await this.initialize()}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}}const z0=zr;J.CORE_CONTEXT=$r,J.CORE_DEFAULT=ao,J.CORE_PROTOCOL=qn,J.CORE_STORAGE_OPTIONS=co,J.CORE_STORAGE_PREFIX=vt,J.CORE_VERSION=oo,J.CRYPTO_CLIENT_SEED=Yn,J.CRYPTO_CONTEXT=uo,J.CRYPTO_JWT_TTL=fo,J.Core=z0,J.Crypto=Mo,J.EXPIRER_CONTEXT=Lo,J.EXPIRER_DEFAULT_TTL=Pd,J.EXPIRER_EVENTS=ft,J.EXPIRER_STORAGE_VERSION=No,J.Expirer=la,J.HISTORY_CONTEXT=Co,J.HISTORY_EVENTS=gt,J.HISTORY_STORAGE_VERSION=Po,J.JsonRpcHistory=ha,J.KEYCHAIN_CONTEXT=ho,J.KEYCHAIN_STORAGE_VERSION=lo,J.KeyChain=Uo,J.MESSAGES_CONTEXT=go,J.MESSAGES_STORAGE_VERSION=_o,J.MessageTracker=jo,J.PAIRING_CONTEXT=Ro,J.PAIRING_DEFAULT_TTL=Cd,J.PAIRING_RPC_OPTS=Yt,J.PAIRING_STORAGE_VERSION=Ao,J.PENDING_SUB_RESOLUTION_TIMEOUT=Io,J.PUBLISHER_CONTEXT=po,J.PUBLISHER_DEFAULT_TTL=yo,J.Pairing=fa,J.RELAYER_CONTEXT=Eo,J.RELAYER_DEFAULT_LOGGER=vo,J.RELAYER_DEFAULT_PROTOCOL=bo,J.RELAYER_DEFAULT_RELAY_URL=Wn,J.RELAYER_EVENTS=ze,J.RELAYER_PROVIDER_EVENTS=qt,J.RELAYER_RECONNECT_TIMEOUT=mo,J.RELAYER_SDK_VERSION=Do,J.RELAYER_STORAGE_OPTIONS=Rd,J.RELAYER_SUBSCRIBER_SUFFIX=wo,J.RELAYER_TRANSPORT_CUTOFF=So,J.Relayer=sa,J.STORE_STORAGE_VERSION=Oo,J.SUBSCRIBER_CONTEXT=xo,J.SUBSCRIBER_DEFAULT_TTL=Ad,J.SUBSCRIBER_EVENTS=dt,J.SUBSCRIBER_STORAGE_VERSION=To,J.Store=ua,J.Subscriber=ra,J.VERIFY_CONTEXT=Fr,J.VERIFY_SERVER=Xn,J.Verify=da,J.default=zr,Object.defineProperty(J,"__esModule",{value:!0})});
 //# sourceMappingURL=index.umd.js.map
